<!DOCTYPE html>
<html lang="ru" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Путь к Рамадану - Ваш духовный спутник</title>
    <meta name="description" content="Подготовка к Рамадану 2026 - Коран, намаз, азкары, трекер привычек">
    <meta name="theme-color" content="#0B5B3F"/>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lateef&display=swap" rel="stylesheet">
    
    <style>
        /* === CSS Variables === */
        :root {
            --primary-dark: #0B5B3F;
            --primary-main: #1C7A5C;
            --primary-light: #2A9D75;
            --accent-gold: #D9B44A;
            --accent-cream: #F6E8C3;
            --bg-light: #FAFAF8;
            --bg-card-light: #FFFFFF;
            --text-primary-light: #1A1A1A;
            --text-secondary-light: #666666;
            --border-light: #E8E8E8;
            --bg-dark: #0E1116;
            --bg-card-dark: #1A1D24;
            --text-primary-dark: #F0F0F0;
            --text-secondary-dark: #A0A0A0;
            --border-dark: #2D3748;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --radius-lg: 20px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --shadow-sm: 0 2px 8px rgba(11, 91, 63, 0.08);
            --shadow-md: 0 4px 20px rgba(11, 91, 63, 0.12);
            --shadow-lg: 0 8px 32px rgba(11, 91, 63, 0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Quran font sizes */
            --arabic-font-size: 2rem;
            --translation-font-size: 1rem;

            /* Glass effect variables */
            --c-glass: #bbbbbc;
            --c-light: #fff;
            --c-dark: #000;
            --c-content: #224;
            --c-action: #0052f5;
            --c-bg: #E8E8E9;
            --glass-reflex-dark: 1;
            --glass-reflex-light: 1;
            --saturation: 150%;
        }

        body.dark-theme {
            --c-glass: #bbbbbc;
            --c-light: #fff;
            --c-dark: #000;
            --c-content: #e1e1e1;
            --c-action: #03d5ff;
            --c-bg: #1b1b1d;
            --glass-reflex-dark: 2;
            --glass-reflex-light: 0.3;
            --saturation: 150%;
        }

        /* === Base Styles === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-primary-light);
            line-height: 1.6;
            min-height: 100vh;
            transition: var(--transition);
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
            position: relative;
            touch-action: pan-y;
        }

        body.dark-theme {
            background-color: var(--bg-dark);
            color: var(--text-primary-dark);
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            background: var(--bg-light);
        }

        body.dark-theme .app-container {
            background: var(--bg-dark);
        }

        /* === Glass Effect Components === */
        .glass-container {
            position: relative;
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .glass-filter {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: inherit;
            z-index: 1;
        }

        .glass-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                135deg,
                color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent) 0%,
                color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 5%), transparent) 100%
            );
            z-index: 2;
            pointer-events: none;
        }

        .glass-specular {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                135deg,
                transparent 0%,
                color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 15%), transparent) 50%,
                transparent 100%
            );
            z-index: 3;
            pointer-events: none;
        }

        .glass-content {
            position: relative;
            z-index: 4;
        }

        /* === Tab Content === */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: 80px;
            display: none;
            -webkit-overflow-scrolling: touch;
            height: calc(100vh - 80px);
            position: relative;
            overscroll-behavior: contain;
            scroll-behavior: smooth;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content::-webkit-scrollbar {
            display: none;
        }

        .tab-content {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* === Header === */
        .header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-main));
            color: white;
            padding: 1.5rem 1.25rem;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(217, 180, 74, 0.1) 0%, transparent 70%);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-gold), #F6E8C3);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .logo-text {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            touch-action: manipulation;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .countdown-section {
            text-align: center;
        }

        .countdown-title {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .countdown-timer {
            font-size: 2.8rem;
            font-weight: 700;
            letter-spacing: 2px;
            font-feature-settings: "tnum";
            margin-bottom: 0.25rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .countdown-subtitle {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        /* === Progress Section === */
        .progress-section {
            padding: 1.5rem 1.25rem;
            margin: 0.75rem;
            border-radius: var(--radius-lg);
            position: relative;
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-label {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        body.dark-theme .progress-label {
            color: var(--accent-gold);
        }

        .progress-percent {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        body.dark-theme .progress-percent {
            color: var(--accent-gold);
        }

        .progress-bar {
            height: 12px;
            background-color: var(--bg-light);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        body.dark-theme .progress-bar {
            background-color: var(--border-dark);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-main), var(--accent-gold));
            border-radius: 10px;
            width: 0%;
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* === Today's Task === */
        .task-card {
            margin: 0.75rem;
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .task-header {
            padding: 1.25rem 1.25rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-badge {
            background: linear-gradient(135deg, var(--accent-gold), #e6a429);
            color: white;
            font-size: 0.75rem;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .task-date {
            font-size: 0.8rem;
            color: var(--text-secondary-light);
            font-weight: 500;
        }

        body.dark-theme .task-date {
            color: var(--text-secondary-dark);
        }

        .task-content {
            padding: 1.25rem;
        }

        .task-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--text-primary-light);
            line-height: 1.4;
        }

        body.dark-theme .task-title {
            color: var(--text-primary-dark);
        }

        .task-description {
            color: var(--text-secondary-light);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        body.dark-theme .task-description {
            color: var(--text-secondary-dark);
        }

        .task-proof {
            background: linear-gradient(135deg, rgba(11, 91, 63, 0.05), rgba(217, 180, 74, 0.05));
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-main);
            font-style: italic;
            line-height: 1.6;
        }

        body.dark-theme .task-proof {
            background: linear-gradient(135deg, rgba(11, 91, 63, 0.15), rgba(217, 180, 74, 0.1));
        }

        .task-source {
            display: block;
            text-align: right;
            font-size: 0.8rem;
            margin-top: 0.75rem;
            opacity: 0.7;
            font-style: normal;
            font-weight: 500;
        }

        .task-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
        }

        body.dark-theme .task-actions {
            border-top-color: var(--border-dark);
        }

        .task-checkbox {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            touch-action: manipulation;
        }

        .checkbox {
            width: 28px;
            height: 28px;
            border: 2px solid var(--primary-main);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
        }

        .checkbox.checked {
            background: var(--primary-main);
            border-color: var(--primary-main);
        }

        .checkbox.checked::after {
            content: '✓';
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .checkbox-label {
            font-weight: 600;
            color: var(--text-primary-light);
        }

        body.dark-theme .checkbox-label {
            color: var(--text-primary-dark);
        }

        .task-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--text-secondary-light);
        }

        body.dark-theme .task-meta {
            color: var(--text-secondary-dark);
        }

        .task-time, .task-difficulty {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* === Quick Actions === */
        .quick-actions {
            padding: 1rem 0.75rem;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        .action-button {
            border: none;
            border-radius: var(--radius-lg);
            padding: 1.25rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            touch-action: manipulation;
            position: relative;
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .action-button:hover {
            transform: translateY(-2px);
        }

        .action-button.active {
            background: linear-gradient(135deg, var(--primary-main), var(--primary-dark));
            color: white;
        }

        .action-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-main), var(--primary-dark));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .action-button.active .action-icon {
            background: rgba(255, 255, 255, 0.2);
        }

        .action-text {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary-light);
        }

        body.dark-theme .action-text {
            color: var(--text-primary-dark);
        }

        .action-button.active .action-text {
            color: white;
        }

        /* === Daily Verse === */
        .verse-card {
            background: linear-gradient(135deg, var(--accent-cream), #f0e6d1);
            margin: 0.75rem;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            position: relative;
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        body.dark-theme .verse-card {
            background: linear-gradient(135deg, #2d2a1a, #3a3520);
        }

        .verse-card::before {
            content: """;
            position: absolute;
            top: -10px;
            right: 15px;
            font-size: 120px;
            color: rgba(11, 91, 63, 0.1);
            font-family: serif;
            line-height: 1;
        }

        body.dark-theme .verse-card::before {
            color: rgba(217, 180, 74, 0.1);
        }

        .verse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .verse-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark-theme .verse-title {
            color: var(--accent-gold);
        }

        .verse-bookmark {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.7;
            transition: var(--transition);
            touch-action: manipulation;
        }

        .verse-bookmark:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .verse-arabic {
            font-family: 'Lateef', serif;
            font-size: var(--arabic-font-size);
            text-align: right;
            line-height: 2;
            margin-bottom: 1.25rem;
            direction: rtl;
            font-weight: 500;
            letter-spacing: 1px;
            word-spacing: 3px;
        }

        .verse-translation {
            font-style: italic;
            margin-bottom: 1rem;
            line-height: 1.6;
            color: var(--text-primary-light);
            font-size: var(--translation-font-size);
        }

        body.dark-theme .verse-translation {
            color: var(--text-primary-dark);
        }

        .verse-source {
            text-align: right;
            font-size: 0.8rem;
            opacity: 0.7;
            font-weight: 500;
        }

        /* === Preparation Tab === */
        .week-section {
            margin: 0.75rem;
        }

        .week-card {
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-main);
            position: relative;
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .week-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        body.dark-theme .week-title {
            color: var(--accent-gold);
        }

        .week-progress {
            font-size: 0.8rem;
            color: var(--text-secondary-light);
            font-weight: 500;
        }

        body.dark-theme .week-progress {
            color: var(--text-secondary-dark);
        }

        .week-theme {
            color: var(--text-secondary-light);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        body.dark-theme .week-theme {
            color: var(--text-secondary-dark);
        }

        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            transition: var(--transition);
            cursor: pointer;
            touch-action: manipulation;
        }

        body.dark-theme .task-item {
            background: var(--border-dark);
        }

        .task-item.completed {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(11, 91, 63, 0.05));
        }

        .task-item-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-main);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .task-item.completed .task-item-checkbox {
            background: var(--success);
            border-color: var(--success);
        }

        .task-item.completed .task-item-checkbox::after {
            content: '✓';
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .task-item-text {
            flex: 1;
            font-size: 0.9rem;
        }

        .task-item.completed .task-item-text {
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* === Quran Tab === */
        .quran-section {
            padding: 1rem 0.75rem;
        }

        .surah-card {
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: var(--transition);
            cursor: pointer;
            touch-action: manipulation;
            position: relative;
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .surah-card:hover {
            transform: translateY(-2px);
        }

        .surah-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-main), var(--primary-dark));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .surah-info {
            flex: 1;
        }

        .surah-name {
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--text-primary-light);
        }

        body.dark-theme .surah-name {
            color: var(--text-primary-dark);
        }

        .surah-details {
            font-size: 0.8rem;
            color: var(--text-secondary-light);
        }

        body.dark-theme .surah-details {
            color: var(--text-secondary-dark);
        }

        .surah-actions {
            display: flex;
            gap: 0.5rem;
        }

        .surah-action-btn {
            background: var(--bg-light);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            touch-action: manipulation;
        }

        body.dark-theme .surah-action-btn {
            background: var(--border-dark);
        }

        /* === Prayer Tab === */
        .prayer-section {
            padding: 1rem 0.75rem;
        }

        .prayer-times {
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .prayer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .prayer-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        body.dark-theme .prayer-title {
            color: var(--accent-gold);
        }

        .prayer-location {
            font-size: 0.8rem;
            color: var(--text-secondary-light);
        }

        body.dark-theme .prayer-location {
            color: var(--text-secondary-dark);
        }

        .prayer-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .prayer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            transition: var(--transition);
        }

        body.dark-theme .prayer-item {
            background: var(--border-dark);
        }

        .prayer-item.active {
            background: linear-gradient(135deg, rgba(11, 91, 63, 0.1), rgba(217, 180, 74, 0.05));
            border-left: 4px solid var(--primary-main);
        }

        .prayer-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .prayer-time {
            font-weight: 700;
            color: var(--primary-dark);
        }

        body.dark-theme .prayer-time {
            color: var(--accent-gold);
        }

        .prayer-completed {
            color: var(--success);
            font-weight: 700;
        }

        /* === Community Tab === */
        .community-section {
            padding: 1rem 0.75rem;
        }

        .community-card {
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .community-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary-dark);
        }

        body.dark-theme .community-title {
            color: var(--accent-gold);
        }

        .community-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .community-stat {
            text-align: center;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: var(--radius-md);
        }

        body.dark-theme .community-stat {
            background: var(--border-dark);
        }

        .community-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.25rem;
        }

        body.dark-theme .community-stat-value {
            color: var(--accent-gold);
        }

        .community-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary-light);
        }

        body.dark-theme .community-stat-label {
            color: var(--text-secondary-dark);
        }

        .community-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .community-button {
            background: var(--primary-main);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            touch-action: manipulation;
        }

        .community-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* === Dua Tab === */
        .dua-section {
            padding: 1rem 0.75rem;
        }

        .dua-category {
            margin-bottom: 1.5rem;
        }

        .category-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary-dark);
            padding-left: 0.5rem;
            border-left: 4px solid var(--accent-gold);
        }

        body.dark-theme .category-title {
            color: var(--accent-gold);
        }

        .dua-card {
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            transition: var(--transition);
            position: relative;
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .dua-card:hover {
            transform: translateY(-2px);
        }

        .dua-arabic {
            font-family: 'Lateef', serif;
            font-size: var(--arabic-font-size);
            text-align: right;
            line-height: 1.8;
            margin-bottom: 1rem;
            direction: rtl;
            letter-spacing: 1px;
            word-spacing: 3px;
        }

        .dua-translation {
            font-style: italic;
            margin-bottom: 0.75rem;
            color: var(--text-secondary-light);
            line-height: 1.6;
            font-size: var(--translation-font-size);
        }

        body.dark-theme .dua-translation {
            color: var(--text-secondary-dark);
        }

        .dua-source {
            font-size: 0.8rem;
            opacity: 0.7;
            text-align: right;
        }

        /* === Profile Tab === */
        .profile-section {
            padding: 1rem 0.75rem;
        }

        .profile-card {
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
            position: relative;
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-main), var(--accent-gold));
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .profile-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .profile-level {
            color: var(--text-secondary-light);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        body.dark-theme .profile-level {
            color: var(--text-secondary-dark);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.25rem;
        }

        body.dark-theme .stat-value {
            color: var(--accent-gold);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary-light);
        }

        body.dark-theme .stat-label {
            color: var(--text-secondary-dark);
        }

        .settings-section {
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            position: relative;
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .settings-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary-dark);
        }

        body.dark-theme .settings-title {
            color: var(--accent-gold);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        body.dark-theme .setting-item {
            border-bottom-color: var(--border-dark);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-weight: 500;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-main);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* === Bottom Navigation === */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            padding: 0.75rem 0;
            backdrop-filter: blur(10px);
            z-index: 1000;
            max-width: 480px;
            margin: 0 auto;
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            opacity: 0.6;
            transition: var(--transition);
            flex: 1;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-item.active {
            opacity: 1;
            background: linear-gradient(135deg, rgba(11, 91, 63, 0.1), rgba(217, 180, 74, 0.05));
        }

        body.dark-theme .nav-item.active {
            background: linear-gradient(135deg, rgba(11, 91, 63, 0.2), rgba(217, 180, 74, 0.1));
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: var(--transition);
        }

        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }

        .nav-text {
            font-size: 0.7rem;
            font-weight: 600;
            transition: var(--transition);
        }

        .nav-item.active .nav-text {
            color: var(--primary-main);
        }

        body.dark-theme .nav-item.active .nav-text {
            color: var(--accent-gold);
        }

        /* === Responsive Design === */
        @media (max-width: 380px) {
            .app-container {
                padding: 0;
            }
            
            .countdown-timer {
                font-size: 2.2rem;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .action-button {
                padding: 1rem 0.25rem;
            }
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 800px;
                border-left: 1px solid var(--border-light);
                border-right: 1px solid var(--border-light);
            }
            
            body.dark-theme .app-container {
                border-left-color: var(--border-dark);
                border-right-color: var(--border-dark);
            }
        }

        /* === Utility Classes === */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === Loading States === */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* === Modal Styles === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card-light);
            border-radius: var(--radius-lg);
            width: 95%;
            height: 95%;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        body.dark-theme .modal-content {
            background: var(--bg-card-dark);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
            background: inherit;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0;
        }

        body.dark-theme .modal-header {
            border-bottom-color: var(--border-dark);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        body.dark-theme .modal-title {
            color: var(--accent-gold);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary-light);
            touch-action: manipulation;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: rgba(0,0,0,0.1);
        }

        body.dark-theme .modal-close {
            color: var(--text-secondary-dark);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            scroll-behavior: smooth;
        }

        .surah-content {
            text-align: right;
            direction: rtl;
            font-family: 'Lateef', serif;
            line-height: 2.5;
            letter-spacing: 1px;
            word-spacing: 3px;
        }

        .ayah-container {
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 1.5rem;
            position: relative;
        }

        body.dark-theme .ayah-container {
            border-bottom-color: var(--border-dark);
        }

        .ayah-arabic {
            font-family: 'Lateef', serif;
            font-size: var(--arabic-font-size);
            line-height: 2;
            margin-bottom: 0.5rem;
            text-align: right;
            letter-spacing: 1px;
            word-spacing: 3px;
            cursor: pointer;
            transition: var(--transition);
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            -webkit-tap-highlight-color: transparent;
        }

        .ayah-arabic:active {
            background: rgba(11, 91, 63, 0.1);
        }

        body.dark-theme .ayah-arabic:active {
            background: rgba(217, 180, 74, 0.1);
        }

        .ayah-translation {
            font-style: italic;
            line-height: 1.6;
            color: var(--text-secondary-light);
            margin-bottom: 0.5rem;
            font-size: var(--translation-font-size);
            text-align: left;
            direction: ltr;
        }

        body.dark-theme .ayah-translation {
            color: var(--text-secondary-dark);
        }

        .ayah-number {
            display: inline-block;
            background: var(--primary-main);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            font-size: 0.8rem;
            line-height: 24px;
            margin-left: 0.5rem;
        }

        .surah-navigation {
            display: flex;
            justify-content: space-between;
            padding: 1.5rem;
            border-top: 1px solid var(--border-light);
            background: inherit;
            position: sticky;
            bottom: 0;
            z-index: 10;
            flex-shrink: 0;
        }

        body.dark-theme .surah-navigation {
            border-top-color: var(--border-dark);
        }

        .nav-button {
            background: var(--primary-main);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            touch-action: manipulation;
        }

        .nav-button:hover {
            background: var(--primary-dark);
        }

        .nav-button:disabled {
            background: var(--text-secondary-light);
            cursor: not-allowed;
        }

        body.dark-theme .nav-button:disabled {
            background: var(--text-secondary-dark);
        }

        /* === Toast Notifications === */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: var(--error);
        }

        .toast.warning {
            background: var(--warning);
        }

        /* === Quran Reading Theme === */
        .quran-reading-theme {
            background-color: #f8f4e9;
            color: #3a3520;
        }

        .quran-reading-theme .ayah-arabic {
            color: #2a1e08;
        }

        .quran-reading-theme .ayah-translation {
            color: #5a4c30;
        }

        .theme-toggle-quran {
            background: var(--primary-main);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-left: 1rem;
        }

        .theme-toggle-quran:hover {
            background: var(--primary-dark);
        }

        .bismillah {
            text-align: center;
            font-family: 'Lateef', serif;
            font-size: 2.5rem;
            margin-bottom: 2rem;
            padding: 1rem;
            border-bottom: 2px solid var(--accent-gold);
            color: var(--primary-dark);
        }

        body.dark-theme .bismillah {
            color: var(--accent-gold);
        }

        .bookmark-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-gold);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .last-read-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--primary-main);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .quran-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: var(--bg-light);
            border-radius: var(--radius-md);
        }

        body.dark-theme .quran-controls {
            background: var(--border-dark);
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .font-size-btn {
            background: var(--primary-main);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
        }

        .font-size-label {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .warm-light-toggle {
            background: var(--accent-gold);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .warm-light-toggle:hover {
            background: #e6a429;
        }

        .progress-reading {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: var(--radius-md);
        }

        body.dark-theme .progress-reading {
            background: var(--border-dark);
        }

        .progress-reading-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-dark);
        }

        body.dark-theme .progress-reading-title {
            color: var(--accent-gold);
        }

        .progress-reading-text {
            font-size: 0.9rem;
            color: var(--text-secondary-light);
        }

        body.dark-theme .progress-reading-text {
            color: var(--text-secondary-dark);
        }

        .reading-progress-container {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: var(--radius-md);
        }

        body.dark-theme .reading-progress-container {
            background: var(--border-dark);
        }

        .reading-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .reading-progress-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        body.dark-theme .reading-progress-title {
            color: var(--accent-gold);
        }

        .reading-progress-percent {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        body.dark-theme .reading-progress-percent {
            color: var(--accent-gold);
        }

        .reading-progress-bar {
            height: 8px;
            background-color: var(--bg-light);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        body.dark-theme .reading-progress-bar {
            background-color: var(--border-dark);
        }

        .reading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-main), var(--accent-gold));
            border-radius: 10px;
            width: 0%;
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .reading-progress-text {
            font-size: 0.8rem;
            color: var(--text-secondary-light);
            margin-top: 0.5rem;
        }

        body.dark-theme .reading-progress-text {
            color: var(--text-secondary-dark);
        }

        /* Audio Player Styles */
        .audio-player {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-light);
            border-radius: var(--radius-sm);
        }

        body.dark-theme .audio-player {
            background: var(--border-dark);
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .play-btn {
            background: var(--primary-main);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .play-btn.playing {
            background: var(--accent-gold);
        }

        .reciter-select {
            background: var(--bg-card-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        body.dark-theme .reciter-select {
            background: var(--bg-card-dark);
            border-color: var(--border-dark);
            color: var(--text-primary-dark);
        }

        .ayah-playing {
            background: linear-gradient(135deg, rgba(11, 91, 63, 0.1), rgba(217, 180, 74, 0.05));
            border-radius: var(--radius-sm);
            padding: 0.5rem;
        }

        body.dark-theme .ayah-playing {
            background: linear-gradient(135deg, rgba(11, 91, 63, 0.2), rgba(217, 180, 74, 0.1));
        }

        .ayah-controls {
            display: none;
        }

        /* === Книжный режим Корана === */
        .book-mode-toggle {
            background: var(--accent-gold);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-left: 1rem;
        }

        .book-mode-toggle:hover {
            background: #e6a429;
        }

        .book-mode {
            background-color: #f8f4e9 !important;
            font-family: 'Amiri Quran', serif !important;
            direction: rtl !important;
            text-align: justify !important;
            line-height: 2.5 !important;
            padding: 1rem !important;
            color: #2a1e08 !important;
        }

        .book-mode .ayah-arabic {
            font-family: 'Amiri Quran', serif !important;
            font-size: 1.8rem !important;
            line-height: 2.5 !important;
            text-align: justify !important;
            margin-bottom: 0.5rem !important;
            color: #2a1e08 !important;
        }

        .book-mode .ayah-number {
            background: transparent !important;
            color: #8B4513 !important;
            font-size: 0.9rem !important;
            margin-left: 0.25rem !important;
            margin-right: 0.25rem !important;
        }

        .book-mode .ayah-translation {
            display: none !important;
        }

        .book-mode .audio-player {
            display: none !important;
        }

        .book-mode .surah-navigation {
            display: none !important;
        }

        .book-mode .modal-header {
            background-color: #f8f4e9 !important;
            border-bottom: 2px solid #D9B44A !important;
        }

        .book-mode .modal-title {
            color: #8B4513 !important;
        }

        .book-mode .modal-close {
            color: #8B4513 !important;
        }

        body.dark-theme .book-mode {
            background-color: #1a1200 !important;
            color: #f0e6d1 !important;
        }

        body.dark-theme .book-mode .ayah-arabic {
            color: #f0e6d1 !important;
        }

        body.dark-theme .book-mode .ayah-number {
            color: #D9B44A !important;
        }

        body.dark-theme .book-mode .modal-header {
            background-color: #1a1200 !important;
            border-bottom: 2px solid #D9B44A !important;
        }

        body.dark-theme .book-mode .modal-title {
            color: #D9B44A !important;
        }

        body.dark-theme .book-mode .modal-close {
            color: #D9B44A !important;
        }

        .page-break {
            page-break-after: always;
            break-after: page;
            margin-bottom: 2rem;
        }

        .page-number {
            text-align: center;
            font-size: 0.8rem;
            color: #8B4513;
            margin-top: 1rem;
            margin-bottom: 2rem;
        }

        .touch-scroll-fix {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            scroll-behavior: smooth;
        }

        /* === Стили для книжного режима Корана === */
        .book-mode-page {
            background-color: #f8f4e9;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            direction: rtl;
            text-align: justify;
            font-family: 'Amiri Quran', serif;
            line-height: 2.5;
        }

        .book-mode-page .ayah {
            display: inline;
            margin-left: 8px;
        }

        .book-mode-page .ayah-number {
            background: transparent;
            color: #8B4513;
            font-size: 0.9rem;
            margin: 0 4px;
            padding: 0;
            display: inline;
        }

        .book-mode-page .page-number {
            text-align: center;
            margin-top: 1rem;
            font-size: 1rem;
            color: #8B4513;
            font-weight: bold;
        }

        .book-mode-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
        }

        body.dark-theme .book-mode-controls {
            background: var(--border-dark);
        }

        .page-nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        /* === Стили для системы уровней === */
        .levels-section {
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            margin: 1rem 0.75rem;
            position: relative;
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .levels-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--primary-dark);
            text-align: center;
        }

        body.dark-theme .levels-title {
            color: var(--accent-gold);
        }

        .level-card {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-main);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        body.dark-theme .level-card {
            background: var(--border-dark);
        }

        .level-card.current {
            background: linear-gradient(135deg, rgba(11, 91, 63, 0.1), rgba(217, 180, 74, 0.05));
            border-left-color: var(--accent-gold);
            transform: scale(1.02);
        }

        .level-card.level-1 { border-left-color: #10B981; }
        .level-card.level-2 { border-left-color: #0EA5E9; }
        .level-card.level-3 { border-left-color: #8B5CF6; }
        .level-card.level-4 { border-left-color: #F59E0B; }
        .level-card.level-5 { border-left-color: #EF4444; }
        .level-card.level-6 { border-left-color: #EC4899; }
        .level-card.level-7 { border-left-color: #06B6D4; }
        .level-card.level-8 { border-left-color: #84CC16; }
        .level-card.level-9 { border-left-color: #F97316; }
        .level-card.level-10 { border-left-color: #8B5CF6; border-left-width: 6px; }

        .level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .level-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-dark);
        }

        body.dark-theme .level-name {
            color: var(--accent-gold);
        }

        .level-badge {
            background: var(--primary-main);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .level-description {
            color: var(--text-secondary-light);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        body.dark-theme .level-description {
            color: var(--text-secondary-dark);
        }

        .level-requirements {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .requirement {
            background: rgba(11, 91, 63, 0.1);
            padding: 0.4rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            transition: var(--transition);
        }

        body.dark-theme .requirement {
            background: rgba(217, 180, 74, 0.1);
        }

        .requirement.completed {
            background: var(--success);
            color: white;
        }

        .requirement:hover {
            transform: translateY(-2px);
        }

        .level-progress {
            height: 6px;
            background: var(--border-light);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        body.dark-theme .level-progress {
            background: var(--border-dark);
        }

        .level-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-main), var(--accent-gold));
            border-radius: 3px;
            width: 0%;
            transition: width 0.8s ease;
        }

        .level-unlock-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .level-unlock-animation.active {
            opacity: 1;
            pointer-events: all;
        }

        .unlock-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            max-width: 90%;
            box-shadow: var(--shadow-lg);
            transform: scale(0.8);
            transition: transform 0.5s ease;
        }

        .level-unlock-animation.active .unlock-content {
            transform: scale(1);
        }

        .unlock-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .unlock-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary-dark);
        }

        .unlock-description {
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .unlock-dua {
            font-style: italic;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--accent-cream);
            border-radius: var(--radius-md);
        }

        body.dark-theme .unlock-dua {
            background: #2d2a1a;
        }

        /* === Дополнительные стили для профиля === */
        .profile-level-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .level-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-main), var(--accent-gold));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .level-info {
            text-align: left;
        }

        .level-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .level-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary-light);
        }

        body.dark-theme .level-subtitle {
            color: var(--text-secondary-dark);
        }

        .profile-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .profile-action-btn {
            background: var(--primary-main);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .profile-action-btn:hover {
            background: var(--primary-dark);
        }

        .profile-action-btn.secondary {
            background: var(--bg-light);
            color: var(--text-primary-light);
        }

        body.dark-theme .profile-action-btn.secondary {
            background: var(--border-dark);
            color: var(--text-primary-dark);
        }

        /* Индивидуальный дизайн для каждого уровня */
        .level-1 .level-icon { background: linear-gradient(135deg, #10B981, #059669); }
        .level-2 .level-icon { background: linear-gradient(135deg, #0EA5E9, #0284C7); }
        .level-3 .level-icon { background: linear-gradient(135deg, #8B5CF6, #7C3AED); }
        .level-4 .level-icon { background: linear-gradient(135deg, #F59E0B, #D97706); }
        .level-5 .level-icon { background: linear-gradient(135deg, #EF4444, #DC2626); }
        .level-6 .level-icon { background: linear-gradient(135deg, #EC4899, #DB2777); }
        .level-7 .level-icon { background: linear-gradient(135deg, #06B6D4, #0891B2); }
        .level-8 .level-icon { background: linear-gradient(135deg, #84CC16, #65A30D); }
        .level-9 .level-icon { background: linear-gradient(135deg, #F97316, #EA580C); }
        .level-10 .level-icon { 
            background: linear-gradient(135deg, #8B5CF6, #7C3AED, #6D28D9);
        }

        .level-1 .level-card { border-left-color: #10B981; }
        .level-2 .level-card { border-left-color: #0EA5E9; }
        .level-3 .level-card { border-left-color: #8B5CF6; }
        .level-4 .level-card { border-left-color: #F59E0B; }
        .level-5 .level-card { border-left-color: #EF4444; }
        .level-6 .level-card { border-left-color: #EC4899; }
        .level-7 .level-card { border-left-color: #06B6D4; }
        .level-8 .level-card { border-left-color: #84CC16; }
        .level-9 .level-card { border-left-color: #F97316; }
        .level-10 .level-card { 
            border-left-color: #8B5CF6; 
            border-left-width: 6px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(124, 58, 237, 0.1));
        }

        body.dark-theme .level-10 .level-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.2));
        }

        /* Стили для заблокированных уровней */
        .level-card.locked {
            opacity: 0.6;
            filter: grayscale(0.7);
        }

        .level-card.locked .level-requirements {
            display: none;
        }

        .level-card.locked .level-progress {
            display: none;
        }

        .locked-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            border-radius: var(--radius-md);
        }

        /* Стили для отметки страниц в режиме чтения */
        .page-mark-button {
            background: var(--accent-gold);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.5rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-mark-button:hover {
            background: #e6a429;
        }

        .page-mark-button.marked {
            background: var(--success);
        }

        /* Анимация разблокировки уровня */
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--accent-gold);
            opacity: 0;
            z-index: 4000;
            animation: confetti 2s ease-out forwards;
        }

        /* Уникальные темы для каждого уровня */
        .level-theme-1 { --primary-main: #10B981; --primary-dark: #059669; }
        .level-theme-2 { --primary-main: #0EA5E9; --primary-dark: #0284C7; }
        .level-theme-3 { --primary-main: #8B5CF6; --primary-dark: #7C3AED; }
        .level-theme-4 { --primary-main: #F59E0B; --primary-dark: #D97706; }
        .level-theme-5 { --primary-main: #EF4444; --primary-dark: #DC2626; }
        .level-theme-6 { --primary-main: #EC4899; --primary-dark: #DB2777; }
        .level-theme-7 { --primary-main: #06B6D4; --primary-dark: #0891B2; }
        .level-theme-8 { --primary-main: #84CC16; --primary-dark: #65A30D; }
        .level-theme-9 { --primary-main: #F97316; --primary-dark: #EA580C; }
        .level-theme-10 { --primary-main: #8B5CF6; --primary-dark: #7C3AED; }
        
        /* === Улучшенные анимации для уровней === */
        .level-card.unlocking {
            animation: unlockPulse 2s ease-in-out;
        }
        
        @keyframes unlockPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1.02); }
        }
        
        .level-glow {
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: var(--radius-md);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .level-card.current .level-glow {
            opacity: 1;
            background: radial-gradient(circle, rgba(217, 180, 74, 0.2) 0%, transparent 70%);
            animation: glowPulse 3s infinite;
        }
        
        @keyframes glowPulse {
            0% { opacity: 0.3; }
            50% { opacity: 0.7; }
            100% { opacity: 0.3; }
        }
        
        /* === Улучшенные анимации для разблокировки уровня === */
        .level-unlock-animation .unlock-content {
            background: linear-gradient(135deg, #ffffff, #f8f4e9);
            border: 3px solid var(--accent-gold);
            position: relative;
            overflow: hidden;
        }
        
        .level-unlock-animation .unlock-content::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(217, 180, 74, 0.1), transparent);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .unlock-icon {
            animation: bounce 1s infinite, rotate 3s linear infinite;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .level-progress-fill.animating {
            animation: progressFill 1.5s ease-out;
        }
        
        @keyframes progressFill {
            0% { width: 0%; }
            100% { width: var(--target-width); }
        }

        /* === ИСПРАВЛЕНИЯ ДЛЯ КЛИКАБЕЛЬНОСТИ === */
        button, .nav-item, .action-button, .task-checkbox, .task-item, .surah-card, .surah-action-btn, .community-button, .profile-action-btn, .requirement, .ayah-arabic {
            cursor: pointer !important;
            -webkit-user-select: none !important;
            user-select: none !important;
            -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
            touch-action: manipulation !important;
        }

        /* Улучшение отзывчивости для мобильных устройств */
        @media (max-width: 768px) {
            button, .nav-item, .action-button, .task-checkbox, .task-item, .surah-card, .surah-action-btn, .community-button, .profile-action-btn, .requirement, .ayah-arabic {
                min-height: 44px !important;
                min-width: 44px !important;
            }
        }

        /* Улучшение визуальной обратной связи при нажатии */
        button:active, .nav-item:active, .action-button:active, .task-checkbox:active, .task-item:active, .surah-card:active, .surah-action-btn:active, .community-button:active, .profile-action-btn:active, .requirement:active {
            transform: scale(0.98) !important;
            transition: transform 0.1s ease !important;
        }

        /* Убедимся, что все интерактивные элементы видны и доступны */
        .theme-toggle, .verse-bookmark, .modal-close, .font-size-btn, .warm-light-toggle, .book-mode-toggle, .theme-toggle-quran, .play-btn, .nav-button, .page-mark-button {
            position: relative !important;
            z-index: 10 !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Home Tab -->
        <div id="home-tab" class="tab-content active touch-scroll-fix">
            <!-- Header -->
            <header class="header">
                <div class="header-top">
                    <div class="logo">
                        <div class="logo-icon">🕌</div>
                        <div class="logo-text">Путь к Рамадану</div>
                    </div>
                    <button class="theme-toggle" id="themeToggle" aria-label="Переключить тему">
                        🌙
                    </button>
                </div>
                
                <div class="countdown-section">
                    <div class="countdown-title">До Рамадана 2026 года осталось:</div>
                    <div class="countdown-timer" id="countdown">88:00:00:00</div>
                    <div class="countdown-subtitle">По расчетам для региона Махачкала</div>
                </div>
            </header>

            <!-- Progress Section -->
            <section class="progress-section fade-in">
                <div class="progress-header">
                    <span class="progress-label">Ваша готовность к Рамадану</span>
                    <span class="progress-percent" id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </section>

            <!-- Today's Task -->
            <section class="task-card fade-in">
                <div class="task-header">
                    <div class="task-badge">СЕГОДНЯШНЯЯ ЗАДАЧА</div>
                    <div class="task-date" id="currentDate"></div>
                </div>
                
                <div class="task-content">
                    <h2 class="task-title" id="taskTitle">Прочитать 1 страницу Корана</h2>
                    <p class="task-description" id="taskDescription">Открой мусхаф и прочитай одну страницу с медленным тажвидом. Постарайтесь понять смысл прочитанного и подумать над аятами.</p>
                    
                    <div class="task-proof">
                        "Читай во имя Господа твоего, Который сотворил все сущее"
                        <span class="task-source">Коран, 96:1 (перевод Э. Кулиева)</span>
                    </div>
                    
                    <div class="task-actions">
                        <div class="task-checkbox" id="taskCheckbox">
                            <div class="checkbox" id="checkbox"></div>
                            <span class="checkbox-label">Отметить выполненным</span>
                        </div>
                        <div class="task-meta">
                            <div class="task-time">⏱ 15 мин</div>
                            <div class="task-difficulty">💪 Легко</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions fade-in">
                <button class="action-button active" data-action="quran" onclick="showTab('quran-tab')">
                    <div class="action-icon">📖</div>
                    <span class="action-text">Коран</span>
                </button>
                <button class="action-button" data-action="prayer" onclick="showTab('prayer-tab')">
                    <div class="action-icon">🕌</div>
                    <span class="action-text">Намаз</span>
                </button>
                <button class="action-button" data-action="azkar" onclick="showTab('dua-tab')">
                    <div class="action-icon">📿</div>
                    <span class="action-text">Азкары</span>
                </button>
                <button class="action-button" data-action="community" onclick="showCommunityNotification()">
                    <div class="action-icon">👥</div>
                    <span class="action-text">Сообщество</span>
                </button>
            </section>

            <!-- Daily Verse -->
            <section class="verse-card fade-in">
                <div class="verse-header">
                    <div class="verse-title">Аят дня</div>
                    <button class="verse-bookmark" aria-label="Добавить в закладки">🔖</button>
                </div>
                <div class="verse-arabic">
                    إِنَّ اللَّهَ وَمَلَائِكَتَهُ يُصَلُّونَ عَلَى النَّبِيِّ يَا أَيُّهَا الَّذِينَ آمَنُوا صَلُّوا عَلَيْهِ وَسَلِّمُوا تَسْلِيمًا
                </div>
                <div class="verse-translation">
                    "Воистину, Аллах и Его ангелы благословляют Пророка. О те, которые уверовали! Благословляйте его и приветствуйте миром."
                </div>
                <div class="verse-source">
                    Коран, 33:56 (перевод Э. Кулиева)
                </div>
            </section>
        </div>

        <!-- Preparation Tab -->
        <div id="preparation-tab" class="tab-content touch-scroll-fix">
            <header class="header">
                <div class="header-top">
                    <div class="logo">
                        <div class="logo-icon">📅</div>
                        <div class="logo-text">12-недельная подготовка</div>
                    </div>
                    <button class="theme-toggle" id="themeToggle2" aria-label="Переключить тему">
                        🌙
                    </button>
                </div>
            </header>

            <div class="week-section" id="week-section">
                <!-- Weeks will be generated dynamically -->
            </div>
        </div>

        <!-- Quran Tab -->
        <div id="quran-tab" class="tab-content touch-scroll-fix">
            <header class="header">
                <div class="header-top">
                    <div class="logo">
                        <div class="logo-icon">📖</div>
                        <div class="logo-text">Священный Коран</div>
                    </div>
                    <button class="theme-toggle" id="themeToggle3" aria-label="Переключить тему">
                        🌙
                    </button>
                </div>
            </header>

            <div class="quran-controls">
                <div class="font-size-control">
                    <span class="font-size-label">Арабский:</span>
                    <button class="font-size-btn" onclick="changeArabicFontSize(-1)">A-</button>
                    <button class="font-size-btn" onclick="changeArabicFontSize(1)">A+</button>
                </div>
                <button class="warm-light-toggle" onclick="toggleWarmLight()">Теплый свет</button>
                <div class="font-size-control">
                    <span class="font-size-label">Перевод:</span>
                    <button class="font-size-btn" onclick="changeTranslationFontSize(-1)">A-</button>
                    <button class="font-size-btn" onclick="changeTranslationFontSize(1)">A+</button>
                </div>
            </div>

            <div class="reading-progress-container">
                <div class="reading-progress-header">
                    <span class="reading-progress-title">Ваш прогресс чтения Корана</span>
                    <span class="reading-progress-percent" id="quranProgressPercent">0%</span>
                </div>
                <div class="reading-progress-bar">
                    <div class="reading-progress-fill" id="quranProgressFill"></div>
                </div>
                <div class="reading-progress-text" id="reading-progress-text">Вы еще не начали чтение Корана</div>
            </div>

            <div class="quran-section" id="quran-section">
                <!-- Surahs will be loaded dynamically -->
            </div>
        </div>

        <!-- Prayer Tab -->
        <div id="prayer-tab" class="tab-content touch-scroll-fix">
            <header class="header">
                <div class="header-top">
                    <div class="logo">
                        <div class="logo-icon">🕌</div>
                        <div class="logo-text">Время намаза</div>
                    </div>
                    <button class="theme-toggle" id="themeToggle4" aria-label="Переключить тему">
                        🌙
                    </button>
                </div>
            </header>

            <div class="prayer-section">
                <div class="prayer-times">
                    <div class="prayer-header">
                        <h3 class="prayer-title">Сегодняшние намазы</h3>
                        <span class="prayer-location" id="prayer-location">Махачкала</span>
                    </div>
                    <div class="prayer-list" id="prayer-list">
                        <!-- Prayer times will be loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Community Tab -->
        <div id="community-tab" class="tab-content touch-scroll-fix">
            <header class="header">
                <div class="header-top">
                    <div class="logo">
                        <div class="logo-icon">👥</div>
                        <div class="logo-text">Сообщество</div>
                    </div>
                    <button class="theme-toggle" id="themeToggle5" aria-label="Переключить тему">
                        🌙
                    </button>
                </div>
            </header>

            <div class="community-section">
                <div class="community-card">
                    <h3 class="community-title">Статистика сообщества</h3>
                    <div class="community-stats">
                        <div class="community-stat">
                            <div class="community-stat-value" id="community-users">1,245</div>
                            <div class="community-stat-label">Участников</div>
                        </div>
                        <div class="community-stat">
                            <div class="community-stat-value" id="community-tasks">12,847</div>
                            <div class="community-stat-label">Выполнено задач</div>
                        </div>
                        <div class="community-stat">
                            <div class="community-stat-value" id="community-pages">45,231</div>
                            <div class="community-stat-label">Прочитано страниц</div>
                        </div>
                    </div>
                    <div class="community-actions">
                        <button class="community-button" onclick="showCommunityNotification()">
                            💬 Обсуждения
                        </button>
                        <button class="community-button" onclick="showCommunityNotification()">
                            🏆 Рейтинг
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dua Tab -->
        <div id="dua-tab" class="tab-content touch-scroll-fix">
            <header class="header">
                <div class="header-top">
                    <div class="logo">
                        <div class="logo-icon">📿</div>
                        <div class="logo-text">Дуа и Азкары</div>
                    </div>
                    <button class="theme-toggle" id="themeToggle6" aria-label="Переключить тему">
                        🌙
                    </button>
                </div>
            </header>

            <div class="dua-section" id="dua-section">
                <!-- Duas will be loaded dynamically -->
            </div>
        </div>

        <!-- Levels Tab -->
        <div id="levels-tab" class="tab-content touch-scroll-fix">
            <header class="header">
                <div class="header-top">
                    <div class="logo">
                        <div class="logo-icon">📊</div>
                        <div class="logo-text">Система уровней</div>
                    </div>
                    <button class="theme-toggle" id="themeToggle8" aria-label="Переключить тему">
                        🌙
                    </button>
                </div>
            </header>

            <div class="levels-section">
                <h3 class="levels-title">10 ступеней духовного роста</h3>
                <div id="all-levels-container">
                    <!-- Все уровни будут загружены динамически -->
                </div>
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profile-tab" class="tab-content touch-scroll-fix">
            <header class="header">
                <div class="header-top">
                    <div class="logo">
                        <div class="logo-icon">👤</div>
                        <div class="logo-text">Мой профиль</div>
                    </div>
                    <button class="theme-toggle" id="themeToggle7" aria-label="Переключить тему">
                        🌙
                    </button>
                </div>
            </header>

            <div class="profile-section">
                <div class="profile-card">
                    <div class="profile-avatar">🕌</div>
                    
                    <div class="profile-level-display">
                        <div class="level-icon" id="current-level-icon">1</div>
                        <div class="level-info">
                            <div class="level-title" id="current-level-title">Начинающий</div>
                            <div class="level-subtitle" id="current-level-subtitle">Уровень 1 из 10</div>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="completedTasks">0</div>
                            <div class="stat-label">Задач</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="quranPages">0</div>
                            <div class="stat-label">Страниц</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="streakDays">0</div>
                            <div class="stat-label">Дней подряд</div>
                        </div>
                    </div>

                    <div class="profile-actions">
                        <button class="profile-action-btn" onclick="showTab('levels-tab')">
                            📊 Мои уровни
                        </button>
                        <button class="profile-action-btn secondary" onclick="showAchievements()">
                            🏆 Достижения
                        </button>
                    </div>
                </div>

                <!-- Новая секция с уровнями в профиле -->
                <div class="levels-section">
                    <h3 class="levels-title">Ваш прогресс по уровням</h3>
                    <div id="levels-container">
                        <!-- Уровни будут загружены динамически -->
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-title">Настройки</h3>
                    
                    <div class="setting-item">
                        <span class="setting-label">Пуш-уведомления</span>
                        <label class="switch">
                            <input type="checkbox" id="notificationsSwitch" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <span class="setting-label">Напоминания о намазе</span>
                        <label class="switch">
                            <input type="checkbox" id="prayerRemindersSwitch" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <span class="setting-label">Тёмная тема</span>
                        <label class="switch">
                            <input type="checkbox" id="darkThemeSwitch">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <span class="setting-label">Утренние напоминания</span>
                        <label class="switch">
                            <input type="checkbox" id="morningRemindersSwitch" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <span class="setting-label">Вечерние напоминания</span>
                        <label class="switch">
                            <input type="checkbox" id="eveningRemindersSwitch" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <!-- Управление кэшем -->
                    <div class="setting-item">
                        <span class="setting-label">Управление кэшем</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="nav-button" onclick="forceRefreshCache()" style="font-size: 0.8rem; padding: 0.5rem 1rem;">
                                Очистить кэш
                            </button>
                            <button class="nav-button" onclick="showCacheInfo()" style="font-size: 0.8rem; padding: 0.5rem 1rem;">
                                Информация
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-tab="home-tab" onclick="showTab('home-tab')">
                <div class="nav-icon">🏠</div>
                <span class="nav-text">Главная</span>
            </div>
            <div class="nav-item" data-tab="preparation-tab" onclick="showTab('preparation-tab')">
                <div class="nav-icon">📅</div>
                <span class="nav-text">Подготовка</span>
            </div>
            <div class="nav-item" data-tab="quran-tab" onclick="showTab('quran-tab')">
                <div class="nav-icon">📖</div>
                <span class="nav-text">Коран</span>
            </div>
            <div class="nav-item" data-tab="levels-tab" onclick="showTab('levels-tab')">
                <div class="nav-icon">📊</div>
                <span class="nav-text">Уровни</span>
            </div>
            <div class="nav-item" data-tab="profile-tab" onclick="showTab('profile-tab')">
                <div class="nav-icon">👤</div>
                <span class="nav-text">Профиль</span>
            </div>
        </nav>
    </div>

    <!-- Modal for Surah Reading -->
    <div class="modal" id="surah-modal">
        <div class="modal-content" id="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="surah-modal-title">Сура Аль-Фатиха</h3>
                <div>
                    <button class="theme-toggle-quran" id="quranThemeToggle">Приятная тема</button>
                    <button class="book-mode-toggle" id="bookModeToggle">Книжный режим</button>
                    <button class="modal-close" onclick="closeSurahModal()">×</button>
                </div>
            </div>
            
            <!-- Audio Player Controls -->
            <div class="audio-player" id="audio-player">
                <div class="audio-controls">
                    <button class="play-btn" id="play-btn">▶️</button>
                    <select class="reciter-select" id="reciter-select">
                        <option value="ar.alafasy">Мишари Рашид Аль-Афаси</option>
                        <option value="ar.husary">Махмуд Халиль Аль-Хусари</option>
                        <option value="ar.hudhaify">Али ибн Абдуррахман Аль-Хузейфи</option>
                        <option value="ar.abdulbasit">Абдульбасит Абдуссамад</option>
                        <option value="ar.mahermuaiqly">Магер Аль-Муайкли</option>
                    </select>
                </div>
                <span id="current-reciter">Выберите чтеца</span>
            </div>
            
            <div class="modal-body touch-scroll-fix">
                <div class="surah-content" id="surah-content">
                    <!-- Surah content will be loaded here -->
                </div>
            </div>
            
            <div class="surah-navigation">
                <button class="nav-button" id="prev-surah" onclick="navigateSurah(-1)">Предыдущая</button>
                <button class="nav-button" id="next-surah" onclick="navigateSurah(1)">Следующая</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для книжного режима Корана -->
    <div class="modal" id="book-mode-modal">
        <div class="modal-content" id="book-modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="book-modal-title">Чтение Корана - Страница 1</h3>
                <div>
                    <button class="theme-toggle-quran" id="bookThemeToggle">Приятная тема</button>
                    <button class="book-mode-toggle" id="exitBookMode">Обычный режим</button>
                    <button class="modal-close" onclick="closeBookModeModal()">×</button>
                </div>
            </div>
            
            <div class="book-mode-controls">
                <div class="page-nav-buttons">
                    <button class="nav-button" id="prev-page" onclick="navigatePage(-1)">← Предыдущая</button>
                    <button class="nav-button" id="next-page" onclick="navigatePage(1)">Следующая →</button>
                </div>
                <div class="font-size-control">
                    <span class="font-size-label">Шрифт:</span>
                    <button class="font-size-btn" onclick="changeBookFontSize(-1)">A-</button>
                    <button class="font-size-btn" onclick="changeBookFontSize(1)">A+</button>
                </div>
            </div>
            
            <div class="modal-body touch-scroll-fix">
                <div class="book-mode-page" id="book-page-content">
                    <!-- Содержимое страницы будет загружено здесь -->
                </div>
                <div class="page-number" id="page-number">Страница 1</div>
                <button class="page-mark-button" id="page-mark-button" onclick="togglePageMark()">
                    <span>📌</span> Отметить страницу
                </button>
            </div>
        </div>
    </div>

    <!-- Анимация разблокировки уровня -->
    <div class="level-unlock-animation" id="level-unlock-animation">
        <div class="unlock-content">
            <div class="unlock-icon">🏆</div>
            <h2 class="unlock-title" id="unlock-level-name">Поздравляем!</h2>
            <p class="unlock-description" id="unlock-level-description">Вы достигли нового уровня в своем духовном пути</p>
            <div class="unlock-dua" id="unlock-level-dua">
                "О Аллах, сделай это благо постоянным, сделай эту благодарность искренней, и прими наши скромные усилия"
            </div>
            <button class="nav-button" onclick="closeLevelUnlock()">Продолжить</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Точная дата Рамадана 2026 (18 февраля 2026 по расчетам для Махачкалы)
        const RAMADAN_2026 = new Date('2026-02-18T00:00:00+03:00');
        const TOTAL_DAYS = 88;

        // === ИСПРАВЛЕННЫЕ ПЕРЕМЕННЫЕ ДЛЯ КЭШИРОВАНИЯ ===
        let cache = {
            quranData: JSON.parse(localStorage.getItem('quranCache')) || {},
            prayerTimes: JSON.parse(localStorage.getItem('prayerCache')) || {},
            dailyVerse: JSON.parse(localStorage.getItem('dailyVerseCache')) || null,
            lastUpdate: JSON.parse(localStorage.getItem('cacheLastUpdate')) || {}
        };

        // Глобальные переменные
        let currentProgress = 0;
        let completedTasks = 0;
        let currentTheme = localStorage.getItem('theme') || 'light';
        let dailyTasks = JSON.parse(localStorage.getItem('dailyTasks')) || {};
        let weeklyTasks = JSON.parse(localStorage.getItem('weeklyTasks')) || {};
        let currentSurah = 1;
        let allSurahs = [];
        let notificationInterval;
        let asrReminderSent = false;
        let quranReadingTheme = localStorage.getItem('quranReadingTheme') || 'default';
        let lastReadAyah = JSON.parse(localStorage.getItem('lastReadAyah')) || { surah: 1, ayah: 1 };
        let bookmarks = JSON.parse(localStorage.getItem('quranBookmarks')) || {};
        let arabicFontSize = parseInt(localStorage.getItem('arabicFontSize')) || 32;
        let translationFontSize = parseInt(localStorage.getItem('translationFontSize')) || 16;
        let warmLightEnabled = localStorage.getItem('warmLightEnabled') === 'true';
        let quranProgress = JSON.parse(localStorage.getItem('quranProgress')) || { readAyahs: 0, totalAyahs: 6236 };
        let bookModeEnabled = localStorage.getItem('bookModeEnabled') === 'true';
        let dailyVerse = JSON.parse(localStorage.getItem('dailyVerse')) || null;
        let dailyVerseDate = localStorage.getItem('dailyVerseDate') || null;
        
        // Audio variables - ИСПРАВЛЕННЫЕ
        let currentAudio = null;
        let isPlaying = false;
        let currentAyah = null;
        let currentReciter = 'ar.alafasy';
        let audioInitialized = false;

        // === ИСПРАВЛЕННЫЕ АУДИО API ===
        const AUDIO_API_BASE = 'https://cdn.islamic.network/quran/audio/128';
        const RECITERS = {
            'ar.alafasy': {
                name: 'Мишари Рашид Аль-Афаси',
                baseUrl: `${AUDIO_API_BASE}/ar.alafasy`
            },
            'ar.husary': {
                name: 'Махмуд Халиль Аль-Хусари', 
                baseUrl: `${AUDIO_API_BASE}/ar.husary`
            },
            'ar.hudhaify': {
                name: 'Али ибн Абдуррахман Аль-Хузейфи',
                baseUrl: `${AUDIO_API_BASE}/ar.hudhaify`
            },
            'ar.abdulbasit': {
                name: 'Абдульбасит Абдуссамад',
                baseUrl: `${AUDIO_API_BASE}/ar.abdulbasit`
            },
            'ar.mahermuaiqly': {
                name: 'Магер Аль-Муайкли',
                baseUrl: `${AUDIO_API_BASE}/ar.mahermuaiqly`
            }
        };

        // Данные для подготовки
        const preparationData = [
            {
                week: 12,
                title: "Духовная диагностика",
                theme: "Постановка целей и самопроверка",
                tasks: [
                    "Определить 3 главные цели на Рамадан",
                    "Проанализировать прошлые ошибки",
                    "Написать план исправления",
                    "Записать великие милости Аллаха, которыми Он одарил тебя, и размышлять над ними",
                    "Оценить текущий уровень имана",
                    "Определить вредные привычки для исправления",
                    "Начать вести духовный дневник"
                ]
            },
            {
                week: 11,
                title: "Режим сна",
                theme: "Привыкание к раннему пробуждению на фаджр",
                tasks: [
                    "Ложиться до 23:00",
                    "Вставать на фаджр ежедневно",
                    "Читать утренние азкары после фаджр",
                    "Совершать суннат-намазы фаджра",
                    "Планировать дела на день после фаджр",
                    "Изучить дуа перед сном",
                    "Установить сунну перед сном и придерживаться её всю неделю"
                ]
            },
            {
                week: 10,
                title: "Чтение Корана",
                theme: "1 страница в день с пониманием",
                tasks: [
                    "Читать 1 страницу после фаджр",
                    "Изучать тафсир одного аята",
                    "Запоминать один короткий аят",
                    "Размышлять над смыслом прочитанного",
                    "Читать Коран с тажвидом",
                    "Слушать чтение Корана",
                    "Делиться смыслом аята с семьей"
                ]
            },
            {
                week: 9,
                title: "Укрепление намаза",
                theme: "Сосредоточенность и регулярность",
                tasks: [
                    "Совершать все намазы вовремя",
                    "Готовиться к намаз за 5 минут",
                    "Читать дополнительные суннат-намазы",
                    "Улучшать концентрацию в намазе",
                    "Изучать значения читаемого в намазе",
                    "Совершать намаз в джамаате",
                    "Учить новые суры"
                ]
            },
            {
                week: 8,
                title: "Пост по понедельникам и четвергам",
                theme: "Подготовка организма к посту",
                tasks: [
                    "Соблюдать суннат-пост в понедельник",
                    "Соблюдать суннат-пост в четверг",
                    "Правильно питаться в сухур и ифтар",
                    "Увеличивать потребление воды",
                    "Тренировать нафс на сабр: уменьшить зависимость от привычных удовольствий",
                    "Практиковать ранний сухур",
                    "Изучать правила поста"
                ]
            },
            {
                week: 7,
                title: "Финансовая подготовка",
                theme: "Планирование закята и садаки",
                tasks: [
                    "Рассчитать закят аль-фитр",
                    "Составить список нуждающихся",
                    "Подготовить пожертвования для мечети",
                    "Изучить правила закята",
                    "Определить суммы для садаки",
                    "сделать хотя бы один скрытый саддака-поступок",
                    "Изучить благотворительные проекты"
                ]
            },
            {
                week: 6,
                title: "Духовное очищение",
                theme: "Искренность и отказ от показухи",
                tasks: [
                    "Скрывать благие дела от других",
                    "Практиковать искренность в намерениях",
                    "Избегать хвастовства",
                    "Просить Аллаха принять дела",
                    "Размышлять о показухе (рия)",
                    "Совершать тайные пожертвования",
                    "сделать хотя бы один скрытый саддака-поступок"
                ]
            },
            {
                week: 5,
                title: "Укрепление семейных уз",
                theme: "Подготовка семьи к Рамадану",
                tasks: [
                    "Провести семейную беседу о важности Рамадана",
                    "Разработать общие духовные цели семьи на Рамадан",
                    "Изучить важность и пользу поста",
                    "Стабильно читать по джузу в день",
                    "Создать атмосферу поклонения дома",
                    "Изучить пользу таравих-намаза",
                    "Важность ночных выстаиваний"
                ]
            },
            {
                week: 4,
                title: "Интеллектуальная подготовка",
                theme: "Изучение фикха поста и Рамадана",
                tasks: [
                    "Изучить правила поста",
                    "Узнать о действиях, нарушающих пост",
                    "Изучить исключения из поста",
                    "Прочитать о достоинствах Рамадана",
                    "Изучить правила закята аль-фитр",
                    "Узнать о ночи предопределения",
                    "Изучить правила итикафа"
                ]
            },
            {
                week: 3,
                title: "Социальная ответственность",
                theme: "Подготовка к помощи другим",
                tasks: [
                    "Найти нуждающихся для помощи",
                    "Дуа за мусульман во всем мире",
                    "Помочь нуждающимся едой или продуктами",
                    "Посетить больных родственников",
                    "Помочь в мечети",
                    "Примириться с теми, с кем в ссоре",
                    "Простить обиды"
                ]
            },
            {
                week: 2,
                title: "Интенсивное поклонение",
                theme: "Увеличение объема поклонения",
                tasks: [
                    "Увеличить чтение Корана до нескольких джузов",
                    "Добавить дополнительные нафль-намазы",
                    "Увеличить зикра",
                    "Читать больше салаватов",
                    "Совершать тахаджуд-намаз",
                    "Участвовать в коллективных намазах чаще",
                    "Просить прощения"
                ]
            },
            {
                week: 1,
                title: "Финальная подготовка",
                theme: "Последние приготовления к Рамадану",
                tasks: [
                    "Составить расписание на Рамадан",
                    "Завершить все важные дела",
                    "Сделать генеральную уборку дома",
                    "Купить продукты для Рамадана",
                    "Подготовить одежду для мечети",
                    "Настроить будильники для сухура",
                    "Попросить прощения у всех"
                ]
            }
        ];

        // Утренние и вечерние азкары
        const azkarsData = {
            morning: [
                {
                    arabic: "أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لا إِلَهَ إِلاَّ اللَّهُ وَحْدَهُ لا شَرِيكَ لَهُ",
                    translation: "Мы дожили до утра, и власть принадлежит Аллаху, хвала Аллаху, нет божества, кроме Аллаха, и нет у Него сотоварища",
                    source: "Муслим 2723"
                },
                {
                    arabic: "اللَّهُمَّ بِكَ أَصْبَحْنَا، وَبِكَ أَمْسَيْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ وَإِلَيْكَ النُّشُورُ",
                    translation: "О Аллах, с Тобой мы дожили до утра, с Тобой мы дожили до вечера, с Тобой мы живём, с Тобой умираем, и к Тебе воскресение",
                    source: "Ат-Тирмизи 3391"
                },
                {
                    arabic: "اللَّهُمَّ عَافِنِي فِي بَدَنِي، اللَّهُمَّ عَافِنِي فِي سَمْعِي، اللَّهُمَّ عَافِنِي فِي بَصَرِي، لاَ إِلَهَ إِلاَّ أَنْتَ",
                    translation: "О Аллах, даруй мне здоровье в моем теле, о Аллах, даруй мне здоровье в моем слухе, о Аллах, даруй мне здоровье в моем зрении, нет божества, кроме Тебя",
                    source: "Абу Дауд 5090"
                },
                {
                    arabic: "حَسْبِيَ اللَّهُ لاَ إِلَهَ إِلاَّ هُوَ عَلَيْهِ تَوَكَّلْتُ وَهُوَ رَبُّ الْعَرْشِ الْعَظِيمِ",
                    translation: "Достаточно мне Аллаха, нет божества, кроме Него, на Него я уповаю, и Он - Господь великого Трона",
                    source: "Абу Дауд 5081"
                }
            ],
            evening: [
                {
                    arabic: "أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لا إِلَهَ إِلاَّ اللَّهُ وَحْدَهُ لا شَرِيكَ لَهُ",
                    translation: "Мы дожили до вечера, и власть принадлежит Аллаху, хвала Аллаху, нет божества, кроме Аллаха, и нет у Него сотоварища",
                    source: "Муслим 2723"
                },
                {
                    arabic: "اللَّهُمَّ بِكَ أَمْسَيْنَا، وَبِكَ أَصْبَحْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ وَإِلَيْكَ الْمَصِيرُ",
                    translation: "О Аллах, с Тобой мы дожили до вечера, с Тобой мы дожили до утра, с Тобой мы живём, с Тобой умираем, и к Тебе возвращение",
                    source: "Ат-Тирмизи 3391"
                },
                {
                    arabic: "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْكَسَلِ وَالْهَرَمِ وَالْمَأْثَمِ وَالْمَغْرَمِ",
                    translation: "О Аллах, поистине, я прибегаю к Тебе от лени, старости, греха и долгов",
                    source: "Бухари 6363"
                },
                {
                    arabic: "اللَّهُمَّ إِنِّي أَسْأَلُكَ خَيْرَ هَذِهِ اللَّيْلَةِ وَأَعُوذُ بِكَ مِنْ شَرِّ هَذِهِ اللَّيْلَةِ",
                    translation: "О Аллах, я прошу у Тебя блага этой ночи и прибегаю к Тебе от зла этой ночи",
                    source: "Абу Дауд 5046"
                }
            ]
        };

        // Аяты для ежедневного обновления
        const dailyVerses = [
            {
                arabic: "إِنَّ اللَّهَ وَمَلَائِكَتَهُ يُصَلُّونَ عَلَى النَّبِيِّ يَا أَيُّهَا الَّذِينَ آمَنُوا صَلُّوا عَلَيْهِ وَسَلِّمُوا تَسْلِيمًا",
                translation: "Воистину, Аллах и Его ангелы благословляют Пророка. О те, которые уверовали! Благословляйте его и приветствуйте миром.",
                source: "Коран, 33:56 (перевод Э. Кулиева)"
            },
            {
                arabic: "رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الْآخِرَةِ حَسَنَةً وَقِنَا عَذَابَ النَّارِ",
                translation: "Господь наш! Даруй нам добро в этом мире и добро в Последней жизни и защити нас от мучений в Огне.",
                source: "Коран, 2:201 (перевод Э. Кулиева)"
            },
            {
                arabic: "وَمَنْ يَتَّقِ اللَّهَ يَجْعَلْ لَهُ مَخْرَجًا وَيَرْزُقْهُ مِنْ حَيْثُ لَا يَحْتَسِبُ",
                translation: "А того, кто боится Аллаха, Он спасет от беды и дарует ему пропитание, откуда он даже не предполагает.",
                source: "Коран, 65:2-3 (перевод Э. Кулиева)"
            },
            {
                arabic: "إِنَّ مَعَ الْعُسْرِ يُسْرًا إِنَّ مَعَ الْعُسْرِ يُسْرًا",
                translation: "Воистину, за каждой тягостью наступает облегчение. Воистину, за каждой тягостью наступает облегчение.",
                source: "Коран, 94:5-6 (перевод Э. Кулиева)"
            },
            {
                arabic: "وَلَا تَيْأَسُوا مِن رَّوْحِ اللَّهِ إِنَّهُ لَا يَيْأَسُ مِن رَّوْحِ اللَّهِ إِلَّا الْقَوْمُ الْكَافِرُونَ",
                translation: "Не отчаивайтесь в милости Аллаха, ибо отчаиваются в милости Аллаха только люди неверующие.",
                source: "Коран, 12:87 (перевод Э. Кулиева)"
            },
            {
                arabic: "وَمَا خَلَقْتُ الْجِنَّ وَالْإِنسَ إِلَّا لِيَعْبُدُونِ",
                translation: "Я сотворил джиннов и людей только для того, чтобы они поклонялись Мне.",
                source: "Коран, 51:56 (перевод Э. Кулиева)"
            },
            {
                arabic: "قُلْ هُوَ اللَّهُ أَحَدٌ اللَّهُ الصَّمَدُ لَمْ يَلِدْ وَلَمْ يُولَدْ وَلَمْ يَكُن لَّهُ كُفُوًا أَحَدٌ",
                translation: "Скажи: «Он - Аллах Единый, Аллах Самодостаточный. Он не родил и не был рожден, и нет никого, равного Ему».",
                source: "Коран, 112:1-4 (перевод Э. Кулиева)"
            }
        ];

        // === ДОПОЛНИТЕЛЬНЫЕ ПЕРЕМЕННЫЕ ===
        let currentPage = 1;
        const totalPages = 604; // Всего страниц в Коране
        let bookFontSize = parseInt(localStorage.getItem('bookFontSize')) || 24;
        
        // Система уровней
        const levelsData = [
            {
                id: 1,
                name: "Начинающий",
                description: "Вы только начинаете свой духовный путь",
                icon: "🌱",
                requirements: [
                    { type: "pages", target: 10, completed: false, description: "Прочитать 10 страниц Корана" },
                    { type: "tasks", target: 5, completed: false, description: "Выполнить 5 ежедневных задач" },
                    { type: "azkar", target: 7, completed: false, description: "Запомнить 7 утренних азкаров" }
                ],
                dua: "О Аллах, направь меня на прямой путь и укрепи мои намерения",
                unlocked: true
            },
            {
                id: 2,
                name: "Искатель знаний",
                description: "Вы активно изучаете основы ислама",
                icon: "📚",
                requirements: [
                    { type: "pages", target: 50, completed: false, description: "Прочитать 50 страниц Корана" },
                    { type: "surah", target: 3, completed: false, description: "Выучить 3 короткие суры" },
                    { type: "prayer", target: 21, completed: false, description: "Прочитать биографию одного из сподвижников" },
                    { type: "hadith", target: 5, completed: false, description: "Изучить 5 достоверных хадисов" }
                ],
                dua: "О Аллах, прибавь мне знания и сделай его полезным",
                unlocked: false
            },
            {
                id: 3,
                name: "Преданный",
                description: "Вы стабильны в поклонении и изучении",
                icon: "🕌",
                requirements: [
                    { type: "pages", target: 150, completed: false, description: "Прочитать 150 страниц Корана" },
                    { type: "surah", target: 7, completed: false, description: "Выучить 7 сур" },
                    { type: "fasting", target: 5, completed: false, description: "Соблюсти 5 суннат-постов" },
                    { type: "charity", target: 3, completed: false, description: "Совершить 3 благотворительных акта" }
                ],
                dua: "О Аллах, сделай меня среди тех, кто кается и очищается",
                unlocked: false
            },
            {
                id: 4,
                name: "Знающий",
                description: "Вы углубляетесь в понимание религии",
                icon: "🎓",
                requirements: [
                    { type: "pages", target: 300, completed: false, description: "Прочитать 300 страниц Корана" },
                    { type: "juz", target: 1, completed: false, description: "Завершить чтение 1 джуза" },
                    { type: "companions", target: 10, completed: false, description: "Изучить о 10 сподвижниках" },
                    { type: "tajweed", target: 1, completed: false, description: "Изучить основы таджвида" }
                ],
                dua: "О Аллах, укрась меня благородным нравом и полезным знанием",
                unlocked: false
            },
            {
                id: 5,
                name: "Практикующий",
                description: "Вы применяете знания в повседневной жизни",
                icon: "⚡",
                requirements: [
                    { type: "pages", target: 500, completed: false, description: "Прочитать 500 страниц Корана" },
                    { type: "juz", target: 3, completed: false, description: "Завершить чтение 3 джузов" },
                    { type: "sunnah", target: 15, completed: false, description: "Внедрить 15 сунн в жизнь" },
                    { type: "community", target: 5, completed: false, description: "Выучить битву при Ухуде" }
                ],
                dua: "О Аллах, сделай меня искренним в словах и делах",
                unlocked: false
            },
            {
                id: 6,
                name: "Наставник",
                description: "Вы делитесь знаниями с другими",
                icon: "👨‍🏫",
                requirements: [
                    { type: "pages", target: 800, completed: false, description: "Прочитать 800 страниц Корана" },
                    { type: "juz", target: 6, completed: false, description: "Завершить чтение 6 джузов" },
                    { type: "teaching", target: 3, completed: false, description: "Выучить битву при Бадре" },
                    { type: "article", target: 1, completed: false, description: "Изучить биографию всех четырех праведных халифов" }
                ],
                dua: "О Аллах, укрепи меня на прямом пути",
                unlocked: false
            },
            {
                id: 7,
                name: "Стремящийся к знанию",
                description: "Стремящийся к пониманию Корана и Сунны",
                icon: "🔍",
                requirements: [
                    { type: "pages", target: 1200, completed: false, description: "Прочитать 1200 страниц Корана" },
                    { type: "juz", target: 10, completed: false, description: "Завершить чтение 10 джузов" },
                    { type: "tafsir", target: 5, completed: false, description: "Изучить тафсир 5 сур" },
                    { type: "fiqh", target: 1, completed: false, description: "Изучить основы фикха" }
                ],
                dua: "О Аллах, открой мне врата Твоего милосердия и знания",
                unlocked: false
            },
            {
                id: 8,
                name: "Праведный",
                description: "Ваша вера проявляется во всех аспектах жизни",
                icon: "⭐",
                requirements: [
                    { type: "pages", target: 2000, completed: false, description: "Прочитать 2000 страниц Корана" },
                    { type: "juz", target: 15, completed: false, description: "Завершить чтение 15 джузов" },
                    { type: "character", target: 10, completed: false, description: "Улучшить 10 качеств характера" },
                    { type: "service", target: 10, completed: false, description: "Совершить три дня подряд духа намаз" }
                ],
                dua: "О Аллах, сделай меня среди праведных рабов Твоих",
                unlocked: false
            },
            {
                id: 9,
                name: "Продвинутый",
                description: "Вы продвинулись в понимании и старании. Продолжайте",
                icon: "🚀",
                requirements: [
                    { type: "pages", target: 3500, completed: false, description: "Прочитать 3500 страниц Корана" },
                    { type: "juz", target: 25, completed: false, description: "Завершить чтение 25 джузов" },
                    { type: "memorization", target: 2, completed: false, description: "Запомнить 2 джуза Корана" },
                    { type: "leadership", target: 5, completed: false, description: "Выучить биографию любого из сподвижников" }
                ],
                dua: "О Аллах, укрепи меня на прямом пути до конца жизни",
                unlocked: false
            },
            {
                id: 10,
                name: "Мастер",
                description: "Вы освоили важные основы понимания. Просите Аллаха укрепить и приумножить это благо",
                icon: "👑",
                requirements: [
                    { type: "pages", target: 6040, completed: false, description: "Прочитать весь Коран (6040 страниц)" },
                    { type: "quran", target: 1, completed: false, description: "Завершить чтение всего Корана" },
                    { type: "ramadan", target: 1, completed: false, description: "Подготовиться и пройти Рамадан наилучшим образом" },
                    { type: "legacy", target: 1, completed: false, description: "Выучить биографию Пророка" }
                ],
                dua: "О Аллах, прими мои скромные старания и сделай меня из числа обитателей Рая",
                unlocked: false
            }
        ];

        let userProgress = JSON.parse(localStorage.getItem('userProgress')) || {
            currentLevel: 1,
            pagesRead: 0,
            tasksCompleted: 0,
            azkarMemorized: 0,
            surahsMemorized: 0,
            prayersOnTime: 0,
            fastingDays: 0,
            charityActs: 0,
            companionsStudied: 0,
            tajweedLearned: false,
            sunnahImplemented: 0,
            communityHelped: 0,
            peopleTaught: 0,
            articlesWritten: 0,
            tafsirStudied: 0,
            fiqhLearned: false,
            characterImproved: 0,
            communityService: 0,
            juzMemorized: 0,
            eventsLed: 0,
            quranCompleted: false,
            ramadanCompleted: false,
            legacyLeft: false,
            // Добавляем хранение состояния отдельных требований
            levelRequirements: {}
        };

        // Переменные для отметки страниц
        let markedPages = JSON.parse(localStorage.getItem('markedPages')) || [];
        let currentPageMarked = false;

        // === ФУНКЦИИ ДЛЯ УПРАВЛЕНИЯ КЭШЕМ ===

        // Функция для проверки устаревания кэша
        function isCacheValid(cacheKey, maxAgeMinutes = 60) {
            if (!cache.lastUpdate[cacheKey]) return false;
            
            const lastUpdate = new Date(cache.lastUpdate[cacheKey]);
            const now = new Date();
            const diffMinutes = (now - lastUpdate) / (1000 * 60);
            
            return diffMinutes < maxAgeMinutes;
        }

        function loadPreparationData() {
    const weekSection = document.getElementById('week-section');
    if (!weekSection) return;
    
    weekSection.innerHTML = preparationData.map((week, index) => {
        const completedCount = weeklyTasks[week.week] ? 
            weeklyTasks[week.week].filter(task => task).length : 0;
        
        return `
            <div class="week-card">
                <div class="week-header">
                    <h3 class="week-title">Неделя ${week.week}: ${week.title}</h3>
                    <span class="week-progress">${completedCount}/7 выполнено</span>
                </div>
                <p class="week-theme">${week.theme}</p>
                <div class="tasks-list">
                    ${week.tasks.map((task, taskIndex) => {
                        const isCompleted = weeklyTasks[week.week] && weeklyTasks[week.week][taskIndex];
                        return `
                            <div class="task-item ${isCompleted ? 'completed' : ''}" 
                                 onclick="toggleTask(this, ${week.week}, ${taskIndex})">
                                <div class="task-item-checkbox"></div>
                                <span class="task-item-text">${task}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }).join('');
}
        
        // Функция для обновления кэша
        function updateCache(cacheKey, data) {
            cache[cacheKey] = data;
            cache.lastUpdate[cacheKey] = new Date().toISOString();
            
            // Сохраняем в localStorage
            localStorage.setItem('quranCache', JSON.stringify(cache.quranData));
            localStorage.setItem('prayerCache', JSON.stringify(cache.prayerTimes));
            localStorage.setItem('dailyVerseCache', JSON.stringify(cache.dailyVerse));
            localStorage.setItem('cacheLastUpdate', JSON.stringify(cache.lastUpdate));
        }

        // Функция для очистки устаревшего кэша
        function clearExpiredCache() {
            const now = new Date();
            Object.keys(cache.lastUpdate).forEach(key => {
                const lastUpdate = new Date(cache.lastUpdate[key]);
                const diffHours = (now - lastUpdate) / (1000 * 60 * 60);
                
                // Очищаем кэш старше 24 часов
                if (diffHours > 24) {
                    delete cache[key];
                    delete cache.lastUpdate[key];
                }
            });
            
            // Сохраняем обновленный кэш
            localStorage.setItem('quranCache', JSON.stringify(cache.quranData));
            localStorage.setItem('prayerCache', JSON.stringify(cache.prayerTimes));
            localStorage.setItem('dailyVerseCache', JSON.stringify(cache.dailyVerse));
            localStorage.setItem('cacheLastUpdate', JSON.stringify(cache.lastUpdate));
        }

        // Функция для принудительного обновления кэша
        function forceRefreshCache() {
            // Очищаем весь кэш
            cache = {
                quranData: {},
                prayerTimes: {},
                dailyVerse: null,
                lastUpdate: {}
            };
            
            localStorage.removeItem('quranCache');
            localStorage.removeItem('prayerCache');
            localStorage.removeItem('dailyVerseCache');
            localStorage.removeItem('cacheLastUpdate');
            
            showToast('Кэш очищен. Данные будут загружены заново.', 'success');
            
            // Перезагружаем данные
            setTimeout(() => {
                loadQuranData();
                loadPrayerTimes();
                updateDailyVerse();
            }, 1000);
        }

        // Функция для показа информации о кэше
        function showCacheInfo() {
            const cacheSize = getCacheSize();
            const cacheEntries = Object.keys(cache.lastUpdate).length;
            
            showToast(`Кэш: ${cacheSize}, записей: ${cacheEntries}`, 'info');
        }

        // Функция для проверки размера кэша
        function getCacheSize() {
            let totalSize = 0;
            
            try {
                totalSize += JSON.stringify(cache.quranData).length;
                totalSize += JSON.stringify(cache.prayerTimes).length;
                totalSize += JSON.stringify(cache.dailyVerse).length;
                totalSize += JSON.stringify(cache.lastUpdate).length;
                
                return (totalSize / 1024).toFixed(2) + ' KB';
            } catch (error) {
                return 'Неизвестно';
            }
        }

        // === ОСНОВНЫЕ ФУНКЦИИ НАВИГАЦИИ ===

        function showTab(tabId) {
            // Скрыть все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Показать выбранную вкладку
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Обновить навигацию
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNavItem = document.querySelector(`[data-tab="${tabId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }
            
            // Сброс прокрутки для PWA
            setTimeout(() => {
                const activeTab = document.getElementById(tabId);
                if (activeTab) {
                    activeTab.scrollTop = 0;
                }
            }, 50);
            
            // Обновить прогресс чтения при открытии вкладки Корана
            if (tabId === 'quran-tab') {
                updateReadingProgress();
            }
            
            // Загружаем уровни при открытии соответствующей вкладки
            if (tabId === 'levels-tab' || tabId === 'profile-tab') {
                loadLevels();
            }
            
            // Применяем тему текущего уровня
            applyLevelTheme();
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            
            // Вибрация при уведомлении
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showNotification(message, vibrate = true) {
            // Проверяем разрешение на уведомления
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification('Путь к Рамадану', {
                    body: message,
                    icon: 'icons/icon-192.png',
                    badge: 'icons/icon-192.png',
                    tag: 'ramadan-notification',
                    requireInteraction: true
                });
                
                // Вибрация при уведомлении
                if (vibrate && navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
                
                // Закрыть уведомление через 5 секунд
                setTimeout(() => {
                    notification.close();
                }, 5000);
            }
            showToast(message, 'warning');
        }

        function showCommunityNotification() {
            showNotification('Раздел "Сообщество" находится в разработке!', true);
        }

        // === ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ ===

        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            // Очищаем устаревший кэш при запуске
            clearExpiredCache();
            
            setupTheme();
            setupCountdown();
            setupEventListeners();
            setupServiceWorker();
            updateCurrentDate();
            updateStats();
            loadPreparationData();
            loadQuranData();
            loadPrayerTimes();
            loadAzkarsData();
            updateDailyTask();
            calculateProgress();
            setupNotifications();
            requestNotificationPermission();
            updateFontSizes();
            setupWarmLight();
            updateQuranProgress();
            setupAudioControls();
            updateDailyVerse();
            loadLevels();
            setupBookMode();
            applyLevelTheme();
            
            // ИСПРАВЛЕНИЕ: Инициализируем аудио при первом взаимодействии
            document.addEventListener('click', initializeAudio, { once: true });
        }

        function setupTheme() {
            const darkThemeSwitch = document.getElementById('darkThemeSwitch');
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.querySelectorAll('.theme-toggle').forEach(toggle => {
                    toggle.textContent = '☀️';
                });
                if (darkThemeSwitch) darkThemeSwitch.checked = true;
            } else {
                document.body.classList.remove('dark-theme');
                document.querySelectorAll('.theme-toggle').forEach(toggle => {
                    toggle.textContent = '🌙';
                });
                if (darkThemeSwitch) darkThemeSwitch.checked = false;
            }
        }

        function setupCountdown() {
            function updateCountdown() {
                const now = new Date();
                const diff = RAMADAN_2026 - now;

                if (diff > 0) {
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                    document.getElementById('countdown').textContent = 
                        `${days.toString().padStart(2, '0')}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    document.getElementById('countdown').textContent = "Рамадан наступил!";
                }
            }

            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        function setupEventListeners() {
            // Переключение темы
            document.querySelectorAll('.theme-toggle').forEach(toggle => {
                toggle.addEventListener('click', toggleTheme);
            });

            // Отметка задачи как выполненной
            const taskCheckbox = document.getElementById('taskCheckbox');
            if (taskCheckbox) {
                taskCheckbox.addEventListener('click', toggleMainTask);
            }

            // Переключение тёмной темы через switch
            const darkThemeSwitch = document.getElementById('darkThemeSwitch');
            if (darkThemeSwitch) {
                darkThemeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        currentTheme = 'dark';
                    } else {
                        currentTheme = 'light';
                    }
                    localStorage.setItem('theme', currentTheme);
                    setupTheme();
                });
            }

            // Настройки уведомлений
            const notificationsSwitch = document.getElementById('notificationsSwitch');
            if (notificationsSwitch) {
                notificationsSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        requestNotificationPermission();
                    } else {
                        // Отключить уведомления
                        if (notificationInterval) {
                            clearInterval(notificationInterval);
                        }
                    }
                });
            }

            // Предотвращение масштабирования
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });

            document.addEventListener('touchmove', function(e) {
                if (e.scale !== 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            // ИСПРАВЛЕНИЕ: Закрытие модального окна при клике вне его
            const surahModal = document.getElementById('surah-modal');
            if (surahModal) {
                surahModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeSurahModal();
                    }
                });
            }

            // Закрытие модального окна при клике на пустое место
            const modalContent = document.getElementById('modal-content');
            if (modalContent) {
                modalContent.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
            
            // Переключение темы чтения Корана
            const quranThemeToggle = document.getElementById('quranThemeToggle');
            if (quranThemeToggle) {
                quranThemeToggle.addEventListener('click', toggleQuranReadingTheme);
            }
            
            // Переключение книжного режима
            const bookModeToggle = document.getElementById('bookModeToggle');
            if (bookModeToggle) {
                bookModeToggle.addEventListener('click', toggleBookMode);
            }
            
            // ИСПРАВЛЕНИЕ: Добавляем обработчик для кнопки закрытия
            const modalClose = document.querySelector('.modal-close');
            if (modalClose) {
                modalClose.addEventListener('click', closeSurahModal);
            }
            
            // Обработчики для книжного режима
            const bookModeModal = document.getElementById('book-mode-modal');
            if (bookModeModal) {
                bookModeModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeBookModeModal();
                    }
                });
            }
            
            const bookModalContent = document.getElementById('book-modal-content');
            if (bookModalContent) {
                bookModalContent.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
            
            const bookThemeToggle = document.getElementById('bookThemeToggle');
            if (bookThemeToggle) {
                bookThemeToggle.addEventListener('click', toggleBookTheme);
            }
            
            const exitBookMode = document.getElementById('exitBookMode');
            if (exitBookMode) {
                exitBookMode.addEventListener('click', closeBookModeModal);
            }
        }

        function setupAudioControls() {
            const playBtn = document.getElementById('play-btn');
            const reciterSelect = document.getElementById('reciter-select');
            
            if (playBtn) {
                playBtn.addEventListener('click', toggleAudio);
            }
            
            if (reciterSelect) {
                reciterSelect.addEventListener('change', function() {
                    currentReciter = this.value;
                    const currentReciterSpan = document.getElementById('current-reciter');
                    if (currentReciterSpan) {
                        currentReciterSpan.textContent = this.options[this.selectedIndex].text;
                    }
                    if (isPlaying) {
                        stopAudio();
                        playAyah(currentAyah);
                    }
                });
            }
        }

        // ИСПРАВЛЕНИЕ: Функция для инициализации аудио
        function initializeAudio() {
            audioInitialized = true;
            // Создаем и сразу останавливаем пустой аудио элемент
            const silentAudio = new Audio();
            silentAudio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUgBjiN1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUgBjiN1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUgBjiN1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUgBjiN1/LMeSw=';
            silentAudio.volume = 0.01;
            
            const playPromise = silentAudio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    silentAudio.pause();
                    silentAudio.currentTime = 0;
                }).catch(error => {
                    console.log('Аудио инициализация завершена');
                });
            }
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', currentTheme);
            setupTheme();
        }

        function toggleQuranReadingTheme() {
            const modalContent = document.getElementById('modal-content');
            const toggleButton = document.getElementById('quranThemeToggle');
            
            if (modalContent && toggleButton) {
                if (quranReadingTheme === 'default') {
                    modalContent.classList.add('quran-reading-theme');
                    toggleButton.textContent = 'Обычная тема';
                    quranReadingTheme = 'pleasant';
                } else {
                    modalContent.classList.remove('quran-reading-theme');
                    toggleButton.textContent = 'Приятная тема';
                    quranReadingTheme = 'default';
                }
                
                localStorage.setItem('quranReadingTheme', quranReadingTheme);
            }
        }

        function toggleBookTheme() {
            const modalContent = document.getElementById('book-modal-content');
            const toggleButton = document.getElementById('bookThemeToggle');
            
            if (modalContent && toggleButton) {
                if (modalContent.classList.contains('quran-reading-theme')) {
                    modalContent.classList.remove('quran-reading-theme');
                    toggleButton.textContent = 'Приятная тема';
                } else {
                    modalContent.classList.add('quran-reading-theme');
                    toggleButton.textContent = 'Обычная тема';
                }
            }
        }

        function toggleBookMode() {
            const modalContent = document.getElementById('modal-content');
            const toggleButton = document.getElementById('bookModeToggle');
            const audioPlayer = document.getElementById('audio-player');
            const surahNavigation = document.querySelector('.surah-navigation');
            
            if (modalContent && toggleButton) {
                bookModeEnabled = !bookModeEnabled;
                localStorage.setItem('bookModeEnabled', bookModeEnabled);
                
                if (bookModeEnabled) {
                    modalContent.classList.add('book-mode');
                    toggleButton.textContent = 'Обычный режим';
                    if (audioPlayer) audioPlayer.style.display = 'none';
                    if (surahNavigation) surahNavigation.style.display = 'none';
                } else {
                    modalContent.classList.remove('book-mode');
                    toggleButton.textContent = 'Книжный режим';
                    if (audioPlayer) audioPlayer.style.display = 'flex';
                    if (surahNavigation) surahNavigation.style.display = 'flex';
                }
                
                showToast(bookModeEnabled ? 'Книжный режим включен' : 'Книжный режим выключен');
            }
        }

        function toggleWarmLight() {
            warmLightEnabled = !warmLightEnabled;
            localStorage.setItem('warmLightEnabled', warmLightEnabled);
            
            const quranTab = document.getElementById('quran-tab');
            const toggleButton = document.querySelector('.warm-light-toggle');
            
            if (quranTab && toggleButton) {
                if (warmLightEnabled) {
                    quranTab.classList.add('quran-reading-theme');
                    toggleButton.textContent = 'Обычный свет';
                    toggleButton.style.background = '#1C7A5C';
                } else {
                    quranTab.classList.remove('quran-reading-theme');
                    toggleButton.textContent = 'Теплый свет';
                    toggleButton.style.background = '';
                }
                
                showToast(warmLightEnabled ? 'Теплый свет включен' : 'Теплый свет выключен');
            }
        }

        function changeArabicFontSize(delta) {
            arabicFontSize = Math.max(16, Math.min(48, arabicFontSize + delta));
            localStorage.setItem('arabicFontSize', arabicFontSize);
            updateFontSizes();
            showToast(`Размер арабского шрифта: ${arabicFontSize}px`);
        }

        function changeTranslationFontSize(delta) {
            translationFontSize = Math.max(12, Math.min(24, translationFontSize + delta));
            localStorage.setItem('translationFontSize', translationFontSize);
            updateFontSizes();
            showToast(`Размер перевода: ${translationFontSize}px`);
        }

        function changeBookFontSize(delta) {
            bookFontSize = Math.max(16, Math.min(36, bookFontSize + delta));
            localStorage.setItem('bookFontSize', bookFontSize);
            applyBookFontSize();
            showToast(`Размер шрифта: ${bookFontSize}px`);
        }

        function updateFontSizes() {
            document.documentElement.style.setProperty('--arabic-font-size', arabicFontSize + 'px');
            document.documentElement.style.setProperty('--translation-font-size', translationFontSize + 'px');
        }

        function applyBookFontSize() {
            const pageContent = document.getElementById('book-page-content');
            if (pageContent) {
                pageContent.style.fontSize = `${bookFontSize}px`;
            }
        }

        function setupBookMode() {
            // Применяем сохраненный размер шрифта для книжного режима
            applyBookFontSize();
        }

        // === ИСПРАВЛЕННАЯ ФУНКЦИЯ ОБНОВЛЕНИЯ АЯТА ДНЯ ===
        function updateDailyVerse() {
            const today = new Date().toDateString();
            
            // Проверяем кэш
            if (cache.dailyVerse && cache.dailyVerse.date === today && isCacheValid('dailyVerse', 24 * 60)) {
                console.log('Загружаем аят дня из кэша');
                displayDailyVerse(cache.dailyVerse);
                return;
            }
            
            // Если аят дня не обновлялся сегодня или не существует
            if (!dailyVerse || dailyVerseDate !== today) {
                // Выбираем случайный аят из списка
                const randomIndex = Math.floor(Math.random() * dailyVerses.length);
                dailyVerse = dailyVerses[randomIndex];
                dailyVerseDate = today;
                
                // Обновляем кэш
                updateCache('dailyVerse', { ...dailyVerse, date: today });
                
                displayDailyVerse(dailyVerse);
            } else {
                displayDailyVerse(dailyVerse);
            }
        }

        function displayDailyVerse(verse) {
            const verseArabic = document.querySelector('.verse-arabic');
            const verseTranslation = document.querySelector('.verse-translation');
            const verseSource = document.querySelector('.verse-source');
            
            if (verseArabic && verseTranslation && verseSource) {
                verseArabic.textContent = verse.arabic;
                verseTranslation.textContent = verse.translation;
                verseSource.textContent = verse.source;
            }
        }

        function toggleMainTask() {
            const checkbox = document.getElementById('checkbox');
            const isChecked = checkbox.classList.contains('checked');
            const today = new Date().toDateString();
            
            if (!isChecked) {
                checkbox.classList.add('checked');
                dailyTasks[today] = true;
                completedTasks++;
                userProgress.tasksCompleted++;
                updateProgress();
                updateStats();
                showToast('Задача выполнена!', 'success');
                localStorage.setItem('dailyTasks', JSON.stringify(dailyTasks));
                localStorage.setItem('userProgress', JSON.stringify(userProgress));
                
                // Проверяем требования уровней
                checkLevelRequirements();
            } else {
                checkbox.classList.remove('checked');
                dailyTasks[today] = false;
                completedTasks = Math.max(0, completedTasks - 1);
                userProgress.tasksCompleted = Math.max(0, userProgress.tasksCompleted - 1);
                updateProgress();
                updateStats();
                showToast('Задача отменена', 'warning');
                localStorage.setItem('dailyTasks', JSON.stringify(dailyTasks));
                localStorage.setItem('userProgress', JSON.stringify(userProgress));
            }
        }

        // === ИСПРАВЛЕННАЯ ФУНКЦИЯ ПЕРЕКЛЮЧЕНИЯ ЗАДАЧ ===
function toggleTask(taskElement, weekIndex, taskIndex) {
    const isCompleted = taskElement.classList.contains('completed');
    
    if (!isCompleted) {
        taskElement.classList.add('completed');
        if (!weeklyTasks[weekIndex]) weeklyTasks[weekIndex] = [];
        weeklyTasks[weekIndex][taskIndex] = true;
        userProgress.tasksCompleted++;
        showToast('Задача выполнена!', 'success');
    } else {
        taskElement.classList.remove('completed');
        if (weeklyTasks[weekIndex]) weeklyTasks[weekIndex][taskIndex] = false;
        userProgress.tasksCompleted = Math.max(0, userProgress.tasksCompleted - 1);
        showToast('Задача отменена', 'warning');
    }
    
    updateProgress();
    updateStats();
    localStorage.setItem('weeklyTasks', JSON.stringify(weeklyTasks));
    localStorage.setItem('userProgress', JSON.stringify(userProgress));
    
    // Обновляем отображение прогресса недели
    updateWeekProgress(weekIndex);
    
    // Проверяем требования уровней
    checkLevelRequirements();
}
        function updateWeekProgress(weekIndex) {
    const weekCard = document.querySelector(`.week-card:nth-child(${weekIndex + 1})`);
    if (weekCard) {
        const completedCount = weeklyTasks[weekIndex] ? 
            weeklyTasks[weekIndex].filter(task => task).length : 0;
        const progressElement = weekCard.querySelector('.week-progress');
        if (progressElement) {
            progressElement.textContent = `${completedCount}/7 выполнено`;
        }
    }
}

        function calculateProgress() {
            // Рассчитываем прогресс на основе выполненных задач
            const dailyTaskCount = Object.keys(dailyTasks).filter(date => dailyTasks[date]).length;
            const weeklyTaskCount = Object.keys(weeklyTasks).reduce((sum, week) => {
                return sum + (weeklyTasks[week] ? weeklyTasks[week].filter(task => task).length : 0);
            }, 0);
            
            // Прогресс рассчитывается только на основе выполненных задач
            const totalTasks = dailyTaskCount + weeklyTaskCount;
            const maxTasks = 88 + (12 * 7); // 88 дней + 12 недель по 7 задач
            
            currentProgress = Math.min((totalTasks / maxTasks) * 100, 100);
            
            updateProgress();
        }

        function updateProgress() {
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            
            if (progressFill && progressPercent) {
                progressFill.style.width = `${currentProgress}%`;
                progressPercent.textContent = `${Math.round(currentProgress)}%`;
            }
        }

        function updateStats() {
            const dailyTaskCount = Object.keys(dailyTasks).filter(date => dailyTasks[date]).length;
            const weeklyTaskCount = Object.keys(weeklyTasks).reduce((sum, week) => {
                return sum + (weeklyTasks[week] ? weeklyTasks[week].filter(task => task).length : 0);
            }, 0);
            
            const completedTasksEl = document.getElementById('completedTasks');
            const quranPagesEl = document.getElementById('quranPages');
            const streakDaysEl = document.getElementById('streakDays');
            
            if (completedTasksEl) completedTasksEl.textContent = userProgress.tasksCompleted;
            if (quranPagesEl) quranPagesEl.textContent = userProgress.pagesRead;
            
            // Рассчитываем серию выполненных дней подряд
            const dates = Object.keys(dailyTasks).sort();
            let streak = 0;
            let currentDate = new Date();
            
            for (let i = 0; i < 7; i++) {
                const checkDate = new Date(currentDate);
                checkDate.setDate(checkDate.getDate() - i);
                const dateString = checkDate.toDateString();
                
                if (dailyTasks[dateString]) {
                    streak++;
                } else {
                    break;
                }
            }
            
            if (streakDaysEl) streakDaysEl.textContent = streak;
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric',
                weekday: 'long'
            };
            const currentDateEl = document.getElementById('currentDate');
            if (currentDateEl) {
                currentDateEl.textContent = now.toLocaleDateString('ru-RU', options);
            }
        }

        function updateDailyTask() {
            const today = new Date().toDateString();
            const checkbox = document.getElementById('checkbox');
            
            // Проверяем, выполнена ли сегодняшняя задача
            if (checkbox) {
                if (dailyTasks[today]) {
                    checkbox.classList.add('checked');
                } else {
                    checkbox.classList.remove('checked');
                }
            }
            
            // Обновляем задачу чтения Корана с учетом прогресса
            const startDate = new Date('2025-11-22'); // Дата начала программы
            const daysPassed = Math.floor((new Date() - startDate) / (1000 * 60 * 60 * 24));
            const pagesToRead = Math.min(daysPassed + 1, 604); // 604 страницы в Коране
            
            const taskTitle = document.getElementById('taskTitle');
            const taskDescription = document.getElementById('taskDescription');
            
            if (taskTitle && taskDescription) {
                taskTitle.textContent = `Прочитать ${pagesToRead} страниц Корана`;
                taskDescription.textContent = 
                    `Открой мусхаф и прочитай ${pagesToRead} страниц с медленным тажвидом. Постарайтесь понять смысл прочитанного и подумать над аятами.`;
            }
        }

        function updateReadingProgress() {
            const progressText = document.getElementById('reading-progress-text');
            
            if (progressText) {
                if (lastReadAyah.surah && lastReadAyah.ayah) {
                    const surah = allSurahs.find(s => s.number === lastReadAyah.surah);
                    if (surah) {
                        progressText.textContent = `Вы остановились на суре ${surah.englishName} (${surah.name}), аят ${lastReadAyah.ayah}`;
                    } else {
                        progressText.textContent = `Вы остановились на суре ${lastReadAyah.surah}, аят ${lastReadAyah.ayah}`;
                    }
                } else {
                    progressText.textContent = 'Вы еще не начали чтение Корана';
                }
            }
        }

        function updateQuranProgress() {
            const progressPercent = Math.round((quranProgress.readAyahs / quranProgress.totalAyahs) * 100);
            const progressPercentEl = document.getElementById('quranProgressPercent');
            const progressFillEl = document.getElementById('quranProgressFill');
            const progressText = document.getElementById('reading-progress-text');
            
            if (progressPercentEl) progressPercentEl.textContent = `${progressPercent}%`;
            if (progressFillEl) progressFillEl.style.width = `${progressPercent}%`;
            
            if (progressText) {
                progressText.textContent = `Прочитано ${quranProgress.readAyahs} из ${quranProgress.totalAyahs} аятов (${progressPercent}%)`;
            }
        }

        // === ИСПРАВЛЕННАЯ ФУНКЦИЯ ЗАГРУЗКИ КОРАНА ===
async function loadQuranData() {
    const quranSection = document.getElementById('quran-section');
    if (!quranSection) return;
    
    // Проверяем кэш
    if (cache.quranData.surahs && isCacheValid('quranData', 120)) {
        console.log('Загружаем Коран из кэша');
        displayQuranData(cache.quranData.surahs);
        return;
    }
    
    quranSection.innerHTML = '<div class="loading">Загрузка Корана...</div>';
    
    try {
        // Используем API для получения списка сур
        const response = await fetch('https://api.alquran.cloud/v1/surah');
        const data = await response.json();
        
        if (data.code === 200) {
            allSurahs = data.data;
            
            // Обновляем кэш
            updateCache('quranData', { surahs: allSurahs, timestamp: Date.now() });
            
            displayQuranData(allSurahs);
        } else {
            throw new Error('Не удалось загрузить данные Корана');
        }
    } catch (error) {
        console.error('Ошибка загрузки Корана:', error);
        
        // Пробуем загрузить из кэша
        if (cache.quranData.surahs) {
            console.log('Используем устаревший кэш Корана');
            displayQuranData(cache.quranData.surahs);
            return;
        }
        
        showToast('Ошибка загрузки Корана', 'error');
        loadFallbackQuranData();
    }
}
        function displayQuranData(surahs) {
    const quranSection = document.getElementById('quran-section');
    if (!quranSection) return;
    
    quranSection.innerHTML = surahs.map(surah => {
        const isBookmarked = bookmarks[surah.number];
        const isLastRead = lastReadAyah.surah === surah.number;
        
        return `
            <div class="surah-card" onclick="openSurah(${surah.number})">
                ${isBookmarked ? '<div class="bookmark-indicator">🔖</div>' : ''}
                ${isLastRead ? '<div class="last-read-indicator">📖</div>' : ''}
                <div class="surah-number">${surah.number}</div>
                <div class="surah-info">
                    <div class="surah-name">${surah.englishName} (${surah.name})</div>
                    <div class="surah-details">${surah.numberOfAyahs} аятов • ${surah.revelationType === 'Meccan' ? 'Мекканская' : 'Мединская'}</div>
                </div>
                <div class="surah-actions">
                    <button class="surah-action-btn" onclick="event.stopPropagation(); toggleBookmark(${surah.number})">🔖</button>
                    <button class="surah-action-btn" onclick="event.stopPropagation(); playSurahAudio(${surah.number})">🔊</button>
                </div>
            </div>
        `;
    }).join('');
}

        function loadFallbackQuranData() {
    const quranSection = document.getElementById('quran-section');
    if (!quranSection) return;
    
    const fallbackSurahs = [
        { number: 1, name: "الفاتحة", englishName: "Al-Fatihah", numberOfAyahs: 7, revelationType: "Meccan" },
        { number: 2, name: "البقرة", englishName: "Al-Baqarah", numberOfAyahs: 286, revelationType: "Medinan" },
        { number: 3, name: "آل عمران", englishName: "Ali 'Imran", numberOfAyahs: 200, revelationType: "Medinan" },
        { number: 4, name: "النساء", englishName: "An-Nisa", numberOfAyahs: 176, revelationType: "Medinan" },
        { number: 5, name: "المائدة", englishName: "Al-Ma'idah", numberOfAyahs: 120, revelationType: "Medinan" },
        { number: 6, name: "الأنعام", englishName: "Al-An'am", numberOfAyahs: 165, revelationType: "Meccan" },
        { number: 7, name: "الأعراف", englishName: "Al-A'raf", numberOfAyahs: 206, revelationType: "Meccan" },
        { number: 8, name: "الأنفال", englishName: "Al-Anfal", numberOfAyahs: 75, revelationType: "Medinan" },
        { number: 9, name: "التوبة", englishName: "At-Tawbah", numberOfAyahs: 129, revelationType: "Medinan" },
        { number: 10, name: "يونس", englishName: "Yunus", numberOfAyahs: 109, revelationType: "Meccan" }
    ];
    
    quranSection.innerHTML = fallbackSurahs.map(surah => {
        const isBookmarked = bookmarks[surah.number];
        const isLastRead = lastReadAyah.surah === surah.number;
        
        return `
            <div class="surah-card" onclick="openSurah(${surah.number})">
                ${isBookmarked ? '<div class="bookmark-indicator">🔖</div>' : ''}
                ${isLastRead ? '<div class="last-read-indicator">📖</div>' : ''}
                <div class="surah-number">${surah.number}</div>
                <div class="surah-info">
                    <div class="surah-name">${surah.englishName} (${surah.name})</div>
                    <div class="surah-details">${surah.numberOfAyahs} аятов • ${surah.revelationType === 'Meccan' ? 'Мекканская' : 'Мединская'}</div>
                </div>
                <div class="surah-actions">
                    <button class="surah-action-btn" onclick="event.stopPropagation(); toggleBookmark(${surah.number})">🔖</button>
                    <button class="surah-action-btn" onclick="event.stopPropagation(); playSurahAudio(${surah.number})">🔊</button>
                </div>
            </div>
        `;
    }).join('');
}

        // === ИСПРАВЛЕННАЯ ФУНКЦИЯ ОТКРЫТИЯ СУРЫ ===
async function openSurah(surahNumber) {
    const cacheKey = `surah_${surahNumber}`;
    
    // Проверяем кэш
    if (cache.quranData[cacheKey] && isCacheValid(cacheKey, 24 * 60)) {
        console.log('Загружаем суру из кэша');
        displaySurahContent(cache.quranData[cacheKey], surahNumber);
        return;
    }
    
    currentSurah = surahNumber;
    
    try {
        // Загружаем данные суры из API
        const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/editions/quran-uthmani,ru.kuliev`);
        const data = await response.json();
        
        if (data.code === 200) {
            const arabicEdition = data.data.find(edition => edition.edition.identifier === 'quran-uthmani');
            const translationEdition = data.data.find(edition => edition.edition.identifier === 'ru.kuliev');
            
            if (arabicEdition && translationEdition) {
                const surahData = {
                    arabic: arabicEdition,
                    translation: translationEdition,
                    timestamp: Date.now()
                };
                
                // Обновляем кэш
                cache.quranData[cacheKey] = surahData;
                updateCache('quranData', cache.quranData);
                
                displaySurahContent(surahData, surahNumber);
            } else {
                throw new Error('Не удалось загрузить текст суры');
            }
        } else {
            throw new Error('Не удалось загрузить данные суры');
        }
    } catch (error) {
        console.error('Ошибка загрузки суры:', error);
        
        // Пробуем загрузить из кэша
        if (cache.quranData[cacheKey]) {
            console.log('Используем устаревший кэш суры');
            displaySurahContent(cache.quranData[cacheKey], surahNumber);
            return;
        }
        
        showToast('Ошибка загрузки суры', 'error');
        // Показываем сообщение об ошибке
        const modalTitle = document.getElementById('surah-modal-title');
        const surahContent = document.getElementById('surah-content');
        
        if (modalTitle) modalTitle.textContent = 'Ошибка загрузки';
        if (surahContent) {
            surahContent.innerHTML = '<div style="text-align: center; padding: 2rem;">Не удалось загрузить суру. Пожалуйста, проверьте подключение к интернету.</div>';
        }
        
        const surahModal = document.getElementById('surah-modal');
        if (surahModal) surahModal.classList.add('active');
    }
}

        function displaySurahContent(surahData, surahNumber) {
    const surah = allSurahs.find(s => s.number === surahNumber);
    
    const modalTitle = document.getElementById('surah-modal-title');
    if (modalTitle) {
        modalTitle.textContent = surah ? `Сура ${surah.englishName} (${surah.name})` : `Сура ${surahNumber}`;
    }
    
    const surahContent = document.getElementById('surah-content');
    if (surahContent) {
        surahContent.innerHTML = '';
        
        // Добавляем тасмию отдельно (кроме суры Ат-Тауба)
        if (surahNumber !== 9) {
            const bismillah = document.createElement('div');
            bismillah.className = 'bismillah';
            bismillah.textContent = 'بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ';
            surahContent.appendChild(bismillah);
        }
        
        // Создаем контейнеры для каждого аята
        for (let i = 0; i < surahData.arabic.ayahs.length; i++) {
            const arabicAyah = surahData.arabic.ayahs[i];
            const translationAyah = surahData.translation.ayahs[i];
            
            const ayahContainer = document.createElement('div');
            ayahContainer.className = 'ayah-container';
            
            const isLastRead = lastReadAyah.surah === surahNumber && lastReadAyah.ayah === arabicAyah.numberInSurah;
            
            ayahContainer.innerHTML = `
                <div class="ayah-arabic" ${isLastRead ? 'style="border-right: 3px solid var(--accent-gold); padding-right: 10px;"' : ''}
                    onclick="playAyah(${arabicAyah.numberInSurah}, ${surahNumber})">
                    ${arabicAyah.text} <span class="ayah-number">${arabicAyah.numberInSurah}</span>
                </div>
                <div class="ayah-translation">
                    <strong>${arabicAyah.numberInSurah}.</strong> ${translationAyah.text}
                </div>
                <button class="nav-button" onclick="setLastReadAyah(${surahNumber}, ${arabicAyah.numberInSurah})" style="font-size: 0.8rem; padding: 0.5rem 1rem; margin-top: 0.5rem;">
                    Отметить как прочитанное
                </button>
            `;
            
            surahContent.appendChild(ayahContainer);
        }
    }
    
    // Обновляем навигацию
    const prevSurah = document.getElementById('prev-surah');
    const nextSurah = document.getElementById('next-surah');
    
    if (prevSurah) prevSurah.disabled = surahNumber <= 1;
    if (nextSurah) nextSurah.disabled = surahNumber >= (allSurahs.length || 114);
    
    // Применяем сохраненные настройки
    applyQuranReadingSettings();
    
    // Открываем модальное окно
    const surahModal = document.getElementById('surah-modal');
    if (surahModal) {
        surahModal.classList.add('active');
    }
    
    document.body.style.overflow = 'hidden';
}

        function applyQuranReadingSettings() {
            const modalContent = document.getElementById('modal-content');
            const toggleButton = document.getElementById('quranThemeToggle');
            
            if (modalContent && toggleButton) {
                if (quranReadingTheme === 'pleasant') {
                    modalContent.classList.add('quran-reading-theme');
                    toggleButton.textContent = 'Обычная тема';
                } else {
                    modalContent.classList.remove('quran-reading-theme');
                    toggleButton.textContent = 'Приятная тема';
                }
            }
            
            // Применяем сохраненный книжный режим
            const bookModeToggle = document.getElementById('bookModeToggle');
            const audioPlayer = document.getElementById('audio-player');
            const surahNavigation = document.querySelector('.surah-navigation');
            
            if (modalContent && bookModeToggle) {
                if (bookModeEnabled) {
                    modalContent.classList.add('book-mode');
                    bookModeToggle.textContent = 'Обычный режим';
                    if (audioPlayer) audioPlayer.style.display = 'none';
                    if (surahNavigation) surahNavigation.style.display = 'none';
                } else {
                    modalContent.classList.remove('book-mode');
                    bookModeToggle.textContent = 'Книжный режим';
                    if (audioPlayer) audioPlayer.style.display = 'flex';
                    if (surahNavigation) surahNavigation.style.display = 'flex';
                }
            }
        }

        function closeSurahModal() {
            const surahModal = document.getElementById('surah-modal');
            if (surahModal) {
                surahModal.classList.remove('active');
            }
            stopAudio();
            
            // ИСПРАВЛЕНИЕ: Восстанавливаем скроллинг
            document.body.style.overflow = '';
        }

        function navigateSurah(direction) {
            const newSurah = currentSurah + direction;
            if (newSurah >= 1 && newSurah <= allSurahs.length) {
                openSurah(newSurah);
            }
        }

        function toggleBookmark(surahNumber) {
            if (bookmarks[surahNumber]) {
                delete bookmarks[surahNumber];
                showToast(`Закладка для суры ${surahNumber} удалена`);
            } else {
                bookmarks[surahNumber] = true;
                showToast(`Супра ${surahNumber} добавлена в закладки`);
            }
            localStorage.setItem('quranBookmarks', JSON.stringify(bookmarks));
            loadQuranData(); // Перезагружаем список сур для обновления индикаторов
        }

        function setLastReadAyah(surahNumber, ayahNumber) {
            lastReadAyah = { surah: surahNumber, ayah: ayahNumber };
            localStorage.setItem('lastReadAyah', JSON.stringify(lastReadAyah));
            
            // Обновляем прогресс чтения Корана
            const surah = allSurahs.find(s => s.number === surahNumber);
            if (surah) {
                // Рассчитываем количество прочитанных аятов
                let readAyahs = 0;
                for (let i = 1; i < surahNumber; i++) {
                    const prevSurah = allSurahs.find(s => s.number === i);
                    if (prevSurah) {
                        readAyahs += prevSurah.numberOfAyahs;
                    }
                }
                readAyahs += ayahNumber;
                
                quranProgress.readAyahs = readAyahs;
                localStorage.setItem('quranProgress', JSON.stringify(quranProgress));
                updateQuranProgress();
            }
            
            showToast(`Отмечен аят ${ayahNumber} суры ${surahNumber} как прочитанный`);
            loadQuranData(); // Перезагружаем список сур для обновления индикаторов
            updateReadingProgress(); // Обновляем прогресс чтения
        }

        // === ФУНКЦИИ ДЛЯ КНИЖНОГО РЕЖИМА КОРАНА ===

        function openBookMode(surahNumber = null, pageNumber = 1) {
            currentPage = pageNumber;
            
            // ИСПРАВЛЕНИЕ: Определяем правильную страницу для суры Ан-Нас (114)
            if (surahNumber === 114) {
                // Сура Ан-Нас находится на странице 604
                currentPage = 604;
            } else if (surahNumber) {
                // Для других сур используем приблизительное определение
                // Здесь должна быть логика определения страницы по номеру суры
                // Для простоты используем приблизительные значения
                currentPage = Math.min(Math.max(1, surahNumber * 2), totalPages);
            }
            
            loadQuranPage(currentPage);
            const bookModal = document.getElementById('book-mode-modal');
            if (bookModal) {
                bookModal.classList.add('active');
            }
            document.body.style.overflow = 'hidden';
        }

        function closeBookModeModal() {
            const bookModal = document.getElementById('book-mode-modal');
            if (bookModal) {
                bookModal.classList.remove('active');
            }
            document.body.style.overflow = '';
        }

        async function loadQuranPage(pageNumber) {
            try {
                // Используем API для получения страницы Корана
                const response = await fetch(`https://api.alquran.cloud/v1/page/${pageNumber}/quran-uthmani`);
                const data = await response.json();
                
                if (data.code === 200) {
                    const pageData = data.data;
                    
                    // Обновляем заголовок
                    const modalTitle = document.getElementById('book-modal-title');
                    const pageNumberEl = document.getElementById('page-number');
                    
                    if (modalTitle) modalTitle.textContent = `Чтение Корана - Страница ${pageNumber}`;
                    if (pageNumberEl) pageNumberEl.textContent = `Страница ${pageNumber}`;
                    
                    // Отображаем аяты страницы
                    const pageContent = document.getElementById('book-page-content');
                    if (pageContent) {
                        pageContent.innerHTML = '';
                        
                        // Группируем аяты по строкам для правильного отображения
                        let currentLine = '';
                        let ayahsInLine = [];
                        
                        pageData.ayahs.forEach(ayah => {
                            const ayahText = ayah.text;
                            const ayahNumber = ayah.numberInSurah;
                            
                            // Добавляем аят к текущей строке
                            currentLine += `<span class="ayah">${ayahText}<span class="ayah-number">${ayahNumber}</span></span>`;
                            ayahsInLine.push(ayah.number);
                            
                            // Если строка заполнена или это последний аят, создаем новую строку
                            if (ayah.words && ayah.words[ayah.words.length - 1].lineEnd || 
                                ayah === pageData.ayahs[pageData.ayahs.length - 1]) {
                                
                                const lineDiv = document.createElement('div');
                                lineDiv.className = 'quran-line';
                                lineDiv.innerHTML = currentLine;
                                pageContent.appendChild(lineDiv);
                                
                                // Сбрасываем для следующей строки
                                currentLine = '';
                                ayahsInLine = [];
                            }
                        });
                    }
                    
                    // Обновляем навигацию
                    const prevPage = document.getElementById('prev-page');
                    const nextPage = document.getElementById('next-page');
                    
                    if (prevPage) prevPage.disabled = pageNumber <= 1;
                    if (nextPage) nextPage.disabled = pageNumber >= totalPages;
                    
                    // Применяем сохраненный размер шрифта
                    applyBookFontSize();
                    
                    // Обновляем состояние кнопки отметки страницы
                    updatePageMarkButton();
                    
                } else {
                    throw new Error('Не удалось загрузить страницу Корана');
                }
            } catch (error) {
                console.error('Ошибка загрузки страницы Корана:', error);
                showToast('Ошибка загрузки страницы Корана', 'error');
                // Запасной вариант - сообщение об ошибке
                const pageContent = document.getElementById('book-page-content');
                if (pageContent) {
                    pageContent.innerHTML = 
                        '<div style="text-align: center; padding: 2rem;">Не удалось загрузить страницу Корана. Пожалуйста, проверьте подключение к интернету.</div>';
                }
            }
        }

        function navigatePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadQuranPage(currentPage);
                
                // Обновляем прогресс чтения
                updateReadingProgressAfterPage();
            }
        }

        function updateReadingProgressAfterPage() {
            // Обновляем количество прочитанных страниц
            if (!userProgress.pagesReadHistory) {
                userProgress.pagesReadHistory = [];
            }
            
            // Добавляем страницу в историю, если ее там еще нет
            if (!userProgress.pagesReadHistory.includes(currentPage)) {
                userProgress.pagesReadHistory.push(currentPage);
                userProgress.pagesRead = userProgress.pagesReadHistory.length;
                
                // Сохраняем прогресс
                localStorage.setItem('userProgress', JSON.stringify(userProgress));
                
                // Обновляем отображение прогресса
                updateQuranProgressDisplay();
                
                // Проверяем выполнение требований уровней
                checkLevelRequirements();
            }
        }

        // === ФУНКЦИИ ДЛЯ ОТМЕТКИ СТРАНИЦ ===

        function togglePageMark() {
            const pageMarkButton = document.getElementById('page-mark-button');
            
            if (currentPageMarked) {
                // Убираем отметку
                markedPages = markedPages.filter(page => page !== currentPage);
                if (pageMarkButton) {
                    pageMarkButton.classList.remove('marked');
                    pageMarkButton.innerHTML = '<span>📌</span> Отметить страницу';
                }
                showToast('Страница удалена из отмеченных', 'warning');
            } else {
                // Добавляем отметку
                if (!markedPages.includes(currentPage)) {
                    markedPages.push(currentPage);
                }
                if (pageMarkButton) {
                    pageMarkButton.classList.add('marked');
                    pageMarkButton.innerHTML = '<span>✅</span> Страница отмечена';
                }
                showToast('Страница отмечена!', 'success');
                
                // ИСПРАВЛЕНИЕ: Автоматически отмечаем предыдущие страницы
                markPreviousPages(currentPage);
                
                // Обновляем статистику прочитанных страниц
                updateReadingProgressAfterPage();
            }
            
            currentPageMarked = !currentPageMarked;
            localStorage.setItem('markedPages', JSON.stringify(markedPages));
        }

        // ИСПРАВЛЕНИЕ: Функция для автоматической отметки предыдущих страниц
        function markPreviousPages(currentPage) {
            for (let i = 1; i < currentPage; i++) {
                if (!markedPages.includes(i)) {
                    markedPages.push(i);
                }
            }
            localStorage.setItem('markedPages', JSON.stringify(markedPages));
            
            // Обновляем статистику прочитанных страниц
            userProgress.pagesRead = markedPages.length;
            localStorage.setItem('userProgress', JSON.stringify(userProgress));
            
            // Обновляем отображение прогресса
            updateQuranProgressDisplay();
            
            // Проверяем требования уровней
            checkLevelRequirements();
            
            showToast(`Отмечены страницы 1-${currentPage}`, 'success');
        }

        function updatePageMarkButton() {
            const pageMarkButton = document.getElementById('page-mark-button');
            if (pageMarkButton) {
                currentPageMarked = markedPages.includes(currentPage);
                
                if (currentPageMarked) {
                    pageMarkButton.classList.add('marked');
                    pageMarkButton.innerHTML = '<span>✅</span> Страница отмечена';
                } else {
                    pageMarkButton.classList.remove('marked');
                    pageMarkButton.innerHTML = '<span>📌</span> Отметить страницу';
                }
            }
        }

        // === ИСПРАВЛЕННЫЕ АУДИО ФУНКЦИИ С НОВЫМ API ===

        // ИСПРАВЛЕННАЯ ФУНКЦИЯ ВОСПРОИЗВЕДЕНИЯ АЯТА
        async function playAyah(ayahNumber, surahNumber = currentSurah) {
            if (!audioInitialized) {
                showToast('Нажмите на аят еще раз для воспроизведения', 'warning');
                initializeAudio();
                return;
            }
            
            if (isPlaying && currentAyah === ayahNumber) {
                stopAudio();
                return;
            }
            
            stopAudio();
            currentAyah = ayahNumber;
            
            try {
                // Формируем URL для нового API
                const audioUrl = getAyahAudioUrl(surahNumber, ayahNumber);
                
                if (!audioUrl) {
                    throw new Error('Не удалось сформировать URL для аудио');
                }
                
                // Создаем аудио элемент
                currentAudio = new Audio();
                currentAudio.src = audioUrl;
                
                // Добавляем обработчики для PWA
                currentAudio.setAttribute('playsinline', '');
                currentAudio.setAttribute('webkit-playsinline', '');
                currentAudio.preload = 'auto';
                
                // Пытаемся воспроизвести
                const playPromise = currentAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        // Обновляем UI
                        const playBtn = document.getElementById('play-btn');
                        if (playBtn) {
                            playBtn.classList.add('playing');
                            playBtn.textContent = '⏸️';
                        }
                        isPlaying = true;
                        
                        // Подсвечиваем текущий аят
                        highlightCurrentAyah(ayahNumber);
                        
                        showToast('Воспроизведение аята...', 'success');
                    }).catch(error => {
                        console.error('Ошибка воспроизведения:', error);
                        showToast('Ошибка воспроизведения. Проверьте подключение к интернету', 'error');
                        stopAudio();
                    });
                }
                
                // Обработчики событий аудио
                currentAudio.addEventListener('ended', function() {
                    stopAudio();
                    showToast('Воспроизведение завершено', 'success');
                });
                
                currentAudio.addEventListener('error', function(e) {
                    console.error('Ошибка аудио:', e);
                    showToast('Ошибка загрузки аудио. Попробуйте другого чтеца', 'error');
                    stopAudio();
                });
                
                currentAudio.addEventListener('canplaythrough', function() {
                    console.log('Аудио готово к воспроизведению');
                });
                
            } catch (error) {
                console.error('Ошибка при воспроизведении аята:', error);
                showToast('Ошибка воспроизведения аята', 'error');
                stopAudio();
            }
        }

        // Функция для формирования URL аудио
        function getAyahAudioUrl(surahNumber, ayahNumber) {
            const reciter = RECITERS[currentReciter];
            if (!reciter) {
                console.error('Чтец не найден:', currentReciter);
                return null;
            }
            
            // Форматируем номера для URL (добавляем ведущие нули)
            const formattedSurah = surahNumber.toString().padStart(3, '0');
            const formattedAyah = ayahNumber.toString().padStart(3, '0');
            
            // Формируем URL в зависимости от чтеца
            return `${reciter.baseUrl}/${formattedSurah}${formattedAyah}.mp3`;
        }

        function playSurahAudio(surahNumber) {
            // Воспроизводим первый аят суры
            playAyah(1, surahNumber);
        }

        function toggleAudio() {
            if (isPlaying) {
                stopAudio();
            } else if (currentAyah) {
                playAyah(currentAyah, currentSurah);
            } else {
                showToast('Сначала выберите аят для воспроизведения', 'warning');
            }
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            isPlaying = false;
            const playBtn = document.getElementById('play-btn');
            if (playBtn) {
                playBtn.classList.remove('playing');
                playBtn.textContent = '▶️';
            }
            
            // Убираем подсветку с текущего аята
            removeAyahHighlight();
        }

        function highlightCurrentAyah(ayahNumber) {
            // Убираем предыдущую подсветку
            removeAyahHighlight();
            
            // Находим контейнер аята и добавляем класс подсветки
            const ayahContainers = document.querySelectorAll('.ayah-container');
            ayahContainers.forEach(container => {
                const ayahArabic = container.querySelector('.ayah-arabic');
                if (ayahArabic && ayahArabic.textContent.includes(ayahNumber)) {
                    container.classList.add('ayah-playing');
                }
            });
        }

        function removeAyahHighlight() {
            const highlightedAyahs = document.querySelectorAll('.ayah-playing');
            highlightedAyahs.forEach(ayah => {
                ayah.classList.remove('ayah-playing');
            });
        }

        // === ИСПРАВЛЕННАЯ ФУНКЦИЯ ЗАГРУЗКИ ВРЕМЕНИ НАМАЗОВ ===
        async function loadPrayerTimes() {
            const prayerList = document.getElementById('prayer-list');
            if (!prayerList) return;
            
            // Проверяем кэш
            const cacheKey = 'prayerTimes';
            if (cache.prayerTimes.data && isCacheValid(cacheKey, 60)) { // 1 час
                console.log('Загружаем время намазов из кэша');
                updatePrayerList(cache.prayerTimes.data);
                return;
            }
            
            prayerList.innerHTML = '<div class="loading">Загрузка времени намазов...</div>';
            
            try {
                // Получаем местоположение пользователя
                const position = await getCurrentPosition();
                const { latitude, longitude } = position.coords;
                
                // Используем API для получения времени намазов
                const today = new Date();
                const dateString = today.toISOString().split('T')[0];
                const response = await fetch(`https://api.aladhan.com/v1/timings/${dateString}?latitude=${latitude}&longitude=${longitude}&method=2`);
                const data = await response.json();
                
                if (data.code === 200) {
                    const timings = data.data.timings;
                    const prayerTimes = [
                        { name: 'Фаджр', time: timings.Fajr, icon: '🌅' },
                        { name: 'Восход', time: timings.Sunrise, icon: '☀️' },
                        { name: 'Зухр', time: timings.Dhuhr, icon: '☀️' },
                        { name: 'Аср', time: timings.Asr, icon: '⛅' },
                        { name: 'Магриб', time: timings.Maghrib, icon: '🌇' },
                        { name: 'Иша', time: timings.Isha, icon: '🌙' }
                    ];
                    
                    // Обновляем кэш
                    updateCache('prayerTimes', { data: prayerTimes, location: data.data.meta.timezone });
                    
                    updatePrayerList(prayerTimes);
                    
                    // Обновляем местоположение
                    const prayerLocation = document.getElementById('prayer-location');
                    if (prayerLocation) {
                        prayerLocation.textContent = data.data.meta.timezone;
                    }
                    
                } else {
                    throw new Error('Не удалось получить время намазов');
                }
            } catch (error) {
                console.error('Ошибка загрузки времени намазов:', error);
                
                // Пробуем загрузить из кэша
                if (cache.prayerTimes.data) {
                    console.log('Используем устаревший кэш времени намазов');
                    updatePrayerList(cache.prayerTimes.data);
                    
                    const prayerLocation = document.getElementById('prayer-location');
                    if (prayerLocation && cache.prayerTimes.location) {
                        prayerLocation.textContent = cache.prayerTimes.location;
                    }
                    return;
                }
                
                showToast('Используется время для Махачкалы', 'warning');
                loadFallbackPrayerTimes();
            }
        }

        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Геолокация не поддерживается'));
                }
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                });
            });
        }

        function loadFallbackPrayerTimes() {
            // Статические данные для Махачкалы
            const prayerTimes = [
                { name: 'Фаджр', time: '05:30', icon: '🌅' },
                { name: 'Восход', time: '07:15', icon: '☀️' },
                { name: 'Зухр', time: '12:30', icon: '☀️' },
                { name: 'Аср', time: '16:00', icon: '⛅' },
                { name: 'Магриб', time: '18:45', icon: '🌇' },
                { name: 'Иша', time: '20:15', icon: '🌙' }
            ];
            
            updatePrayerList(prayerTimes);
        }

        function updatePrayerList(prayerTimes) {
            const prayerList = document.getElementById('prayer-list');
            if (!prayerList) return;
            
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTime = currentHour * 60 + currentMinutes;
            
            prayerList.innerHTML = prayerTimes.map(prayer => {
                const [hours, minutes] = prayer.time.split(':').map(Number);
                const prayerTime = hours * 60 + minutes;
                
                const isActive = currentTime >= prayerTime && currentTime < prayerTime + 30; // Считаем активным в течение 30 минут
                const isCompleted = currentTime > prayerTime;
                
                return `
                    <div class="prayer-item ${isActive ? 'active' : ''}">
                        <div class="prayer-name">
                            <span>${prayer.icon}</span>
                            ${prayer.name}
                        </div>
                        <div class="prayer-time ${isCompleted ? 'prayer-completed' : ''}">
                            ${prayer.time}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadAzkarsData() {
            const duaSection = document.getElementById('dua-section');
            if (!duaSection) return;
            
            duaSection.innerHTML = `
                <div class="dua-category">
                    <h3 class="category-title">Утренние азкары</h3>
                    ${azkarsData.morning.map(dua => `
                        <div class="dua-card">
                            <div class="dua-arabic">${dua.arabic}</div>
                            <div class="dua-translation">${dua.translation}</div>
                            <div class="dua-source">${dua.source}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="dua-category">
                    <h3 class="category-title">Вечерние азкары</h3>
                    ${azkarsData.evening.map(dua => `
                        <div class="dua-card">
                            <div class="dua-arabic">${dua.arabic}</div>
                            <div class="dua-translation">${dua.translation}</div>
                            <div class="dua-source">${dua.source}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // === ФУНКЦИИ ДЛЯ СИСТЕМЫ УРОВНЕЙ ===

        function loadLevels() {
            const levelsContainer = document.getElementById('levels-container');
            const allLevelsContainer = document.getElementById('all-levels-container');
            
            if (levelsContainer) {
                levelsContainer.innerHTML = '';
                
                // Показываем только текущий и следующий уровни
                const currentLevelIndex = userProgress.currentLevel - 1;
                const levelsToShow = levelsData.slice(
                    Math.max(0, currentLevelIndex - 1), 
                    Math.min(levelsData.length, currentLevelIndex + 2)
                );
                
                levelsToShow.forEach(level => {
                    levelsContainer.appendChild(createLevelCard(level));
                });
            }
            
            if (allLevelsContainer) {
                allLevelsContainer.innerHTML = '';
                
                // Показываем все уровни
                levelsData.forEach(level => {
                    allLevelsContainer.appendChild(createLevelCard(level));
                });
            }
            
            // Обновляем отображение текущего уровня в профиле
            updateCurrentLevelDisplay();
        }

        function createLevelCard(level) {
            const levelCard = document.createElement('div');
            levelCard.className = `level-card level-${level.id} ${level.id === userProgress.currentLevel ? 'current' : ''} ${level.id > userProgress.currentLevel ? 'locked' : ''}`;
            
            // Добавляем эффект свечения для текущего уровня
            if (level.id === userProgress.currentLevel) {
                const glowElement = document.createElement('div');
                glowElement.className = 'level-glow';
                levelCard.appendChild(glowElement);
            }
            
            // Проверяем выполнение требований для этого уровня
            const requirementsStatus = checkLevelRequirementsStatus(level);
            const progress = calculateLevelProgress(level, requirementsStatus);
            
            levelCard.innerHTML = `
                <div class="level-header">
                    <div class="level-name">${level.icon} ${level.name}</div>
                    <div class="level-badge">Уровень ${level.id}</div>
                </div>
                <div class="level-description">${level.description}</div>
                ${level.id <= userProgress.currentLevel ? `
                    <div class="level-requirements">
                        ${level.requirements.map(req => {
                            const isCompleted = requirementsStatus.find(r => r.description === req.description)?.completed || false;
                            return `
                                <div class="requirement ${isCompleted ? 'completed' : ''}" 
                                     onclick="toggleLevelRequirement(${level.id}, '${req.description}')">
                                    ${isCompleted ? '✓' : '○'} ${req.description}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="level-progress">
                        <div class="level-progress-fill" style="width: ${progress}%"></div>
                    </div>
                    ${level.id === userProgress.currentLevel && progress === 100 ? 
                        `<button class="nav-button" style="margin-top: 1rem; width: 100%;" onclick="unlockNextLevel(${level.id})">
                            Разблокировать следующий уровень
                        </button>` : ''}
                ` : `
                    <div class="locked-overlay">
                        🔒 Уровень заблокирован
                    </div>
                `}
            `;
            
            return levelCard;
        }

        // ИСПРАВЛЕНИЕ: Функция для отметки выполнения отдельных требований уровня
        function toggleLevelRequirement(levelId, requirementDescription) {
            // Инициализируем хранилище требований, если его нет
            if (!userProgress.levelRequirements) {
                userProgress.levelRequirements = {};
            }
            
            // Инициализируем требования для уровня, если их нет
            if (!userProgress.levelRequirements[levelId]) {
                userProgress.levelRequirements[levelId] = {};
            }
            
            // Переключаем состояние требования
            const currentState = userProgress.levelRequirements[levelId][requirementDescription] || false;
            userProgress.levelRequirements[levelId][requirementDescription] = !currentState;
            
            // Сохраняем прогресс
            localStorage.setItem('userProgress', JSON.stringify(userProgress));
            
            // Обновляем отображение уровней
            loadLevels();
            
            // Показываем уведомление
            if (!currentState) {
                showToast('Требование выполнено!', 'success');
            } else {
                showToast('Требование отменено', 'warning');
            }
            
            // Проверяем, можно ли разблокировать следующий уровень
            checkLevelRequirements();
        }

        function checkLevelRequirementsStatus(level) {
            return level.requirements.map(req => {
                let completed = false;
                
                // Сначала проверяем ручную отметку требования
                if (userProgress.levelRequirements && 
                    userProgress.levelRequirements[level.id] && 
                    userProgress.levelRequirements[level.id][req.description]) {
                    completed = true;
                } else {
                    // Затем проверяем автоматическое выполнение
                    switch(req.type) {
                        case 'pages':
                            completed = userProgress.pagesRead >= req.target;
                            break;
                        case 'tasks':
                            completed = userProgress.tasksCompleted >= req.target;
                            break;
                        case 'azkar':
                            completed = userProgress.azkarMemorized >= req.target;
                            break;
                        case 'surah':
                            completed = userProgress.surahsMemorized >= req.target;
                            break;
                        case 'prayer':
                            completed = userProgress.prayersOnTime >= req.target;
                            break;
                        case 'fasting':
                            completed = userProgress.fastingDays >= req.target;
                            break;
                        case 'charity':
                            completed = userProgress.charityActs >= req.target;
                            break;
                        case 'companions':
                            completed = userProgress.companionsStudied >= req.target;
                            break;
                        case 'tajweed':
                            completed = userProgress.tajweedLearned;
                            break;
                        case 'sunnah':
                            completed = userProgress.sunnahImplemented >= req.target;
                            break;
                        case 'community':
                            completed = userProgress.communityHelped >= req.target;
                            break;
                        case 'teaching':
                            completed = userProgress.peopleTaught >= req.target;
                            break;
                        case 'article':
                            completed = userProgress.articlesWritten >= req.target;
                            break;
                        case 'tafsir':
                            completed = userProgress.tafsirStudied >= req.target;
                            break;
                        case 'fiqh':
                            completed = userProgress.fiqhLearned;
                            break;
                        case 'character':
                            completed = userProgress.characterImproved >= req.target;
                            break;
                        case 'service':
                            completed = userProgress.communityService >= req.target;
                            break;
                        case 'juz':
                            completed = userProgress.juzMemorized >= req.target;
                            break;
                        case 'leadership':
                            completed = userProgress.eventsLed >= req.target;
                            break;
                        case 'quran':
                            completed = userProgress.quranCompleted;
                            break;
                        case 'ramadan':
                            completed = userProgress.ramadanCompleted;
                            break;
                        case 'legacy':
                            completed = userProgress.legacyLeft;
                            break;
                    }
                }
                
                return {
                    ...req,
                    completed: completed
                };
            });
        }

        function calculateLevelProgress(level, requirementsStatus) {
            if (!requirementsStatus || requirementsStatus.length === 0) return 0;
            
            const completedCount = requirementsStatus.filter(req => req.completed).length;
            return (completedCount / requirementsStatus.length) * 100;
        }

        function checkLevelRequirements() {
            const currentLevel = levelsData[userProgress.currentLevel - 1];
            if (!currentLevel) return;
            
            const requirementsStatus = checkLevelRequirementsStatus(currentLevel);
            const progress = calculateLevelProgress(currentLevel, requirementsStatus);
            
            // Если все требования выполнены, предлагаем разблокировать следующий уровень
            if (progress === 100 && userProgress.currentLevel < levelsData.length) {
                showToast('Вы выполнили все требования текущего уровня!', 'success');
            }
            
            // Обновляем отображение уровней
            loadLevels();
        }

        function unlockNextLevel(currentLevelId) {
            if (currentLevelId >= levelsData.length) return;
            
            const nextLevel = levelsData[currentLevelId];
            userProgress.currentLevel = nextLevel.id;
            localStorage.setItem('userProgress', JSON.stringify(userProgress));
            
            // Показываем анимацию разблокировки
            showLevelUnlockAnimation(nextLevel);
            
            // Обновляем отображение
            loadLevels();
            
            // Применяем новую тему уровня
            applyLevelTheme();
        }

        function showLevelUnlockAnimation(level) {
            const animation = document.getElementById('level-unlock-animation');
            const levelName = document.getElementById('unlock-level-name');
            const levelDescription = document.getElementById('unlock-level-description');
            const levelDua = document.getElementById('unlock-level-dua');
            
            if (animation && levelName && levelDescription && levelDua) {
                levelName.textContent = `Уровень ${level.id} разблокирован: ${level.name}`;
                levelDescription.textContent = level.description;
                levelDua.textContent = level.dua;
                
                animation.classList.add('active');
                
                // Создаем конфетти
                createConfetti();
                
                // Добавляем дополнительные эффекты
                setTimeout(() => {
                    const levelCards = document.querySelectorAll('.level-card');
                    levelCards.forEach(card => {
                        if (parseInt(card.className.match(/level-(\d+)/)[1]) === level.id) {
                            card.classList.add('unlocking');
                        }
                    });
                }, 500);
            }
        }

        function closeLevelUnlock() {
            const animation = document.getElementById('level-unlock-animation');
            if (animation) {
                animation.classList.remove('active');
            }
            
            // Убираем класс анимации с карточек уровней
            const levelCards = document.querySelectorAll('.level-card');
            levelCards.forEach(card => {
                card.classList.remove('unlocking');
            });
        }

        function createConfetti() {
            const colors = ['#10B981', '#0EA5E9', '#8B5CF6', '#F59E0B', '#EF4444', '#EC4899', '#06B6D4', '#84CC16', '#F97316'];
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                
                document.body.appendChild(confetti);
                
                // Удаляем конфетти после анимации
                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }
        }

        function updateCurrentLevelDisplay() {
            const currentLevel = levelsData[userProgress.currentLevel - 1];
            if (!currentLevel) return;
            
            const levelIcon = document.getElementById('current-level-icon');
            const levelTitle = document.getElementById('current-level-title');
            const levelSubtitle = document.getElementById('current-level-subtitle');
            
            if (levelIcon) {
                levelIcon.textContent = currentLevel.icon;
                levelIcon.className = `level-icon level-${currentLevel.id}`;
            }
            if (levelTitle) levelTitle.textContent = currentLevel.name;
            if (levelSubtitle) levelSubtitle.textContent = `Уровень ${userProgress.currentLevel} из ${levelsData.length}`;
        }

        function updateQuranProgressDisplay() {
            const quranPages = document.getElementById('quranPages');
            if (quranPages) {
                quranPages.textContent = userProgress.pagesRead;
            }
        }

        function showAchievements() {
            showToast('Раздел "Достижения" находится в разработке!', 'warning');
        }

        // === ФУНКЦИИ ДЛЯ ТЕМ УРОВНЕЙ ===

        function applyLevelTheme() {
            const currentLevel = userProgress.currentLevel;
            const themeClass = `level-theme-${currentLevel}`;
            
            // Удаляем предыдущие темы
            document.body.classList.remove('level-theme-1', 'level-theme-2', 'level-theme-3', 'level-theme-4', 'level-theme-5', 
                                         'level-theme-6', 'level-theme-7', 'level-theme-8', 'level-theme-9', 'level-theme-10');
            
            // Применяем новую тему
            document.body.classList.add(themeClass);
            
            // Добавляем анимацию смены темы
            document.body.style.transition = 'all 0.5s ease';
            setTimeout(() => {
                document.body.style.transition = '';
            }, 500);
        }

        async function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('Service Worker зарегистрирован', registration);
                    
                    // ИСПРАВЛЕНИЕ: Автоматическое обновление PWA при изменении кода
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (newWorker) {
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Новый контент доступен, показываем уведомление
                                    showToast('Доступна новая версия приложения. Перезагрузите страницу для обновления.', 'warning');
                                }
                            });
                        }
                    });
                    
                    // Проверяем обновления каждые 24 часа
                    setInterval(() => {
                        registration.update();
                    }, 24 * 60 * 60 * 1000);
                    
                    // Подписка на push-уведомления
                    if ('PushManager' in window) {
                        const subscription = await registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: urlBase64ToUint8Array('BEl62iUYgUivxIkv69yViEuiBIa-Ib9-SkvMeAtA3LFgDzkrxZJjSgSnfckjBJuBkr3qBUYIHBQFLXYp5Nksh8U')
                        });
                        
                        console.log('Подписка на push-уведомления:', subscription);
                    }
                } catch (error) {
                    console.log('Ошибка регистрации Service Worker:', error);
                }
            }
        }

        // Вспомогательная функция для преобразования ключа
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showToast('Разрешение на уведомления получено');
                        setupNotifications();
                    }
                });
            } else if (Notification.permission === 'granted') {
                setupNotifications();
            }
        }

        function setupNotifications() {
            // Очищаем предыдущие интервалы
            if (notificationInterval) {
                clearInterval(notificationInterval);
            }
            
            // Проверяем включены ли уведомления
            const notificationsSwitch = document.getElementById('notificationsSwitch');
            if (!notificationsSwitch || !notificationsSwitch.checked) {
                return;
            }
            
            // Запускаем проверку уведомлений каждую минуту
            notificationInterval = setInterval(() => {
                checkPrayerNotifications();
                checkAzkarNotifications();
                checkAsrReminder();
                checkRamadanPreparationReminder();
            }, 60000); // Каждую минуту
            
            // Первоначальная проверка
            checkPrayerNotifications();
            checkAzkarNotifications();
            checkAsrReminder();
            checkRamadanPreparationReminder();
        }

        function checkPrayerNotifications() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTime = currentHour * 60 + currentMinutes;
            
            // Получаем время намазов
            const prayerItems = document.querySelectorAll('.prayer-item');
            prayerItems.forEach(item => {
                const prayerName = item.querySelector('.prayer-name').textContent.trim();
                const prayerTimeText = item.querySelector('.prayer-time').textContent;
                const [hours, minutes] = prayerTimeText.split(':').map(Number);
                const prayerTime = hours * 60 + minutes;
                
                // Уведомление за 15 минут до намаза
                if (currentTime >= prayerTime - 15 && currentTime < prayerTime - 14) {
                    showNotification(`Намаз ${prayerName} через 15 минут`, true);
                }
                
                // Уведомление о начале намаза
                if (currentTime >= prayerTime && currentTime < prayerTime + 1) {
                    showNotification(`Время намаза ${prayerName}`, true);
                }
            });
        }

        function checkAzkarNotifications() {
            const now = new Date();
            const currentHour = now.getHours();
            
            // Утренние азкары (6-8 утра)
            if (currentHour >= 6 && currentHour < 8) {
                showNotification('Время утренних азкаров', true);
            }
            
            // Вечерние азкары (18-20 вечера)
            if (currentHour >= 18 && currentHour < 20) {
                showNotification('Время вечерних азкаров', true);
            }
        }

        function checkAsrReminder() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTime = currentHour * 60 + currentMinutes;
            
            // Получаем время намаза Аср
            const asrItem = document.querySelector('.prayer-item:nth-child(4)'); // 4-й элемент - Аср
            if (asrItem) {
                const asrTimeText = asrItem.querySelector('.prayer-time').textContent;
                const [hours, minutes] = asrTimeText.split(':').map(Number);
                const asrTime = hours * 60 + minutes;
                
                // Напоминание о последнем часе Аср (за 1 час до Магриба)
                const maghribItem = document.querySelector('.prayer-item:nth-child(5)'); // 5-й элемент - Магриб
                if (maghribItem) {
                    const maghribTimeText = maghribItem.querySelector('.prayer-time').textContent;
                    const [maghribHours, maghribMinutes] = maghribTimeText.split(':').map(Number);
                    const maghribTime = maghribHours * 60 + maghribMinutes;
                    const lastHourAsr = maghribTime - 60;
                    
                    if (currentTime >= lastHourAsr && currentTime < lastHourAsr + 1 && !asrReminderSent) {
                        showNotification('Последний час намаза Аср! Постарайтесь совершить намаз вовремя', true);
                        asrReminderSent = true;
                    }
                }
            }
        }

        function checkRamadanPreparationReminder() {
            const now = new Date();
            const diff = RAMADAN_2026 - now;
            const daysLeft = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            // Напоминания о продолжении подготовки к Рамадану
            if (daysLeft === 30) {
                showNotification('До Рамадана остался 1 месяц! Продолжайте подготовку', true);
            } else if (daysLeft === 14) {
                showNotification('До Рамадана осталось 2 недели! Увеличьте усилия в подготовке', true);
            } else if (daysLeft === 7) {
                showNotification('До Рамадана осталась 1 неделя! Завершите все приготовления', true);
            } else if (daysLeft === 3) {
                showNotification('До Рамадана осталось 3 дня! Проверьте готовность к посту', true);
            } else if (daysLeft === 1) {
                showNotification('Завтра начинается Рамадан! Да поможет нам Аллах', true);
            }
        }

        // Запрос разрешения на уведомления при загрузке
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
</body>
</html>
