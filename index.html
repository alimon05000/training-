<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Тренировочный Календарь | AI-тренер</title>
    <meta name="description" content="Продвинутый фитнес-трекер с AI-тренером для планирования и отслеживания тренировок">
    <meta name="theme-color" content="#6366f1">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/icon-192.png">
    <link rel="apple-touch-icon" href="images/icon-192.png">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .onboarding-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(6px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }

        .onboarding-overlay.active {
            display: flex;
        }

        .onboarding-card {
            background: var(--surface);
            color: var(--text-primary);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 520px;
            width: 100%;
            border: 1px solid var(--border);
            box-shadow: 0 12px 32px var(--shadow-lg);
        }

        .onboarding-steps {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .onboarding-step {
            flex: 1;
            height: 6px;
            border-radius: 999px;
            background: var(--border);
        }

        .onboarding-step.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .install-hint {
            background: var(--surface-alt);
            border: 1px dashed var(--border);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
        }
        
        :root {
            /* Light theme */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --background: #ffffff;
            --surface: #f8fafc;
            --surface-alt: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-lg: rgba(0, 0, 0, 0.15);
            --calendar-train: #10b981;
            --calendar-rest: #8b5cf6;
            --calendar-cardio: #f59e0b;
            --calendar-home: #3b82f6;
            --success: #10b981;
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-dark: #6366f1;
            --secondary: #34d399;
            --danger: #f87171;
            --warning: #fbbf24;
            --info: #60a5fa;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-alt: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border: #475569;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-lg: rgba(0, 0, 0, 0.4);
            --calendar-train: #10b981;
            --calendar-rest: #a78bfa;
            --calendar-cardio: #f59e0b;
            --calendar-home: #60a5fa;
            --success: #34d399;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        button, input, select, textarea {
            touch-action: manipulation;
        }
        
        .app {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            backdrop-filter: blur(2px);
            z-index: 950;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 1.5rem;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            border-radius: 12px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
        }

        .nav-item:hover {
            background: var(--surface-alt);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item i {
            font-size: 1.25rem;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface-alt);
            padding: 0.5rem;
            border-radius: 12px;
            margin-top: auto;
        }

        .theme-btn {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
            user-select: none;
        }

        .theme-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Main Content */
        .main-content {
            padding: 1.5rem;
            overflow-y: auto;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .date-display {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            user-select: none;
            outline: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .btn-secondary {
            background: var(--surface-alt);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .card-actions .form-input {
            width: min(260px, 100%);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Calendar */
        .calendar {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day-header {
            text-align: center;
            padding: 0.5rem;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            user-select: none;
            font-weight: 500;
        }

        .calendar-day:hover {
            background: var(--surface-alt);
            border-color: var(--primary);
        }

        .calendar-day.trained {
            background: linear-gradient(135deg, var(--calendar-train), transparent);
        }

        .calendar-day.rest-day {
            background: linear-gradient(135deg, var(--calendar-rest), transparent);
        }

        .calendar-day.cardio {
            background: linear-gradient(135deg, var(--calendar-cardio), transparent);
        }

        .calendar-day.home {
            background: linear-gradient(135deg, var(--calendar-home), transparent);
        }

        .calendar-day.has-training::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
        }

        .calendar-day.today {
            border-color: var(--primary);
            font-weight: bold;
        }

        .calendar-day.other-month {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: var(--surface-alt);
            border-radius: 12px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Workout Session */
        .workout-session {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .exercise-item {
            background: var(--surface-alt);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .sets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .set-item {
            background: var(--background);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .set-item.active {
            border-color: var(--primary);
            background: var(--surface);
        }

        .set-input {
            width: 60px;
            padding: 0.25rem;
            text-align: center;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
        }

        /* Timer */
        .timer-display {
            font-size: 3rem;
            font-weight: 700;
            text-align: center;
            color: var(--primary);
            margin: 1rem 0;
            font-feature-settings: "tnum";
        }

        .timer-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .rest-timer {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-lg);
            z-index: 1000;
            display: none;
        }

        .rest-timer.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        /* AI Trainer */
        .ai-trainer-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .ai-message {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 12px;
            margin: 1rem 0;
        }

        .ai-chat {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .ai-message-bubble {
            background: var(--surface);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            max-width: 80%;
        }

        .ai-message-bubble.user {
            background: var(--primary);
            color: white;
            margin-left: auto;
        }

        /* Exercise Library */
        .exercise-library {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .exercise-card {
            background: var(--surface-alt);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .exercise-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .muscle-group-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* Progress Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--background);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px var(--shadow-lg);
        }

        .modal-large {
            max-width: 800px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--background);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
            flex-wrap: wrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-lg);
            z-index: 3000;
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
            color: white;
        }

        .toast.error {
            background: var(--danger);
            color: white;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--surface-alt);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .app {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: fixed;
                left: -280px;
                transition: left 0.3s ease;
                z-index: 1000;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 999;
                background: var(--primary);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 0.75rem;
                cursor: pointer;
            }
        }

        @media (max-width: 640px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                gap: 0.25rem;
            }
            
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
            
            .timer-display {
                font-size: 2rem;
            }
            
            .modal-content {
                padding: 1rem;
                width: 95%;
            }

            .card-actions {
                width: 100%;
                flex-direction: column;
                align-items: stretch;
            }

            .card-actions > * {
                width: 100%;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease forwards;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        .text-success {
            color: var(--success);
        }

        .text-danger {
            color: var(--danger);
        }

        .text-warning {
            color: var(--warning);
        }

        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .gap-3 { gap: 1.5rem; }
        .w-full { width: 100%; }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-alt);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay hidden" id="sidebarOverlay"></div>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">TC</div>
                <div class="logo-text">Тренировочный<br>Календарь</div>
            </div>
            
            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <i class="mdi mdi-view-dashboard"></i>
                    <span>Дашборд</span>
                </a>
                <a href="#" class="nav-item" data-page="calendar">
                    <i class="mdi mdi-calendar-month"></i>
                    <span>Календарь</span>
                </a>
                <a href="#" class="nav-item" data-page="workouts">
                    <i class="mdi mdi-dumbbell"></i>
                    <span>Тренировки</span>
                </a>
                <a href="#" class="nav-item" data-page="exercises">
                    <i class="mdi mdi-format-list-bulleted"></i>
                    <span>Упражнения</span>
                </a>
                <a href="#" class="nav-item" data-page="ai-trainer">
                    <i class="mdi mdi-robot"></i>
                    <span>AI-тренер</span>
                </a>
                <a href="#" class="nav-item" data-page="stats">
                    <i class="mdi mdi-chart-line"></i>
                    <span>Статистика</span>
                </a>
                <a href="#" class="nav-item" data-page="settings">
                    <i class="mdi mdi-cog"></i>
                    <span>Настройки</span>
                </a>
            </nav>
            
            <div class="theme-toggle">
                <div class="theme-btn active" data-theme="light">
                    <i class="mdi mdi-white-balance-sunny"></i>
                </div>
                <div class="theme-btn" data-theme="dark">
                    <i class="mdi mdi-moon-waning-crescent"></i>
                </div>
                <div class="theme-btn" data-theme="auto">
                    <i class="mdi mdi-theme-light-dark"></i>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="date-display" id="currentDate"></div>
                <div class="flex gap-2">
                    <button class="btn btn-secondary" id="quickWorkoutBtn">
                        <i class="mdi mdi-lightning-bolt"></i>
                        Быстрая тренировка
                    </button>
                    <button class="btn btn-primary" id="newWorkoutBtn">
                        <i class="mdi mdi-plus"></i>
                        Новая тренировка
                    </button>
                </div>
            </header>

            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page active">
                <div class="dashboard-grid">
                    <!-- Today's Workout -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Тренировка сегодня</h3>
                            <span class="mdi mdi-dumbbell" style="color: var(--primary);"></span>
                        </div>
                        <div id="todaysWorkout">
                            <p class="text-secondary mb-2">Нет запланированных тренировок</p>
                            <button class="btn btn-primary w-full" id="startTodayWorkoutBtn">
                                <i class="mdi mdi-play"></i>
                                Начать тренировку
                            </button>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Статистика недели</h3>
                            <span class="mdi mdi-chart-bar" style="color: var(--primary);"></span>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="weeklyWorkouts">0</div>
                                <div class="stat-label">Тренировок</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="weeklyVolume">0</div>
                                <div class="stat-label">Общий объём</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="weeklyTime">0</div>
                                <div class="stat-label">Минут</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Recommendations -->
                    <div class="ai-trainer-card">
                        <div class="card-header">
                            <h3 class="card-title" style="color: white;">AI-тренер</h3>
                            <span class="mdi mdi-robot" style="color: white;"></span>
                        </div>
                        <div class="ai-message">
                            <p id="aiRecommendation">Добро пожаловать! Начните первую тренировку, и я помогу вам прогрессировать.</p>
                        </div>
                        <button class="btn" style="background: white; color: var(--primary); width: 100%;" id="aiChatBtn">
                            <i class="mdi mdi-message-text"></i>
                            Спросить AI-тренера
                        </button>
                    </div>
                </div>

                <!-- Calendar Preview -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">Календарь тренировок</h3>
                        <button class="btn btn-secondary" id="viewCalendarBtn">
                            <i class="mdi mdi-arrow-right"></i>
                            Открыть календарь
                        </button>
                    </div>
                    <div id="calendarPreview"></div>
                </div>

                <!-- Recent Workouts -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">Последние тренировки</h3>
                        <button class="btn btn-small btn-secondary" id="viewAllWorkoutsBtn">
                            Все тренировки
                        </button>
                    </div>
                    <div id="recentWorkouts">
                        <p class="text-secondary">Пока нет завершённых тренировок</p>
                    </div>
                </div>
            </div>

            <!-- Calendar Page -->
            <div id="calendarPage" class="page hidden">
                <div class="calendar">
                    <div class="calendar-header">
                        <div class="flex items-center gap-2">
                            <button class="btn btn-secondary" id="prevMonth">
                                <i class="mdi mdi-chevron-left"></i>
                            </button>
                            <h2 id="currentMonth" class="text-2xl font-bold"></h2>
                            <button class="btn btn-secondary" id="nextMonth">
                                <i class="mdi mdi-chevron-right"></i>
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-secondary" id="todayBtn">
                                Сегодня
                            </button>
                            <button class="btn btn-primary" id="addToCalendarBtn">
                                <i class="mdi mdi-plus"></i>
                                Добавить тренировку
                            </button>
                        </div>
                    </div>
                    <div id="calendarContainer"></div>
                </div>
            </div>

            <!-- Workouts Page -->
            <div id="workoutsPage" class="page hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Мои тренировки</h3>
                        <div class="flex gap-2">
                            <button class="btn btn-secondary" id="importWorkoutBtn">
                                <i class="mdi mdi-import"></i>
                                Импорт
                            </button>
                            <button class="btn btn-primary" id="createTemplateBtn">
                                <i class="mdi mdi-plus"></i>
                                Новый шаблон
                            </button>
                        </div>
                    </div>
                    <div class="tabs">
                        <div class="tab active" data-tab="templates">Шаблоны</div>
                        <div class="tab" data-tab="history">История</div>
                        <div class="tab" data-tab="plans">Планы</div>
                    </div>
                    <div id="templatesList">
                        <!-- Templates will be loaded here -->
                    </div>
                    <div id="workoutsHistory" class="hidden">
                        <!-- History will be loaded here -->
                    </div>
                    <div id="workoutPlans" class="hidden">
                        <!-- Plans will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Exercises Page -->
            <div id="exercisesPage" class="page hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Библиотека упражнений</h3>
                        <div class="card-actions">
                            <input type="text" id="exerciseSearch" placeholder="Поиск упражнений..." class="form-input">
                            <button class="btn btn-primary" id="addCustomExerciseBtn">
                                <i class="mdi mdi-plus"></i>
                                Добавить своё
                            </button>
                        </div>
                    </div>
                    <div class="tabs mb-3">
                        <div class="tab active" data-muscle="all">Все</div>
                        <div class="tab" data-muscle="chest">Грудь</div>
                        <div class="tab" data-muscle="back">Спина</div>
                        <div class="tab" data-muscle="legs">Ноги</div>
                        <div class="tab" data-muscle="shoulders">Плечи</div>
                        <div class="tab" data-muscle="arms">Руки</div>
                        <div class="tab" data-muscle="core">Пресс</div>
                        <div class="tab" data-muscle="cardio">Кардио</div>
                    </div>
                    <div class="exercise-library" id="exerciseLibrary">
                        <!-- Exercises will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- AI Trainer Page -->
            <div id="aiTrainerPage" class="page hidden">
                <div class="ai-trainer-card mb-3">
                    <div class="card-header">
                        <h3 class="card-title" style="color: white;">Ваш персональный AI-тренер</h3>
                        <span class="mdi mdi-robot" style="color: white; font-size: 2rem;"></span>
                    </div>
                    <div class="ai-message">
                        <p id="aiMainRecommendation">Анализирую ваши тренировки... Начните первую тренировку для получения персональных рекомендаций.</p>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Рекомендации по прогрессу</h3>
                            <i class="mdi mdi-trending-up" style="color: var(--primary);"></i>
                        </div>
                        <div id="progressRecommendations">
                            <p class="text-secondary">Заполните данные тренировок для получения рекомендаций</p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">План на неделю</h3>
                            <i class="mdi mdi-calendar-week" style="color: var(--primary);"></i>
                        </div>
                        <div id="weeklyPlan">
                            <p class="text-secondary">AI создаст план после анализа ваших данных</p>
                        </div>
                        <button class="btn btn-primary w-full mt-2" id="generatePlanBtn">
                            <i class="mdi mdi-robot"></i>
                            Создать план
                        </button>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">Чат с AI-тренером</h3>
                    </div>
                    <div class="ai-chat" id="aiChat">
                        <div class="ai-message-bubble">
                            Привет! Я ваш AI-тренер. Спросите меня о тренировках, технике упражнений или получите рекомендации по прогрессу.
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="aiChatInput" placeholder="Задайте вопрос..." class="form-input" style="flex: 1;">
                        <button class="btn btn-primary" id="sendAiMessageBtn">
                            <i class="mdi mdi-send"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Page -->
            <div id="statsPage" class="page hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Статистика и прогресс</h3>
                        <select id="statsPeriod" class="form-input" style="width: 150px;">
                            <option value="week">Неделя</option>
                            <option value="month" selected>Месяц</option>
                            <option value="3months">3 месяца</option>
                            <option value="year">Год</option>
                            <option value="all">Всё время</option>
                        </select>
                    </div>
                    <div class="tabs mb-3">
                        <div class="tab active" data-stat="overview">Обзор</div>
                        <div class="tab" data-stat="exercises">Упражнения</div>
                        <div class="tab" data-stat="muscles">Группы мышц</div>
                        <div class="tab" data-stat="volume">Объём</div>
                    </div>
                    <div id="statsOverview" class="stats-overview">
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                        <div class="stats-grid mt-3">
                            <div class="stat-item">
                                <div class="stat-value" id="totalWorkouts">0</div>
                                <div class="stat-label">Всего тренировок</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="totalVolume">0</div>
                                <div class="stat-label">Общий объём (кг)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="avgWorkoutTime">0</div>
                                <div class="stat-label">Ср. время (мин)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="consistency">0%</div>
                                <div class="stat-label">Консистентность</div>
                            </div>
                        </div>
                    </div>
                    <div id="statsExercises" class="hidden">
                        <!-- Exercise stats will be loaded here -->
                    </div>
                    <div id="statsMuscles" class="hidden">
                        <!-- Muscle group stats will be loaded here -->
                    </div>
                    <div id="statsVolume" class="hidden">
                        <!-- Volume stats will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settingsPage" class="page hidden">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Настройки</h3>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Установка приложения</label>
                        <div class="flex gap-2">
                            <button class="btn btn-primary" id="installAppBtn">
                                <i class="mdi mdi-cellphone-arrow-down"></i>
                                Установить приложение
                            </button>
                            <div class="install-hint" style="flex:1;">
                                Добавьте на экран дома или установите на ПК для лучшего опыта.
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Единицы измерения</label>
                        <select id="weightUnit" class="form-input">
                            <option value="kg">Килограммы (кг)</option>
                            <option value="lbs">Фунты (lbs)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Таймер отдыха по умолчанию (сек)</label>
                        <input type="number" id="restTimerDefault" class="form-input" value="90" min="30" max="300">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Уведомления</label>
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="notificationsEnabled" class="form-input" style="width: auto;">
                            <span>Включить уведомления</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="reminderEnabled" class="form-input" style="width: auto;">
                            <span>Напоминания о тренировках</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Автосохранение</label>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="autoSave" class="form-input" style="width: auto;" checked>
                            <span>Автоматически сохранять данные</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Экспорт данных</label>
                        <div class="flex gap-2">
                            <button class="btn btn-secondary" id="exportDataBtn">
                                <i class="mdi mdi-export"></i>
                                Экспорт в JSON
                            </button>
                            <button class="btn btn-secondary" id="exportCSVBtn">
                                <i class="mdi mdi-file-excel"></i>
                                Экспорт в CSV
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Импорт данных</label>
                        <input type="file" id="importDataInput" class="form-input" accept=".json,.csv">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Сброс данных</label>
                        <button class="btn btn-danger" id="resetDataBtn">
                            <i class="mdi mdi-delete"></i>
                            Сбросить все данные
                        </button>
                    </div>
                </div>
            </div>

            <!-- Active Workout Session -->
            <div id="workoutSession" class="workout-session hidden">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h3 class="card-title" id="workoutTitle">Активная тренировка</h3>
                        <div class="flex items-center gap-2">
                            <div class="timer-display" id="workoutTimer">00:00</div>
                            <button class="btn btn-secondary" id="pauseWorkoutBtn">
                                <i class="mdi mdi-pause"></i>
                            </button>
                            <button class="btn btn-danger" id="endWorkoutBtn">
                                <i class="mdi mdi-stop"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="activeExercises">
                    <!-- Active exercises will be loaded here -->
                </div>
                
                <div class="flex gap-2 mt-3">
                    <button class="btn btn-secondary" id="addExerciseToWorkoutBtn">
                        <i class="mdi mdi-plus"></i>
                        Добавить упражнение
                    </button>
                    <button class="btn btn-primary" id="completeWorkoutBtn">
                        <i class="mdi mdi-check-all"></i>
                        Завершить тренировку
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div class="onboarding-overlay" id="onboarding">
        <div class="onboarding-card">
            <h3 class="card-title mb-2">Добро пожаловать!</h3>
            <p class="text-secondary" id="onboardingText">Планируйте тренировки через дашборд и календарь, а упражнения ищите во вкладке «Упражнения».</p>

            <div class="onboarding-steps">
                <div class="onboarding-step active" data-step="0"></div>
                <div class="onboarding-step" data-step="1"></div>
                <div class="onboarding-step" data-step="2"></div>
            </div>

            <div class="flex gap-2 mt-3">
                <button class="btn btn-secondary w-full" id="skipOnboardingBtn">Пропустить</button>
                <button class="btn btn-primary w-full" id="nextOnboardingBtn">Далее</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="newWorkoutModal">
        <div class="modal-content">
            <h3 class="mb-3">Новая тренировка</h3>
            <div class="form-group">
                <label class="form-label">Название тренировки</label>
                <input type="text" id="workoutName" class="form-input" placeholder="Например: День ног">
            </div>
            <div class="form-group">
                <label class="form-label">Тип тренировки</label>
                <select id="workoutType" class="form-input">
                    <option value="gym">Зал</option>
                    <option value="home">Домашняя</option>
                    <option value="cardio">Кардио</option>
                    <option value="recovery">Восстановление</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Использовать шаблон</label>
                <select id="workoutTemplate" class="form-input">
                    <option value="">Без шаблона</option>
                </select>
            </div>
            <div class="flex gap-2 mt-3">
                <button class="btn btn-secondary w-full" id="cancelWorkoutBtn">Отмена</button>
                <button class="btn btn-primary w-full" id="startWorkoutBtn">Начать</button>
            </div>
        </div>
    </div>

    <div class="modal" id="dayDetailModal">
        <div class="modal-content">
            <h3 id="dayDetailTitle" class="mb-3"></h3>
            <div id="dayWorkouts"></div>
            <button class="btn btn-primary w-full mt-2" id="addWorkoutToDayBtn">
                <i class="mdi mdi-plus"></i>
                Добавить тренировку
            </button>
        </div>
    </div>

    <div class="modal" id="exerciseDetailModal">
        <div class="modal-content modal-large">
            <h3 id="exerciseDetailTitle" class="mb-3"></h3>
            <div id="exerciseDetailContent"></div>
            <div class="flex gap-2 mt-3">
                <button class="btn btn-secondary w-full" id="closeExerciseDetailBtn">Закрыть</button>
                <button class="btn btn-primary w-full" id="addExerciseToCurrentBtn">Добавить в тренировку</button>
            </div>
        </div>
    </div>

    <div class="modal" id="customExerciseModal">
        <div class="modal-content modal-large">
            <h3 class="mb-3">Добавить своё упражнение</h3>
            <div class="form-group">
                <label class="form-label">Название</label>
                <input type="text" id="customExerciseName" class="form-input" placeholder="Например: Планка на локтях">
            </div>
            <div class="form-group">
                <label class="form-label">Описание</label>
                <textarea id="customExerciseDescription" class="form-input" rows="3" placeholder="Краткое описание техники выполнения"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Группа мышц</label>
                <select id="customExerciseMuscle" class="form-input">
                    <option value="chest">Грудь</option>
                    <option value="back">Спина</option>
                    <option value="legs">Ноги</option>
                    <option value="shoulders">Плечи</option>
                    <option value="arms">Руки</option>
                    <option value="core" selected>Пресс</option>
                    <option value="cardio">Кардио</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Оборудование</label>
                <select id="customExerciseEquipment" class="form-input">
                    <option value="bodyweight">Собственный вес</option>
                    <option value="dumbbell">Гантели</option>
                    <option value="barbell">Штанга</option>
                    <option value="machine">Тренажёр</option>
                    <option value="cable">Тросы</option>
                    <option value="cardio">Кардио</option>
                </select>
            </div>
            <div class="flex gap-2 mt-3">
                <button class="btn btn-secondary w-full" id="cancelCustomExerciseBtn">Отмена</button>
                <button class="btn btn-primary w-full" id="saveCustomExerciseBtn">Сохранить</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="createTemplateModal">
        <div class="modal-content modal-large">
            <h3 class="mb-3">Создать шаблон тренировки</h3>
            <div class="form-group">
                <label class="form-label">Название шаблона</label>
                <input type="text" id="templateName" class="form-input" placeholder="Например: Силовая тренировка груди">
            </div>
            <div class="form-group">
                <label class="form-label">Описание</label>
                <textarea id="templateDescription" class="form-input" rows="3" placeholder="Описание тренировки..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Добавить упражнения</label>
                <div class="flex gap-2 mb-2">
                    <select id="templateExerciseSelect" class="form-input" style="flex: 1;">
                        <!-- Exercises will be loaded here -->
                    </select>
                    <button class="btn btn-primary" id="addExerciseToTemplateBtn">
                        <i class="mdi mdi-plus"></i>
                    </button>
                </div>
                <div id="templateExercisesList"></div>
            </div>
            <div class="flex gap-2 mt-3">
                <button class="btn btn-secondary w-full" id="cancelTemplateBtn">Отмена</button>
                <button class="btn btn-primary w-full" id="saveTemplateBtn">Сохранить шаблон</button>
            </div>
        </div>
    </div>

    <div class="modal" id="setDetailModal">
        <div class="modal-content">
            <h3 id="setDetailTitle" class="mb-3"></h3>
            <div class="form-group">
                <label class="form-label">Вес (<span id="weightUnitLabel">кг</span>)</label>
                <input type="number" id="setWeight" class="form-input" step="0.5">
            </div>
            <div class="form-group">
                <label class="form-label">Повторения</label>
                <input type="number" id="setReps" class="form-input" min="1" max="50">
            </div>
            <div class="form-group">
                <label class="form-label">Время отдыха (сек)</label>
                <input type="number" id="setRest" class="form-input" value="90" min="30" max="300">
            </div>
            <div class="flex gap-2 mt-3">
                <button class="btn btn-secondary w-full" id="cancelSetBtn">Отмена</button>
                <button class="btn btn-primary w-full" id="saveSetBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Rest Timer -->
    <div class="rest-timer" id="restTimer">
        <div class="timer-display" style="font-size: 2rem;" id="restTimerDisplay">01:30</div>
        <div class="text-center mb-2">Отдых</div>
        <div class="timer-controls">
            <button class="btn btn-small btn-secondary" id="skipRestBtn">Пропустить</button>
            <button class="btn btn-small btn-success" id="startNextSetBtn">Начать подход</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn hidden" id="mobileMenuBtn">
        <i class="mdi mdi-menu"></i>
    </button>

    <script>
        // ==================== APP STATE ====================
        const AppState = {
            theme: localStorage.getItem('theme') || 'light',
            currentDate: new Date(),
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            activeWorkout: null,
            activeExercise: null,
            activeSetIndex: 0,
            isWorkoutActive: false,
            isRestTimerActive: false,
            workoutTimer: null,
            workoutSeconds: 0,
            restTimer: null,
            restSeconds: 0,
            defaultRestTime: parseInt(localStorage.getItem('restTimerDefault') || '90'),
            onboardingComplete: localStorage.getItem('onboardingComplete') === 'true',
            deferredInstallPrompt: null,
            currentMuscleFilter: 'all',
            templateBuilderExercises: [],
            
            // Data storage
            workouts: JSON.parse(localStorage.getItem('workouts')) || [],
            templates: JSON.parse(localStorage.getItem('templates')) || [],
            exercises: JSON.parse(localStorage.getItem('exercises')) || [],
            settings: JSON.parse(localStorage.getItem('settings')) || {
                weightUnit: 'kg',
                notifications: true,
                reminders: true,
                autoSave: true
            },
            
            // AI State
            aiMessages: JSON.parse(localStorage.getItem('aiMessages')) || [],
            aiRecommendations: [],
            
            // Initialize with zero stats
            stats: {
                totalWorkouts: 0,
                totalVolume: 0,
                totalTime: 0,
                consistency: 0,
                muscleGroups: {},
                exerciseProgress: {}
            }
        };

        // ==================== EXERCISE LIBRARY ====================
        const ExerciseLibrary = {
            exercises: [
                // Chest
                {
                    id: 'bench-press',
                    name: 'Жим штанги лёжа',
                    description: 'Базовое упражнение для развития грудных мышц. Лягте на скамью, возьмите штангу на ширине плеч, опустите к груди и выжмите вверх.',
                    muscleGroup: 'chest',
                    secondaryMuscles: ['triceps', 'shoulders'],
                    equipment: 'barbell',
                    image: null
                },
                {
                    id: 'incline-press',
                    name: 'Жим штанги на наклонной скамье',
                    description: 'Упражнение для верхней части грудных мышц.',
                    muscleGroup: 'chest',
                    secondaryMuscles: ['shoulders', 'triceps'],
                    equipment: 'barbell',
                    image: null
                },
                {
                    id: 'dumbbell-fly',
                    name: 'Разведение гантелей лёжа',
                    description: 'Изолирующее упражнение для растяжки грудных мышц.',
                    muscleGroup: 'chest',
                    secondaryMuscles: [],
                    equipment: 'dumbbell',
                    image: null
                },

                {
                    id: 'push-ups',
                    name: 'Отжимания',
                    description: 'Классическое упражнение с весом собственного тела для грудных, трицепсов и плеч.',
                    muscleGroup: 'chest',
                    secondaryMuscles: ['triceps', 'shoulders'],
                    equipment: 'bodyweight',
                    image: null
                },
                { 
                    id: 'cable-crossover',
                    name: 'Сведение рук в кроссовере',
                    description: 'Изоляция грудных мышц с постоянным натяжением тросов.',
                    muscleGroup: 'chest',
                    secondaryMuscles: ['shoulders'],
                    equipment: 'cable',
                    image: null
                },
                {
                    id: 'push-up-ring',
                    name: 'Отжимания на кольцах',
                    description: 'Усложнённый вариант отжиманий с акцентом на стабилизацию корпуса и плеч.',
                    muscleGroup: 'chest',
                    secondaryMuscles: ['shoulders', 'core'],
                    equipment: 'bodyweight',
                    image: null
                },
                
                // Back
                {
                    id: 'deadlift',
                    name: 'Становая тяга',
                    description: 'Базовое упражнение для развития спины и ног.',
                    muscleGroup: 'back',
                    secondaryMuscles: ['legs', 'core'],
                    equipment: 'barbell',
                    image: null
                },
                {
                    id: 'pull-ups',
                    name: 'Подтягивания',
                    description: 'Упражнение для развития широчайших мышц спины.',
                    muscleGroup: 'back',
                    secondaryMuscles: ['biceps'],
                    equipment: 'bodyweight',
                    image: null
                },
                {
                    id: 'bent-over-row',
                    name: 'Тяга штанги в наклоне',
                    description: 'Упражнение для толщины спины.',
                    muscleGroup: 'back',
                    secondaryMuscles: ['biceps'],
                    equipment: 'barbell',
                    image: null
                },

                {
                    id: 'lat-pulldown',
                    name: 'Тяга верхнего блока',
                    description: 'Тренировка широчайших мышц с возможностью регулировать нагрузку.',
                    muscleGroup: 'back',
                    secondaryMuscles: ['biceps'],
                    equipment: 'machine',
                    image: null
                },
                {
                    id: 'seated-row',
                    name: 'Тяга горизонтального блока',
                    description: 'Упражнение для средней части спины и задней дельты.',
                    muscleGroup: 'back',
                    secondaryMuscles: ['biceps', 'shoulders'],
                    equipment: 'machine',
                    image: null
                },
                {
                    id: 'face-pull',
                    name: 'Тяга к лицу',
                    description: 'Укрепляет верхнюю часть спины, задние дельты и улучшает осанку.',
                    muscleGroup: 'back',
                    secondaryMuscles: ['shoulders'],
                    equipment: 'cable',
                    image: null
                },
                {
                    id: 't-bar-row',
                    name: 'Тяга T-грифа',
                    description: 'Многосуставное упражнение для толщины спины с акцентом на середину траектории.',
                    muscleGroup: 'back',
                    secondaryMuscles: ['biceps', 'rear delts'],
                    equipment: 'machine',
                    image: null
                },
                
                // Legs
                {
                    id: 'squat',
                    name: 'Приседания со штангой',
                    description: 'Базовое упражнение для развития ног.',
                    muscleGroup: 'legs',
                    secondaryMuscles: ['core', 'back'],
                    equipment: 'barbell',
                    image: null
                },
                {
                    id: 'leg-press',
                    name: 'Жим ногами',
                    description: 'Упражнение для квадрицепсов.',
                    muscleGroup: 'legs',
                    secondaryMuscles: [],
                    equipment: 'machine',
                    image: null
                },
                {
                    id: 'lunges',
                    name: 'Выпады',
                    description: 'Упражнение для ног и ягодиц.',
                    muscleGroup: 'legs',
                    secondaryMuscles: ['glutes'],
                    equipment: 'dumbbell',
                    image: null
                },

                {
                    id: 'romanian-deadlift',
                    name: 'Румынская тяга',
                    description: 'Отлично нагружает заднюю поверхность бедра и ягодицы.',
                    muscleGroup: 'legs',
                    secondaryMuscles: ['glutes', 'back'],
                    equipment: 'barbell',
                    image: null
                },
                {
                    id: 'hip-thrust',
                    name: 'Ягодичный мост',
                    description: 'Изолирует ягодицы и помогает улучшить силу задней цепи.',
                    muscleGroup: 'legs',
                    secondaryMuscles: ['core'],
                    equipment: 'barbell',
                    image: null
                },
                {
                    id: 'calf-raise',
                    name: 'Подъёмы на носки',
                    description: 'Упражнение на икроножные мышцы, выполняется стоя или сидя.',
                    muscleGroup: 'legs',
                    secondaryMuscles: [],
                    equipment: 'machine',
                    image: null
                },
                {
                    id: 'pistol-squat',
                    name: 'Пистолетик',
                    description: 'Одноногий присед для развития баланса, силы ног и мобильности тазобедренных суставов.',
                    muscleGroup: 'legs',
                    secondaryMuscles: ['core', 'glutes'],
                    equipment: 'bodyweight',
                    image: null
                },
                {
                    id: 'step-up',
                    name: 'Подъём на тумбу',
                    description: 'Функциональное упражнение для квадрицепсов и ягодиц, можно выполнять с гантелями.',
                    muscleGroup: 'legs',
                    secondaryMuscles: ['glutes', 'core'],
                    equipment: 'dumbbell',
                    image: null
                },
                
                // Shoulders
                {
                    id: 'overhead-press',
                    name: 'Жим штанги стоя',
                    description: 'Базовое упражнение для плеч.',
                    muscleGroup: 'shoulders',
                    secondaryMuscles: ['triceps'],
                    equipment: 'barbell',
                    image: null
                },
                {
                    id: 'lateral-raises',
                    name: 'Подъём гантелей в стороны',
                    description: 'Изолирующее упражнение для средних дельт.',
                    muscleGroup: 'shoulders',
                    secondaryMuscles: [],
                    equipment: 'dumbbell',
                    image: null
                },

                {
                    id: 'arnold-press',
                    name: 'Жим Арнольда',
                    description: 'Вариация жима гантелей с разворотом кистей для полной проработки дельт.',
                    muscleGroup: 'shoulders',
                    secondaryMuscles: ['triceps'],
                    equipment: 'dumbbell',
                    image: null
                },
                {
                    id: 'rear-delt-fly',
                    name: 'Разведение гантелей в наклоне',
                    description: 'Изолирует задние дельты и улучшает баланс плечевого пояса.',
                    muscleGroup: 'shoulders',
                    secondaryMuscles: ['back'],
                    equipment: 'dumbbell',
                    image: null
                },
                {
                    id: 'upright-row',
                    name: 'Тяга к подбородку',
                    description: 'Комплексное упражнение для плеч и трапеций.',
                    muscleGroup: 'shoulders',
                    secondaryMuscles: ['arms'],
                    equipment: 'barbell',
                    image: null
                },
                {
                    id: 'landmine-press',
                    name: 'Жим штанги в стойке с упором',
                    description: 'Безопасный жим для передних дельт с дополнительной стабилизацией корпуса.',
                    muscleGroup: 'shoulders',
                    secondaryMuscles: ['triceps', 'core'],
                    equipment: 'barbell',
                    image: null
                },
                
                // Arms
                {
                    id: 'bicep-curl',
                    name: 'Сгибания рук со штангой',
                    description: 'Упражнение для бицепса.',
                    muscleGroup: 'arms',
                    secondaryMuscles: [],
                    equipment: 'barbell',
                    image: null
                },
                {
                    id: 'tricep-extension',
                    name: 'Разгибания на трицепс',
                    description: 'Упражнение для трицепса.',
                    muscleGroup: 'arms',
                    secondaryMuscles: [],
                    equipment: 'cable',
                    image: null
                },

                {
                    id: 'hammer-curl',
                    name: 'Молотковые сгибания',
                    description: 'Прорабатывают брахиалис и предплечья, увеличивая общую силу рук.',
                    muscleGroup: 'arms',
                    secondaryMuscles: ['forearms'],
                    equipment: 'dumbbell',
                    image: null
                },
                {
                    id: 'dips',
                    name: 'Отжимания на брусьях',
                    description: 'Многосуставное упражнение для трицепсов, груди и передних дельт.',
                    muscleGroup: 'arms',
                    secondaryMuscles: ['chest', 'shoulders'],
                    equipment: 'bodyweight',
                    image: null
                },
                {
                    id: 'skullcrusher',
                    name: 'Французский жим лёжа',
                    description: 'Изолирующее упражнение для трицепса с EZ-грифом или гантелями.',
                    muscleGroup: 'arms',
                    secondaryMuscles: [],
                    equipment: 'barbell',
                    image: null
                },
                {
                    id: 'rope-pushdown',
                    name: 'Разгибания на блоке с канатом',
                    description: 'Контролируемое движение для изоляции латеральной головки трицепса.',
                    muscleGroup: 'arms',
                    secondaryMuscles: ['shoulders'],
                    equipment: 'cable',
                    image: null
                },
                
                // Core
                {
                    id: 'plank',
                    name: 'Планка',
                    description: 'Упражнение для укрепления корпуса.',
                    muscleGroup: 'core',
                    secondaryMuscles: [],
                    equipment: 'bodyweight',
                    image: null
                },

                {
                    id: 'hanging-leg-raise',
                    name: 'Подъём ног в висе',
                    description: 'Укрепляет прямые и косые мышцы живота, развивает хват.',
                    muscleGroup: 'core',
                    secondaryMuscles: ['grip'],
                    equipment: 'bodyweight',
                    image: null
                },
                {
                    id: 'russian-twist',
                    name: 'Русский твист',
                    description: 'Динамическое упражнение для косых мышц живота и корпуса.',
                    muscleGroup: 'core',
                    secondaryMuscles: ['hips'],
                    equipment: 'bodyweight',
                    image: null
                },
                {
                    id: 'back-extension',
                    name: 'Гиперэкстензия',
                    description: 'Укрепляет разгибатели спины и ягодицы, помогает улучшить осанку.',
                    muscleGroup: 'core',
                    secondaryMuscles: ['glutes'],
                    equipment: 'machine',
                    image: null
                },
                {
                    id: 'pallof-press',
                    name: 'Пресс Паллова',
                    description: 'Антиротационное упражнение для стабильности корпуса и защиты поясницы.',
                    muscleGroup: 'core',
                    secondaryMuscles: ['shoulders'],
                    equipment: 'cable',
                    image: null
                },
                
                {
                    id: 'crunches',
                    name: 'Скручивания',
                    description: 'Базовое упражнение для проработки прямых мышц живота.',
                    muscleGroup: 'core',
                    secondaryMuscles: [],
                    equipment: 'bodyweight',
                    image: null
                },
                
                // Cardio
                {
                    id: 'treadmill-run',
                    name: 'Беговая дорожка',
                    description: 'Кардио-тренировка для выносливости и контроля веса.',
                    muscleGroup: 'cardio',
                    secondaryMuscles: ['legs'],
                    equipment: 'machine',
                    image: null
                },
                {
                    id: 'rowing',
                    name: 'Гребной тренажёр',
                    description: 'Низкоударное кардио с равномерной нагрузкой на все тело.',
                    muscleGroup: 'cardio',
                    secondaryMuscles: ['back', 'legs', 'arms'],
                    equipment: 'machine',
                    image: null
                },
                {
                    id: 'jump-rope',
                    name: 'Прыжки на скакалке',
                    description: 'Быстрый способ разогреться и повысить ЧСС в любом месте.',
                    muscleGroup: 'cardio',
                    secondaryMuscles: ['legs'],
                    equipment: 'bodyweight',
                    image: null
                },
                {
                    id: 'cycling',
                    name: 'Велотренажёр',
                    description: 'Кардио-нагрузка с бережным воздействием на суставы.',
                    muscleGroup: 'cardio',
                    secondaryMuscles: ['legs'],
                    equipment: 'machine',
                    image: null
                },
                {
                    id: 'sled-push',
                    name: 'Толкание санок',
                    description: 'Функциональное кардио с силовой нагрузкой на ноги и стабилизацией корпуса.',
                    muscleGroup: 'cardio',
                    secondaryMuscles: ['legs', 'core'],
                    equipment: 'machine',
                    image: null
                }
            ]
        };

        // ==================== AI TRAINER ====================
        const AITrainer = {
            getMuscleFrequency: function(days = 7) {
                const since = Date.now() - days * 24 * 60 * 60 * 1000;
                const frequency = {};

                AppState.workouts
                    .filter(workout => new Date(workout.date).getTime() >= since)
                    .forEach(workout => {
                        const muscles = new Set();
                        workout.exercises?.forEach(exercise => {
                            if (exercise.muscleGroup) {
                                muscles.add(exercise.muscleGroup);
                            }
                        });
                        muscles.forEach(muscle => {
                            frequency[muscle] = (frequency[muscle] || 0) + 1;
                        });
                    });

                return frequency;
            },

            getNextFocusMuscle: function() {
                const frequency = this.getMuscleFrequency();
                const muscleOrder = ['chest', 'back', 'legs', 'shoulders', 'arms', 'core', 'cardio'];

                // Avoid repeating the same muscle as the last workout if possible
                const lastWorkout = AppState.workouts[AppState.workouts.length - 1];
                const lastMuscle = lastWorkout?.exercises?.[0]?.muscleGroup;

                const sorted = muscleOrder.sort((a, b) => {
                    const diff = (frequency[a] || 0) - (frequency[b] || 0);
                    if (diff === 0 && lastMuscle) {
                        return a === lastMuscle ? 1 : b === lastMuscle ? -1 : 0;
                    }
                    return diff;
                });

                return sorted[0] || 'chest';
            },

            pickExercises: function(muscleGroup, count = 3) {
                const pool = [...ExerciseLibrary.exercises, ...AppState.exercises]
                    .filter(ex => ex.muscleGroup === muscleGroup);

                if (pool.length === 0) return [];

                return [...pool]
                    .sort(() => Math.random() - 0.5)
                    .slice(0, Math.min(count, pool.length));
            },

            createExerciseSets: function(exercises) {
                return exercises.map(exercise => ({
                    name: exercise.name,
                    muscleGroup: exercise.muscleGroup,
                    secondaryMuscles: exercise.secondaryMuscles,
                    sets: Array.from({ length: 3 }, () => ({ weight: 0, reps: 10, completed: false })),
                    targetSets: 3
                }));
            },
            getRecommendation: function() {
                const workouts = AppState.workouts;
                if (workouts.length === 0) {
                    return "Добро пожаловать! Начните первую тренировку, и я помогу вам прогрессировать.";
                }
                
                const lastWorkout = workouts[workouts.length - 1];
                const daysFromLast = Math.floor((Date.now() - new Date(lastWorkout.date).getTime()) / (1000 * 60 * 60 * 24));
                const progress = this.analyzeProgress();
                const focus = this.getNextFocusMuscle();

                if (daysFromLast >= 3) {
                    return `Пора вернуться в зал! Начните с ${UI.getMuscleGroupName(focus)} и лёгкого разогрева.`;
                }
                
                if (progress.stagnant.length > 0) {
                    return `Замечаю плато в упражнении ${progress.stagnant[0]}. Снизьте вес на 10% и сосредоточьтесь на технике.`;
                }

                if (progress.improving.length > 0) {
                    return `Отлично растёте в ${progress.improving[0]}! Добавьте +1 подход для закрепления результата.`;
                }

                return `Сегодня в приоритете ${UI.getMuscleGroupName(focus)}. Подберите 3 упражнения и держите отдых 60-90 секунд.`;
            },
            
            analyzeProgress: function() {
                const workouts = AppState.workouts;
                if (workouts.length < 3) {
                    return { stagnant: [], improving: [] };
                }
                
                
                const exerciseProgress = {};
                
                workouts.forEach(workout => {
                    workout.exercises?.forEach(exercise => {
                        if (!exerciseProgress[exercise.name]) {
                            exerciseProgress[exercise.name] = [];
                        }
                        const maxWeight = Math.max(...exercise.sets.map(set => set.weight || 0));
                        exerciseProgress[exercise.name].push(maxWeight);
                    });
                });
                
                const stagnant = [];
                const improving = [];
                
                Object.entries(exerciseProgress).forEach(([exercise, weights]) => {
                    if (weights.length < 3) return;
                    
                    const recentAvg = weights.slice(-3).reduce((a, b) => a + b, 0) / 3;
                    const previousAvg = weights.slice(-6, -3).reduce((a, b) => a + b, 0) / 3 || recentAvg;
                    
                    if (recentAvg <= previousAvg * 1.02) {
                        stagnant.push(exercise);
                    } else {
                        improving.push(exercise);
                    }
                });
                
                return { stagnant, improving };
            },

            getProgressInsights: function() {
                const stats = AppState.stats;
                if (!stats.totalWorkouts) {
                    return ["Заполните первую тренировку, чтобы увидеть рекомендации."];
                }

                const insights = [];
                const mostWorked = Object.entries(stats.muscleGroups || {}).sort((a, b) => b[1] - a[1])[0];
                const leastWorked = Object.entries(stats.muscleGroups || {}).sort((a, b) => a[1] - b[1])[0];

                insights.push(`Консистентность: ${Math.round(stats.consistency || 0)}%. Поддерживайте не менее 3 тренировок в неделю.`);
                if (stats.totalVolume) {
                    insights.push(`Суммарный объём: ${Math.round(stats.totalVolume)} кг. Продолжайте прогрессию +2-5% каждую неделю.`);
                }
                if (mostWorked) {
                    insights.push(`Чаще всего тренируете: ${UI.getMuscleGroupName(mostWorked[0])}.`);
                }
                if (leastWorked) {
                    insights.push(`Добавьте больше нагрузки на: ${UI.getMuscleGroupName(leastWorked[0])}.`);
                }

                return insights;
            },
            
            generateWeeklyPlan: function() {
                const focusStart = this.getNextFocusMuscle();
                const baseSplit = ['chest', 'back', 'legs', 'shoulders', 'arms', 'cardio', 'core'];
                const rotatedSplit = [focusStart, ...baseSplit.filter(muscle => muscle !== focusStart)];
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

                const plan = {};
                days.forEach((day, index) => {
                    const muscleGroup = rotatedSplit[index % rotatedSplit.length];
                    const exercises = this.pickExercises(muscleGroup, 3).map(ex => ex.name);
                    plan[day] = {
                        muscleGroup: muscleGroup === 'cardio' ? 'Кардио / восстановление' : UI.getMuscleGroupName(muscleGroup),
                        exercises: exercises.length ? exercises : ['Лёгкая растяжка и ходьба 20 мин']
                    };
                });

                // Добавляем один день отдыха
                plan.wednesday = { muscleGroup: 'Восстановление', exercises: ['Растяжка 15 минут', 'Прогулка 30 минут'] };

                return plan;
            },

            getQuickWorkoutTemplate: function() {
                const focus = this.getNextFocusMuscle();
                const exercises = this.createExerciseSets(this.pickExercises(focus, 3));

                return {
                    name: `Быстрая тренировка: ${UI.getMuscleGroupName(focus)}`,
                    type: focus === 'cardio' ? 'cardio' : 'gym',
                    exercises
                };
            },
            
            chatResponse: function(message) {
                const lowerMessage = message.toLowerCase();
                
                const lastWorkout = AppState.workouts[AppState.workouts.length - 1];
                const lastMuscle = lastWorkout?.exercises?.[0]?.muscleGroup;
                const lastMuscleName = lastMuscle ? UI.getMuscleGroupName(lastMuscle) : null;
                const nextFocusName = UI.getMuscleGroupName(this.getNextFocusMuscle());
               const scriptedAnswers = [
                    {
                        keywords: ['привет', 'здравствуй', 'hello', 'хай'],
                        response: 'Привет! Я готов помочь с тренировками, питанием или восстановлением. Что интересно сегодня?'
                    },
                    {
                        keywords: ['прогресс', 'улучшить', 'застой', 'plateau'],
                        response: 'Чтобы выйти на новый уровень: 1) фиксируйте прогресс в подходах, 2) добавляйте по 2-5% нагрузки раз в неделю, 3) меняйте угол или темп движения каждые 4-6 недель.'
                    },
                    {
                        keywords: ['боль', 'травм', 'болит', 'растяжение'],
                        response: 'Сбавьте нагрузку и уделите время мобилизации. Если боль острая — приостановите тренировки и обратитесь к врачу. Упражнения без боли: планка, прогулка, легкая растяжка.'
                    },
                    {
                        keywords: ['вес', 'нагруз', 'увеличить вес'],
                        response: 'Увеличивайте вес, когда последний подход выполняется с запасом 1-2 повторения. Добавляйте 2.5-5 кг или 5-10% от текущего веса, сохраняя технику.'
                    },
                    {
                        keywords: ['сброс', 'похуд', 'жир'],
                        response: 'Для снижения веса держите дефицит 300-500 ккал, 2-3 кардио-сессии в неделю и 7-9 часов сна. Шаги: 8-10 тысяч в день + достаточный белок.'
                    },
                    {
                        keywords: ['масса', 'набор', 'bulk'],
                        response: 'Для набора массы держите профицит 200-300 ккал, 1.6-2.2 г белка на кг и 3-4 силовые тренировки в неделю. Следите, чтобы вес рос медленно — 0.25-0.5 кг в неделю.'
                    },
                    {
                        keywords: ['отдых', 'восстановление', 'сон', 'перерыв'],
                        response: 'Отдых между подходами: 60-90 сек для гипертрофии, 2-3 мин для силы. Сон 7-9 часов, прогулки или растяжка в дни без зала.'
                    },
                    {
                        keywords: ['питание', 'диет', 'еда', 'калор'],
                        response: 'Сбалансируйте тарелку: белок в каждом приеме, сложные углеводы до тренировок, овощи и полезные жиры. Воды 30-40 мл на кг веса.'
                    },
                    {
                        keywords: ['размин', 'warm'],
                        response: '5-7 минут лёгкого кардио + суставная гимнастика. Перед рабочими весами делайте 1-2 разминочных подхода с меньшим весом.'
                    },
                    {
                        keywords: ['дом', 'дома', 'без зала', 'оборудование', 'инвентаря'],
                        response: 'Без зала подойдёт круг: приседания, отжимания, тяга эспандера/в наклоне, планка. 3 круга по 12-15 повторений, отдых 60 секунд.'
                    },
                    {
                        keywords: ['нет времени', 'спешу', 'быстро'],
                        response: 'Быстрый план на 15 минут: 1) приседания 2×12, 2) отжимания 2×8-12, 3) планка 3×30 сек, 4) выпады 2×10 на ногу. Минимальный отдых — сердце разгонится.'
                    }
                ];

                 const matched = scriptedAnswers.find(item => item.keywords.some(k => lowerMessage.includes(k)));
                if (matched) return matched.response;

                if (lowerMessage.includes('?')) {
                    return 'Я могу помочь с программой, питанием, восстановлением и техникой. Уточните цель (сила, масса, снижение веса или выносливость), и предложу конкретный план.';
                }
                
                const insights = [];
                if (lastMuscleName) {
                    insights.push(`В прошлый раз вы тренировали ${lastMuscleName.toLowerCase()}.`);
                }

                return insights.join(' ');
            }
        };

        // ==================== DATA STORAGE ====================
        const DataStorage = {
            save: function() {
                if (!AppState.settings.autoSave) return;
                
                try {
                    localStorage.setItem('workouts', JSON.stringify(AppState.workouts));
                    localStorage.setItem('templates', JSON.stringify(AppState.templates));
                    localStorage.setItem('exercises', JSON.stringify(AppState.exercises));
                    localStorage.setItem('settings', JSON.stringify(AppState.settings));
                    localStorage.setItem('theme', AppState.theme);
                    this.calculateStats();
                } catch (error) {
                    console.error('Error saving data:', error);
                    this.showToast('Ошибка сохранения данных', 'error');
                }
            },
            
            calculateStats: function() {
                const stats = {
                    totalWorkouts: AppState.workouts.length,
                    totalVolume: 0,
                    totalTime: 0,
                    consistency: 0,
                    muscleGroups: {},
                    exerciseProgress: {}
                };
                
                // Calculate total volume and time
                AppState.workouts.forEach(workout => {
                    stats.totalTime += workout.duration || 0;
                    
                    workout.exercises?.forEach(exercise => {
                        exercise.sets?.forEach(set => {
                            stats.totalVolume += (set.weight || 0) * (set.reps || 0);
                        });
                        
                        // Track muscle groups
                        const muscleGroup = exercise.muscleGroup || 'other';
                        if (!stats.muscleGroups[muscleGroup]) {
                            stats.muscleGroups[muscleGroup] = 0;
                        }
                        stats.muscleGroups[muscleGroup]++;
                        
                        // Track exercise progress
                        if (!stats.exerciseProgress[exercise.name]) {
                            stats.exerciseProgress[exercise.name] = [];
                        }
                        const maxWeight = Math.max(...exercise.sets.map(set => set.weight || 0));
                        stats.exerciseProgress[exercise.name].push({
                            date: workout.date,
                            weight: maxWeight,
                            reps: exercise.sets.reduce((sum, set) => sum + (set.reps || 0), 0) / exercise.sets.length
                        });
                    });
                });
                
                // Calculate consistency (workouts per week)
                if (AppState.workouts.length > 0) {
                    const firstDate = new Date(AppState.workouts[0].date);
                    const lastDate = new Date(AppState.workouts[AppState.workouts.length - 1].date);
                    const weeks = Math.max(1, (lastDate - firstDate) / (1000 * 60 * 60 * 24 * 7));
                    stats.consistency = Math.round((AppState.workouts.length / weeks) * 100) / 100;
                }
                
                AppState.stats = stats;
                return stats;
            },
            
            exportJSON: function() {
                const data = {
                    workouts: AppState.workouts,
                    templates: AppState.templates,
                    exercises: AppState.exercises,
                    settings: AppState.settings,
                    exported: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `training-calendar-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showToast('Данные экспортированы', 'success');
            },
            
            exportCSV: function() {
                let csv = 'Дата,Тренировка,Упражнение,Вес,Повторения,Объём\n';
                
                AppState.workouts.forEach(workout => {
                    workout.exercises?.forEach(exercise => {
                        exercise.sets?.forEach((set, index) => {
                            const volume = (set.weight || 0) * (set.reps || 0);
                            csv += `${workout.date},${workout.name},${exercise.name},${set.weight || 0},${set.reps || 0},${volume}\n`;
                        });
                    });
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `training-data-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showToast('Данные экспортированы в CSV', 'success');
            },
            
            importData: function(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.workouts) AppState.workouts = data.workouts;
                        if (data.templates) AppState.templates = data.templates;
                        if (data.exercises) AppState.exercises = data.exercises;
                        if (data.settings) AppState.settings = { ...AppState.settings, ...data.settings };
                        
                        this.save();
                        this.showToast('Данные импортированы', 'success');
                        location.reload();
                    } catch (error) {
                        this.showToast('Ошибка импорта данных', 'error');
                    }
                };
                reader.readAsText(file);
            },
            
            resetData: function() {
                if (confirm('Вы уверены? Все данные будут удалены без возможности восстановления.')) {
                    localStorage.clear();
                    AppState.workouts = [];
                    AppState.templates = [];
                    AppState.exercises = [];
                    this.showToast('Все данные сброшены', 'success');
                    location.reload();
                }
            },
            
            showToast: function(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'toast';
                toast.classList.add(type);
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        };

        // ==================== UI FUNCTIONS ====================
        const UI = {
            init: function() {
                this.setTheme(AppState.theme);
                this.updateDateDisplay();
                this.setupEventListeners();
                this.generateCalendar();
                this.generateCalendarPreview();
                this.updateTodaysWorkoutCard();
                this.loadExercises();
                this.loadExercises(AppState.currentMuscleFilter);
                this.loadTemplates();
                this.updateStats();
                this.setupServiceWorker();
                this.updateAIRecommendation();
                this.renderAiChat();
                this.prepareInstallPrompt();
                this.showOnboardingIfNeeded();
            },
            
            setTheme: function(theme) {
                if (theme === 'auto') {
                    theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                }
                document.documentElement.setAttribute('data-theme', theme);
                AppState.theme = theme;
                localStorage.setItem('theme', theme);
                
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.theme === theme) {
                        btn.classList.add('active');
                    }
                });
            },

            prepareInstallPrompt: function() {
                const installBtn = document.getElementById('installAppBtn');
                const updateInstallAvailability = () => {
                    installBtn.disabled = !AppState.deferredInstallPrompt;
                    installBtn.innerHTML = `<i class="mdi mdi-cellphone-arrow-down"></i> ${AppState.deferredInstallPrompt ? 'Установить приложение' : 'Установка недоступна'}`;
                };

                window.addEventListener('beforeinstallprompt', (event) => {
                    event.preventDefault();
                    AppState.deferredInstallPrompt = event;
                    updateInstallAvailability();
                    DataStorage.showToast('Приложение готово к установке', 'success');
                });

                window.addEventListener('appinstalled', () => {
                    AppState.deferredInstallPrompt = null;
                    updateInstallAvailability();
                    DataStorage.showToast('Приложение установлено!', 'success');
                });

                installBtn.addEventListener('click', async () => {
                    if (AppState.deferredInstallPrompt) {
                        AppState.deferredInstallPrompt.prompt();
                        const { outcome } = await AppState.deferredInstallPrompt.userChoice;
                        if (outcome === 'accepted') {
                            DataStorage.showToast('Спасибо за установку!', 'success');
                        }
                        AppState.deferredInstallPrompt = null;
                        updateInstallAvailability();
                    } else {
                        DataStorage.showToast('Если кнопка недоступна, добавьте страницу на экран дома через меню браузера', 'info');
                    }
                });

                updateInstallAvailability();
            },

            showOnboardingIfNeeded: function() {
                if (AppState.onboardingComplete) return;

                const steps = [
                    'Планируйте и смотрите тренировки через дашборд и календарь.',
                    'Открывайте вкладку «Упражнения», чтобы добавлять подходы прямо в активную сессию.',
                    'Используйте AI-тренера и сохранённые шаблоны для быстрого старта.',
                ];

                let currentStep = 0;
                const overlay = document.getElementById('onboarding');
                const text = document.getElementById('onboardingText');
                const stepsBars = overlay.querySelectorAll('.onboarding-step');
                const nextBtn = document.getElementById('nextOnboardingBtn');
                const skipBtn = document.getElementById('skipOnboardingBtn');

                const renderStep = () => {
                    text.textContent = steps[currentStep];
                    stepsBars.forEach((bar, index) => {
                        bar.classList.toggle('active', index <= currentStep);
                    });
                    nextBtn.textContent = currentStep === steps.length - 1 ? 'Начать' : 'Далее';
                };

                const finishOnboarding = () => {
                    AppState.onboardingComplete = true;
                    localStorage.setItem('onboardingComplete', 'true');
                    overlay.classList.remove('active');
                };

                nextBtn.addEventListener('click', () => {
                    if (currentStep < steps.length - 1) {
                        currentStep++;
                        renderStep();
                    } else {
                        finishOnboarding();
                    }
                });

                skipBtn.addEventListener('click', finishOnboarding);

                overlay.classList.add('active');
                renderStep();
            },
            
            updateDateDisplay: function() {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('currentDate').textContent = 
                    AppState.currentDate.toLocaleDateString('ru-RU', options);
            },
            
            generateCalendar: function() {
                const month = AppState.currentMonth;
                const year = AppState.currentYear;
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
                
                // Month header
                const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                                  'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
                document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
                
                // Calendar grid
                let calendarHTML = `
                    <div class="calendar-grid">
                    <div class="calendar-day-header">Пн</div>
                    <div class="calendar-day-header">Вт</div>
                    <div class="calendar-day-header">Ср</div>
                    <div class="calendar-day-header">Чт</div>
                    <div class="calendar-day-header">Пт</div>
                    <div class="calendar-day-header">Сб</div>
                    <div class="calendar-day-header">Вс</div>
                `;
                
                // Empty cells for start of month
                for (let i = 0; i < startDay; i++) {
                    calendarHTML += '<div class="calendar-day other-month"></div>';
                }
                
                // Days of month
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateStr = date.toISOString().split('T')[0];
                    const isToday = date.toDateString() === today.toDateString();
                    
                    // Check for workouts on this day
                    const dayWorkouts = AppState.workouts.filter(w => w.date === dateStr);
                    const hasWorkout = dayWorkouts.length > 0;
                    const workoutType = hasWorkout ? dayWorkouts[0].type : null;
                    
                    let dayClass = 'calendar-day';
                    if (isToday) dayClass += ' today';
                    if (hasWorkout) {
                        dayClass += ' has-training';
                        if (workoutType) dayClass += ' ' + workoutType;
                    }
                    
                    calendarHTML += `
                        <div class="${dayClass}" data-date="${dateStr}">
                            ${day}
                        </div>
                    `;
                }
                
                calendarHTML += '</div>';
                document.getElementById('calendarContainer').innerHTML = calendarHTML;
                
                // Add click handlers
                document.querySelectorAll('.calendar-day[data-date]').forEach(day => {
                    day.addEventListener('click', () => this.showDayDetail(day.dataset.date));
                });
            },
            
            generateCalendarPreview: function() {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
                
                let previewHTML = `
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 1rem;">
                `;
                
                // Day headers
                ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].forEach(day => {
                    previewHTML += `<div style="text-align: center; font-size: 0.75rem; color: var(--text-secondary); padding: 4px;">${day}</div>`;
                });
                
                // Empty cells
                for (let i = 0; i < startDay; i++) {
                    previewHTML += '<div></div>';
                }
                
                // Days
                const todayStr = today.toISOString().split('T')[0];
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateStr = date.toISOString().split('T')[0];
                    const isToday = dateStr === todayStr;
                    
                    // Check for workouts
                    const dayWorkouts = AppState.workouts.filter(w => w.date === dateStr);
                    const hasWorkout = dayWorkouts.length > 0;
                    
                    previewHTML += `
                        <div style="aspect-ratio: 1; display: flex; align-items: center; justify-content: center; 
                                   border-radius: 8px; font-size: 0.875rem; font-weight: 500;
                                   ${isToday ? 'border: 2px solid var(--primary);' : ''}
                                   ${hasWorkout ? 'background: linear-gradient(135deg, var(--calendar-train), transparent);' : ''}">
                            ${day}
                        </div>
                    `;
                }
                
                previewHTML += '</div>';
                document.getElementById('calendarPreview').innerHTML = previewHTML;
            },

            updateTodaysWorkoutCard: function() {
                const container = document.getElementById('todaysWorkout');
                const todayStr = new Date().toISOString().split('T')[0];
                const todayWorkouts = AppState.workouts.filter(w => w.date === todayStr);

                if (AppState.isWorkoutActive && AppState.activeWorkout) {
                    container.innerHTML = `
                        <p class="text-secondary mb-2">Тренировка в процессе</p>
                        <div class="mb-2"><strong>${AppState.activeWorkout.name}</strong></div>
                        <div class="text-sm text-secondary mb-3">${AppState.activeWorkout.exercises.length} упражнений • тип: ${AppState.activeWorkout.type}</div>
                        <button class="btn btn-primary w-full" onclick="UI.switchPage('workoutSession')">
                            <i class="mdi mdi-arrow-right"></i> Перейти к сессии
                        </button>
                    `;
                    return;
                }

                if (todayWorkouts.length > 0) {
                    const last = todayWorkouts[todayWorkouts.length - 1];
                    const totalVolume = last.exercises?.reduce((sum, ex) => sum + ex.sets?.reduce((s, set) => s + ((set.weight || 0) * (set.reps || 0)), 0) || 0, 0) || 0;

                    container.innerHTML = `
                        <p class="text-secondary mb-2">Сегодня уже есть тренировка</p>
                        <div class="mb-1"><strong>${last.name}</strong></div>
                        <div class="text-sm text-secondary mb-2">${last.duration || 0} мин • ${Math.round(totalVolume)} кг объёма</div>
                        <button class="btn btn-secondary w-full" id="startExtraSession">
                            <i class="mdi mdi-repeat"></i> Добавить ещё одну
                        </button>
                    `;

                    const extraBtn = document.getElementById('startExtraSession');
                    extraBtn?.addEventListener('click', () => {
                        const quickTemplate = AITrainer.getQuickWorkoutTemplate();
                        this.startWorkout(quickTemplate.name, quickTemplate.type, null, quickTemplate.exercises);
                    });
                    return;
                }

                container.innerHTML = `
                    <p class="text-secondary mb-2">Нет запланированных тренировок</p>
                    <button class="btn btn-primary w-full" id="startTodayWorkoutBtn">
                        <i class="mdi mdi-play"></i>
                        Начать тренировку
                    </button>
                `;

                document.getElementById('startTodayWorkoutBtn').addEventListener('click', () => {
                    const quickTemplate = AITrainer.getQuickWorkoutTemplate();
                    this.startWorkout(quickTemplate.name, quickTemplate.type, null, quickTemplate.exercises);
                });
            },
            
            showDayDetail: function(dateStr) {
                const date = new Date(dateStr);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('dayDetailTitle').textContent = date.toLocaleDateString('ru-RU', options);
                
                const dayWorkouts = AppState.workouts.filter(w => w.date === dateStr);
                
                let workoutsHTML = '';
                if (dayWorkouts.length === 0) {
                    workoutsHTML = '<p class="text-secondary">Нет тренировок в этот день</p>';
                } else {
                    dayWorkouts.forEach(workout => {
                        const totalVolume = workout.exercises?.reduce((total, exercise) => {
                            return total + exercise.sets?.reduce((sum, set) => {
                                return sum + ((set.weight || 0) * (set.reps || 0));
                            }, 0) || 0;
                        }, 0) || 0;
                        
                        workoutsHTML += `
                            <div class="exercise-item mb-2">
                                <h4 class="mb-1">${workout.name}</h4>
                                <div class="flex justify-between text-sm">
                                    <span class="text-secondary">${workout.type === 'gym' ? 'Зал' : 
                                                                   workout.type === 'home' ? 'Дом' : 
                                                                   workout.type === 'cardio' ? 'Кардио' : 'Восстановление'}</span>
                                    <span class="text-secondary">${workout.duration || 0} мин</span>
                                    <span class="text-secondary">${Math.round(totalVolume)} кг</span>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('dayWorkouts').innerHTML = workoutsHTML;
                document.getElementById('dayDetailModal').classList.add('active');
            },
            
            loadExercises: function(muscleFilter = 'all') {
                AppState.currentMuscleFilter = muscleFilter;
                const exerciseLibrary = document.getElementById('exerciseLibrary');
                const templateExerciseSelect = document.getElementById('templateExerciseSelect');
                
                // Clear existing options
                exerciseLibrary.innerHTML = '';
                templateExerciseSelect.innerHTML = '<option value="">Выберите упражнение</option>';
                
                // Merge default exercises with custom ones
                const allExercises = [...ExerciseLibrary.exercises, ...AppState.exercises];
                
                // Display filtered exercises
                allExercises
                    .filter(exercise => muscleFilter === 'all' || exercise.muscleGroup === muscleFilter)
                    .forEach(exercise => {
                        const exerciseCard = document.createElement('div');
                        exerciseCard.className = 'exercise-card';
                        exerciseCard.innerHTML = `
                            <h4 class="mb-1">${exercise.name}</h4>
                            <div class="mb-1">
                                <span class="muscle-group-badge">${this.getMuscleGroupName(exercise.muscleGroup)}</span>
                            </div>
                            <p class="text-secondary text-sm">${exercise.description.substring(0, 100)}...</p>
                        `;
                        exerciseCard.addEventListener('click', () => this.showExerciseDetail(exercise));
                        exerciseLibrary.appendChild(exerciseCard);

                        // Add to template select
                        const option = document.createElement('option');
                        option.value = exercise.id;
                        option.textContent = exercise.name;
                        templateExerciseSelect.appendChild(option);
                    });

                // Update search filter after rebuild
                const searchTerm = document.getElementById('exerciseSearch').value.toLowerCase();
                if (searchTerm) {
                    document.querySelectorAll('.exercise-card').forEach(card => {
                        const exerciseName = card.querySelector('h4').textContent.toLowerCase();
                        card.style.display = exerciseName.includes(searchTerm) ? 'block' : 'none';
                    });
                }
            },
            
            getMuscleGroupName: function(id) {
                const names = {
                    'chest': 'Грудь',
                    'back': 'Спина',
                    'legs': 'Ноги',
                    'shoulders': 'Плечи',
                    'arms': 'Руки',
                    'core': 'Пресс',
                    'cardio': 'Кардио'
                };
                return names[id] || id;
            },
            
            showExerciseDetail: function(exercise) {
                document.getElementById('exerciseDetailTitle').textContent = exercise.name;

                const modal = document.getElementById('exerciseDetailModal');
                modal.dataset.exerciseId = exercise.id;
                
                let content = `
                    <div class="mb-3">
                        <span class="muscle-group-badge">${this.getMuscleGroupName(exercise.muscleGroup)}</span>
                    </div>
                    <p class="mb-3">${exercise.description}</p>
                `;
                
                if (exercise.secondaryMuscles?.length > 0) {
                    content += `<p class="mb-2"><strong>Дополнительные мышцы:</strong> ${exercise.secondaryMuscles.map(m => this.getMuscleGroupName(m)).join(', ')}</p>`;
                }
                
                content += `<p class="mb-3"><strong>Оборудование:</strong> ${exercise.equipment === 'barbell' ? 'Штанга' : 
                                                                           exercise.equipment === 'dumbbell' ? 'Гантели' : 
                                                                           exercise.equipment === 'bodyweight' ? 'Собственный вес' : 
                                                                           exercise.equipment === 'machine' ? 'Тренажёр' : 
                                                                           exercise.equipment === 'cable' ? 'Тросы' : 'Кардио'}</p>`;
                
                document.getElementById('exerciseDetailContent').innerHTML = content;
                modal.classList.add('active');
            },
            
            loadTemplates: function() {
                const templatesList = document.getElementById('templatesList');
                const workoutTemplateSelect = document.getElementById('workoutTemplate');
                
                templatesList.innerHTML = '';
                
                // Clear and add default option
                workoutTemplateSelect.innerHTML = '<option value="">Без шаблона</option>';
                
                if (AppState.templates.length === 0) {
                    templatesList.innerHTML = '<p class="text-secondary">Шаблонов пока нет. Создайте первый!</p>';
                } else {
                    AppState.templates.forEach(template => {
                        // Add to templates list
                        const templateDiv = document.createElement('div');
                        templateDiv.className = 'exercise-item';
                        templateDiv.style.cursor = 'pointer';
                        templateDiv.innerHTML = `
                            <div class="flex justify-between items-center mb-1">
                                <h4>${template.name}</h4>
                                <span class="text-secondary text-sm">${template.exercises?.length || 0} упражнений</span>
                            </div>
                            <p class="text-secondary text-sm mb-2">${template.description || ''}</p>
                            <div class="flex gap-2">
                                <button class="btn btn-small btn-secondary use-template-btn" data-id="${template.id}">
                                    <i class="mdi mdi-play"></i> Использовать
                                </button>
                                <button class="btn btn-small btn-danger delete-template-btn" data-id="${template.id}">
                                    <i class="mdi mdi-delete"></i>
                                </button>
                            </div>
                        `;
                        templatesList.appendChild(templateDiv);
                        
                        // Add to workout template select
                        const option = document.createElement('option');
                        option.value = template.id;
                        option.textContent = template.name;
                        workoutTemplateSelect.appendChild(option);
                    });
                }
            },
            
            updateStats: function() {
                const stats = DataStorage.calculateStats();
                
                // Update dashboard stats
                document.getElementById('weeklyWorkouts').textContent = Math.floor(stats.consistency) || 0;
                document.getElementById('weeklyVolume').textContent = Math.round(stats.totalVolume / 1000) || 0;
                document.getElementById('weeklyTime').textContent = Math.round(stats.totalTime / 60) || 0;
                
                // Update stats page
                document.getElementById('totalWorkouts').textContent = stats.totalWorkouts;
                document.getElementById('totalVolume').textContent = Math.round(stats.totalVolume);
                document.getElementById('avgWorkoutTime').textContent = stats.totalWorkouts > 0 ? 
                    Math.round(stats.totalTime / stats.totalWorkouts) : 0;
                document.getElementById('consistency').textContent = stats.consistency.toFixed(1) + '%';
                
                // Update recent workouts
                this.updateRecentWorkouts();
                
                // Update charts
                this.updateProgressChart();
            },
            
            updateRecentWorkouts: function() {
                const recentWorkoutsDiv = document.getElementById('recentWorkouts');
                const recentWorkouts = AppState.workouts.slice(-5).reverse();
                
                if (recentWorkouts.length === 0) {
                    recentWorkoutsDiv.innerHTML = '<p class="text-secondary">Пока нет завершённых тренировок</p>';
                    return;
                }
                
                let html = '';
                recentWorkouts.forEach(workout => {
                    const totalVolume = workout.exercises?.reduce((total, exercise) => {
                        return total + exercise.sets?.reduce((sum, set) => {
                            return sum + ((set.weight || 0) * (set.reps || 0));
                        }, 0) || 0;
                    }, 0) || 0;
                    
                    html += `
                        <div class="exercise-item mb-2">
                            <div class="flex justify-between items-center mb-1">
                                <h4>${workout.name}</h4>
                                <span class="text-secondary text-sm">${new Date(workout.date).toLocaleDateString('ru-RU')}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-secondary">${workout.duration || 0} мин</span>
                                <span class="text-secondary">${Math.round(totalVolume)} кг</span>
                                <span class="text-secondary">${workout.exercises?.length || 0} упр.</span>
                            </div>
                        </div>
                    `;
                });
                
                recentWorkoutsDiv.innerHTML = html;
            },
            
            updateProgressChart: function() {
                const ctx = document.getElementById('progressChart').getContext('2d');
                
                // Group workouts by week
                const weeklyData = {};
                AppState.workouts.forEach(workout => {
                    const date = new Date(workout.date);
                    const week = `${date.getFullYear()}-W${Math.floor(date.getDate() / 7)}`;
                    
                    if (!weeklyData[week]) {
                        weeklyData[week] = { volume: 0, workouts: 0 };
                    }
                    
                    const workoutVolume = workout.exercises?.reduce((total, exercise) => {
                        return total + exercise.sets?.reduce((sum, set) => {
                            return sum + ((set.weight || 0) * (set.reps || 0));
                        }, 0) || 0;
                    }, 0) || 0;
                    
                    weeklyData[week].volume += workoutVolume;
                    weeklyData[week].workouts += 1;
                });
                
                const weeks = Object.keys(weeklyData).sort();
                const volumes = weeks.map(week => weeklyData[week].volume);
                
                if (window.progressChart) {
                    window.progressChart.destroy();
                }
                
                if (weeks.length === 0) {
                    document.getElementById('progressChart').style.display = 'none';
                    return;
                }
                
                document.getElementById('progressChart').style.display = 'block';
                
                window.progressChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: weeks.map(w => `Неделя ${w.split('-W')[1]}`),
                        datasets: [{
                            label: 'Объём нагрузки (кг)',
                            data: volumes,
                            borderColor: 'var(--primary)',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'var(--text-primary)'
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'var(--border)'
                                },
                                ticks: {
                                    color: 'var(--text-secondary)'
                                }
                            },
                            y: {
                                grid: {
                                    color: 'var(--border)'
                                },
                                ticks: {
                                    color: 'var(--text-secondary)'
                                }
                            }
                        }
                    }
                });
            },
            
            updateAIRecommendation: function() {
                const recommendation = AITrainer.getRecommendation();
                document.getElementById('aiRecommendation').textContent = recommendation;
                document.getElementById('aiMainRecommendation').textContent = recommendation;

                const insights = AITrainer.getProgressInsights();
                document.getElementById('progressRecommendations').innerHTML = insights
                    .map(text => `<div class="ai-message">${text}</div>`)
                    .join('');

                this.renderWeeklyPlan(AITrainer.generateWeeklyPlan());
            },

            renderAiChat: function() {
                const chat = document.getElementById('aiChat');
                chat.innerHTML = '<div class="ai-message-bubble">Привет! Я ваш AI-тренер. Спросите меня о тренировках, технике упражнений или получите рекомендации по прогрессу.</div>';

                AppState.aiMessages.forEach(msg => {
                    const bubble = document.createElement('div');
                    bubble.className = `ai-message-bubble ${msg.role === 'user' ? 'user' : ''}`;
                    bubble.textContent = msg.text;
                    chat.appendChild(bubble);
                });

                chat.scrollTop = chat.scrollHeight;
            },

            renderWeeklyPlan: function(plan) {
                let planHTML = '<div class="space-y-3">';

                Object.entries(plan).forEach(([day, data]) => {
                    const dayName = {
                        monday: 'Понедельник',
                        tuesday: 'Вторник',
                        wednesday: 'Среда',
                        thursday: 'Четверг',
                        friday: 'Пятница',
                        saturday: 'Суббота',
                        sunday: 'Воскресенье'
                    }[day];

                    planHTML += `
                        <div class="exercise-item">
                            <h5 class="font-semibold mb-1">${dayName}: ${data.muscleGroup}</h5>
                            ${data.exercises.length > 0 ?
                                `<ul class="text-sm text-secondary pl-4">
                                    ${data.exercises.map(ex => `<li>• ${ex}</li>`).join('')}
                                </ul>` :
                                '<p class="text-sm text-secondary">День отдыха</p>'}
                        </div>
                    `;
                });

                planHTML += '</div>';
                document.getElementById('weeklyPlan').innerHTML = planHTML;
            },
            
            // ==================== WORKOUT FUNCTIONS ==================== 
            startWorkout: function(name, type, templateId, preloadedExercises = []) {
                AppState.activeWorkout = {
                    id: Date.now(),
                    name: name || 'Новая тренировка',
                    type: type || 'gym',
                    date: new Date().toISOString().split('T')[0],
                    startTime: Date.now(),
                    duration: 0,
                    exercises: [],
                    notes: ''
                };

                // Use AI quick template if provided
                if (preloadedExercises.length > 0) {
                    AppState.activeWorkout.exercises = JSON.parse(JSON.stringify(preloadedExercises));
                }
                
                // Load template if selected
                else if (templateId) {
                    const template = AppState.templates.find(t => t.id === templateId);
                    if (template) {
                        AppState.activeWorkout.exercises = JSON.parse(JSON.stringify(template.exercises || []));
                        AppState.activeWorkout.exercises.forEach(exercise => {
                            exercise.sets = exercise.sets || [];
                        });
                    }
                }
                
                AppState.isWorkoutActive = true;
                document.getElementById('workoutTitle').textContent = AppState.activeWorkout.name;
                document.getElementById('workoutSession').classList.remove('hidden');
                document.getElementById('dashboardPage').classList.add('hidden');
                
                // Start timer
                this.startWorkoutTimer();
                this.updateActiveExercises();
                this.updateTodaysWorkoutCard();
                
                DataStorage.showToast('Тренировка начата', 'success');
            },

            resetTemplateBuilder: function(initialExercises = []) {
                AppState.templateBuilderExercises = JSON.parse(JSON.stringify(initialExercises));
                this.renderTemplateExercises();
            },

            renderTemplateExercises: function() {
                const list = document.getElementById('templateExercisesList');
                list.innerHTML = '';

                if (!AppState.templateBuilderExercises.length) {
                    list.innerHTML = '<p class="text-secondary">Добавьте упражнения в шаблон</p>';
                    return;
                }

                AppState.templateBuilderExercises.forEach((exercise, index) => {
                    const exerciseDiv = document.createElement('div');
                    exerciseDiv.className = 'exercise-item mb-2';
                    exerciseDiv.innerHTML = `
                        <div class="flex justify-between">
                            <span>${exercise.name}</span>
                            <div class="flex gap-1">
                                <span class="text-secondary text-sm">${exercise.sets?.length || 0} подходов</span>
                                <button class="btn btn-small btn-danger" data-remove-template-exercise="${index}">
                                    <i class="mdi mdi-delete"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    exerciseDiv.querySelector('[data-remove-template-exercise]').addEventListener('click', () => {
                        AppState.templateBuilderExercises.splice(index, 1);
                        this.renderTemplateExercises();
                    });
                    list.appendChild(exerciseDiv);
                });
            },
            
            updateActiveExercises: function() {
                const container = document.getElementById('activeExercises');
                if (!AppState.activeWorkout || !AppState.activeWorkout.exercises) {
                    container.innerHTML = '<p class="text-secondary">Добавьте упражнения</p>';
                    return;
                }
                
                let html = '';
                AppState.activeWorkout.exercises.forEach((exercise, index) => {
                    const sets = exercise.sets || [];
                    const completedSets = sets.filter(s => s.completed).length;
                    const totalSets = exercise.targetSets || sets.length;
                    
                    html += `
                        <div class="exercise-item">
                            <div class="flex justify-between items-center mb-2">
                                <h4>${exercise.name}</h4>
                                <span class="text-secondary">${completedSets}/${totalSets} подходов</span>
                            </div>
                            
                            <div class="sets-grid">
                                ${sets.map((set, setIndex) => `
                                    <div class="set-item ${set.completed ? 'active' : ''}" 
                                         data-exercise="${index}" 
                                         data-set="${setIndex}"
                                         style="cursor: pointer;">
                                        ${set.completed ? 
                                            `${set.weight || 0}${AppState.settings.weightUnit} × ${set.reps || 0}` :
                                            'Добавить подход'}
                                    </div>
                                `).join('')}
                                
                                <div class="set-item" style="cursor: pointer; border-style: dashed;"
                                     onclick="UI.addSet(${index})">
                                    <i class="mdi mdi-plus"></i>
                                </div>
                            </div>
                            
                            <div class="flex gap-2 mt-2">
                                <button class="btn btn-small btn-secondary" onclick="UI.startRestTimer(${index})">
                                    <i class="mdi mdi-timer"></i> Таймер отдыха
                                </button>
                                <button class="btn btn-small btn-danger" onclick="UI.removeExercise(${index})">
                                    <i class="mdi mdi-delete"></i> Удалить
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html || '<p class="text-secondary">Добавьте упражнения</p>';
                
                // Add click handlers for sets
                container.querySelectorAll('.set-item[data-exercise]').forEach(item => {
                    item.addEventListener('click', function() {
                        const exerciseIndex = parseInt(this.dataset.exercise);
                        const setIndex = parseInt(this.dataset.set);
                        UI.editSet(exerciseIndex, setIndex);
                    });
                });
            },
            
            addExerciseToWorkout: function(exercise) {
                if (!AppState.activeWorkout) return;
                
                AppState.activeWorkout.exercises.push({
                    name: exercise.name,
                    muscleGroup: exercise.muscleGroup,
                    targetSets: 3,
                    sets: []
                });
                
                this.updateActiveExercises();
                DataStorage.showToast('Упражнение добавлено', 'success');
            },

        removeExercise: function(exerciseIndex) {
                if (!AppState.activeWorkout) {
                    DataStorage.showToast('Нет активной тренировки', 'error');
                    return;
                }

                AppState.activeWorkout.exercises.splice(exerciseIndex, 1);
                this.updateActiveExercises();
                this.updateTodaysWorkoutCard();
                DataStorage.save();
                DataStorage.showToast('Упражнение удалено', 'success');
            },
        
            addSet: function(exerciseIndex) {
                AppState.activeExercise = exerciseIndex;
                AppState.activeSetIndex = AppState.activeWorkout.exercises[exerciseIndex].sets.length;
                
                document.getElementById('setDetailTitle').textContent = 
                    `Подход ${AppState.activeSetIndex + 1} - ${AppState.activeWorkout.exercises[exerciseIndex].name}`;
                document.getElementById('setWeight').value = '';
                document.getElementById('setReps').value = '10';
                document.getElementById('setRest').value = AppState.defaultRestTime;
                document.getElementById('setDetailModal').classList.add('active');
            },
            
            editSet: function(exerciseIndex, setIndex) {
                AppState.activeExercise = exerciseIndex;
                AppState.activeSetIndex = setIndex;
                
                const exercise = AppState.activeWorkout.exercises[exerciseIndex];
                const set = exercise.sets[setIndex];
                
                document.getElementById('setDetailTitle').textContent = 
                    `Подход ${setIndex + 1} - ${exercise.name}`;
                document.getElementById('setWeight').value = set.weight || '';
                document.getElementById('setReps').value = set.reps || '';
                document.getElementById('setRest').value = set.restTime || AppState.defaultRestTime;
                document.getElementById('setDetailModal').classList.add('active');
            },
            
            saveSet: function() {
                if (!AppState.activeWorkout || AppState.activeExercise === null) return;
                
                const weight = parseFloat(document.getElementById('setWeight').value) || 0;
                const reps = parseInt(document.getElementById('setReps').value) || 0;
                const restTime = parseInt(document.getElementById('setRest').value) || AppState.defaultRestTime;
                
                const exercise = AppState.activeWorkout.exercises[AppState.activeExercise];
                
                if (!exercise.sets[AppState.activeSetIndex]) {
                    exercise.sets[AppState.activeSetIndex] = {};
                }
                
                exercise.sets[AppState.activeSetIndex] = {
                    weight: weight,
                    reps: reps,
                    restTime: restTime,
                    completed: true,
                    timestamp: Date.now()
                };
                
                this.updateActiveExercises();
                document.getElementById('setDetailModal').classList.remove('active');
                
                // Start rest timer if this isn't the last set
                const totalSets = exercise.targetSets || 4;
                if (exercise.sets.length < totalSets) {
                    this.startRestTimer(AppState.activeExercise, restTime);
                }
            },
            
            startRestTimer: function(exerciseIndex, duration = null) {
                if (!duration) {
                    const exercise = AppState.activeWorkout.exercises[exerciseIndex];
                    const lastSet = exercise.sets[exercise.sets.length - 1];
                    duration = lastSet?.restTime || AppState.defaultRestTime;
                }
                
                AppState.restSeconds = duration;
                AppState.isRestTimerActive = true;
                
                const timerDisplay = document.getElementById('restTimerDisplay');
                const restTimer = document.getElementById('restTimer');
                
                restTimer.classList.add('active');
                
                AppState.restTimer = setInterval(() => {
                    AppState.restSeconds--;
                    
                    const minutes = Math.floor(AppState.restSeconds / 60);
                    const seconds = AppState.restSeconds % 60;
                    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (AppState.restSeconds <= 0) {
                        this.stopRestTimer();
                        DataStorage.showToast('Время отдыха окончено!', 'success');
                    }
                }, 1000);
            },
            
            stopRestTimer: function() {
                clearInterval(AppState.restTimer);
                AppState.isRestTimerActive = false;
                document.getElementById('restTimer').classList.remove('active');
            },
            
            startWorkoutTimer: function() {
                AppState.workoutSeconds = 0;
                clearInterval(AppState.workoutTimer);
                
                AppState.workoutTimer = setInterval(() => {
                    AppState.workoutSeconds++;
                    
                    const minutes = Math.floor(AppState.workoutSeconds / 60);
                    const seconds = AppState.workoutSeconds % 60;
                    document.getElementById('workoutTimer').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            },
            
            stopWorkoutTimer: function() {
                clearInterval(AppState.workoutTimer);
                AppState.workoutTimer = null;
            },
            
            completeWorkout: function() {
                if (!AppState.activeWorkout) {
                    DataStorage.showToast('Нет активной тренировки для завершения', 'error');
                    return;
                }
                
                AppState.activeWorkout.duration = Math.floor(AppState.workoutSeconds / 60);
                AppState.activeWorkout.endTime = Date.now();
                AppState.workouts.push(AppState.activeWorkout);
                
                AppState.isWorkoutActive = false;
                this.stopWorkoutTimer();
                this.stopRestTimer();
                
                DataStorage.save();
                this.updateStats();
                this.updateAIRecommendation();
                this.generateCalendar();
                this.generateCalendarPreview();
                this.updateTodaysWorkoutCard();
                
                document.getElementById('workoutSession').classList.add('hidden');
                document.getElementById('dashboardPage').classList.remove('hidden');
                
                DataStorage.showToast('Тренировка завершена!', 'success');
                
                // Ask to save as template
                if (confirm('Сохранить эту тренировку как шаблон?')) {
                    this.showSaveTemplateModal();
                }
            },
            
            showSaveTemplateModal: function() {
                const workout = AppState.activeWorkout || { name: 'Новый шаблон', exercises: [] };
                document.getElementById('templateName').value = (workout.name || 'Новый шаблон') + ' (шаблон)';
                document.getElementById('templateDescription').value = '';
                
                this.resetTemplateBuilder(workout.exercises || []); 
                document.getElementById('createTemplateModal').classList.add('active');
            },
            
            saveTemplate: function() {
                const name = document.getElementById('templateName').value.trim();
                const description = document.getElementById('templateDescription').value.trim();
                
                if (!name) {
                    DataStorage.showToast('Введите название шаблона', 'error');
                    return;
                }

                 if (AppState.templateBuilderExercises.length === 0) {
                    DataStorage.showToast('Добавьте хотя бы одно упражнение', 'error');
                    return;
                }
                
                const template = {
                    id: Date.now().toString(),
                    name: name,
                    description: description,
                    exercises: JSON.parse(JSON.stringify(AppState.templateBuilderExercises)),
                    created: new Date().toISOString()
                };
                
                AppState.templates.push(template);
                DataStorage.save();
                this.loadTemplates();

                this.resetTemplateBuilder();
                
                document.getElementById('createTemplateModal').classList.remove('active');
                DataStorage.showToast('Шаблон сохранён', 'success');
            },
            
            // ==================== EVENT LISTENERS ====================
            setupEventListeners: function() {
                // Theme toggles
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.setTheme(btn.dataset.theme);
                    });
                });

                const sidebar = document.getElementById('sidebar');
                const sidebarOverlay = document.getElementById('sidebarOverlay');
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');

                const toggleSidebar = (isOpen) => {
                    sidebar.classList.toggle('active', isOpen);
                    sidebarOverlay.classList.toggle('active', isOpen);
                    sidebarOverlay.classList.toggle('hidden', !isOpen);
                };
                
                // Navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.switchPage(item.dataset.page + 'Page');
                        
                        if (window.innerWidth <= 1024) {
                            toggleSidebar(false);
                        }
                    });
                });
                
                // Calendar navigation
                document.getElementById('prevMonth').addEventListener('click', () => {
                    AppState.currentMonth--;
                    if (AppState.currentMonth < 0) {
                        AppState.currentMonth = 11;
                        AppState.currentYear--;
                    }
                    this.generateCalendar();
                });
                
                document.getElementById('nextMonth').addEventListener('click', () => {
                    AppState.currentMonth++;
                    if (AppState.currentMonth > 11) {
                        AppState.currentMonth = 0;
                        AppState.currentYear++;
                    }
                    this.generateCalendar();
                });
                
                document.getElementById('todayBtn').addEventListener('click', () => {
                    const now = new Date();
                    AppState.currentMonth = now.getMonth();
                    AppState.currentYear = now.getFullYear();
                    this.generateCalendar();
                });
                
                // New workout
                document.getElementById('newWorkoutBtn').addEventListener('click', () => {
                    document.getElementById('newWorkoutModal').classList.add('active');
                });
                
                document.getElementById('quickWorkoutBtn').addEventListener('click', () => {
                    const quickTemplate = AITrainer.getQuickWorkoutTemplate();
                    this.startWorkout(quickTemplate.name, quickTemplate.type, null, quickTemplate.exercises);
                });
                
                document.getElementById('startWorkoutBtn').addEventListener('click', () => {
                    const name = document.getElementById('workoutName').value || 'Новая тренировка';
                    const type = document.getElementById('workoutType').value;
                    const templateId = document.getElementById('workoutTemplate').value;
                    
                    this.startWorkout(name, type, templateId);
                    document.getElementById('newWorkoutModal').classList.remove('active');
                });
                
                document.getElementById('cancelWorkoutBtn').addEventListener('click', () => {
                    document.getElementById('newWorkoutModal').classList.remove('active');
                });
                
                // Workout controls
                document.getElementById('endWorkoutBtn').addEventListener('click', () => {
                    if (confirm('Завершить тренировку?')) {
                        this.completeWorkout();
                    }
                });
                
                document.getElementById('completeWorkoutBtn').addEventListener('click', () => {
                    this.completeWorkout();
                });
                
                document.getElementById('pauseWorkoutBtn').addEventListener('click', () => {
                    if (AppState.workoutTimer) {
                        clearInterval(AppState.workoutTimer);
                        AppState.workoutTimer = null;
                        DataStorage.showToast('Тренировка на паузе', 'info');
                    } else {
                        this.startWorkoutTimer();
                        DataStorage.showToast('Тренировка продолжена', 'success');
                    }
                });
                
                // Rest timer
                document.getElementById('skipRestBtn').addEventListener('click', () => {
                    this.stopRestTimer();
                });
                
                document.getElementById('startNextSetBtn').addEventListener('click', () => {
                    this.stopRestTimer();
                });
                
                // Add exercise to workout
                document.getElementById('addExerciseToWorkoutBtn').addEventListener('click', () => {
                    // Show exercise library
                    this.switchPage('exercisesPage');
                });
                
                document.getElementById('addExerciseToCurrentBtn').addEventListener('click', () => {
                    const modal = document.getElementById('exerciseDetailModal');
                    const exerciseId = modal.dataset.exerciseId;
                    
                    // Find exercise
                    const exercise = [...ExerciseLibrary.exercises, ...AppState.exercises]
                        .find(e => e.id === exerciseId);
                    
                    if (exercise) {
                        this.addExerciseToWorkout(exercise);
                        modal.classList.remove('active');
                        this.switchPage('workoutSession');
                    }
                });
                
                // Set modal
                document.getElementById('saveSetBtn').addEventListener('click', () => {
                    this.saveSet();
                });
                
                document.getElementById('cancelSetBtn').addEventListener('click', () => {
                    document.getElementById('setDetailModal').classList.remove('active');
                });
                
                // Template modal
                document.getElementById('saveTemplateBtn').addEventListener('click', () => {
                    this.saveTemplate();
                });
                
                document.getElementById('cancelTemplateBtn').addEventListener('click', () => {
                    document.getElementById('createTemplateModal').classList.remove('active');
                });
                
                // Create template button
                document.getElementById('createTemplateBtn').addEventListener('click', () => {
                    document.getElementById('templateName').value = '';
                    document.getElementById('templateDescription').value = '';
                    this.resetTemplateBuilder();
                    document.getElementById('createTemplateModal').classList.add('active');
                });
                
                // Add exercise to template
                document.getElementById('addExerciseToTemplateBtn').addEventListener('click', () => {
                    const select = document.getElementById('templateExerciseSelect');
                    const exerciseId = select.value;
                    
                    if (!exerciseId) return;
                    
                    const exercise = [...ExerciseLibrary.exercises, ...AppState.exercises]
                        .find(e => e.id === exerciseId);
                    
                    if (exercise) {
                        const exerciseCopy = JSON.parse(JSON.stringify(exercise));
                        exerciseCopy.sets = exerciseCopy.sets || [];
                        AppState.templateBuilderExercises.push(exerciseCopy);
                        this.renderTemplateExercises();
                    }
                });

                // Custom exercise modal
                document.getElementById('addCustomExerciseBtn').addEventListener('click', () => {
                    document.getElementById('customExerciseName').value = '';
                    document.getElementById('customExerciseDescription').value = '';
                    document.getElementById('customExerciseMuscle').value = 'core';
                    document.getElementById('customExerciseEquipment').value = 'bodyweight';
                    document.getElementById('customExerciseModal').classList.add('active');
                });

                document.getElementById('cancelCustomExerciseBtn').addEventListener('click', () => {
                    document.getElementById('customExerciseModal').classList.remove('active');
                });

                document.getElementById('saveCustomExerciseBtn').addEventListener('click', () => {
                    const name = document.getElementById('customExerciseName').value.trim();
                    const description = document.getElementById('customExerciseDescription').value.trim();
                    const muscleGroup = document.getElementById('customExerciseMuscle').value;
                    const equipment = document.getElementById('customExerciseEquipment').value;

                    if (!name || !description) {
                        DataStorage.showToast('Заполните название и описание упражнения', 'error');
                        return;
                    }

                    const newExercise = {
                        id: 'custom-' + Date.now(),
                        name,
                        description,
                        muscleGroup,
                        secondaryMuscles: [],
                        equipment,
                        image: null,
                        sets: []
                    };

                    AppState.exercises.push(newExercise);
                    DataStorage.save();
                    this.loadExercises(AppState.currentMuscleFilter);
                    document.getElementById('customExerciseModal').classList.remove('active');
                    DataStorage.showToast('Упражнение добавлено в библиотеку', 'success');
                
                });
                
                // Tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const parent = tab.parentElement;
                        
                        // Update active tab
                        parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Show/hide content
                        if (tab.dataset.tab) {
                            document.getElementById('templatesList').classList.toggle('hidden', tab.dataset.tab !== 'templates');
                            document.getElementById('workoutsHistory').classList.toggle('hidden', tab.dataset.tab !== 'history');
                            document.getElementById('workoutPlans').classList.toggle('hidden', tab.dataset.tab !== 'plans');
                        }
                        
                        if (tab.dataset.stat) {
                            document.getElementById('statsOverview').classList.toggle('hidden', tab.dataset.stat !== 'overview');
                            document.getElementById('statsExercises').classList.toggle('hidden', tab.dataset.stat !== 'exercises');
                            document.getElementById('statsMuscles').classList.toggle('hidden', tab.dataset.stat !== 'muscles');
                            document.getElementById('statsVolume').classList.toggle('hidden', tab.dataset.stat !== 'volume');
                        }

                        if (tab.dataset.muscle) {
                            this.loadExercises(tab.dataset.muscle);
                        } 
                    });
                });
                
                // Exercise search
                document.getElementById('exerciseSearch').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    document.querySelectorAll('.exercise-card').forEach(card => {
                        const exerciseName = card.querySelector('h4').textContent.toLowerCase();
                        card.style.display = exerciseName.includes(searchTerm) ? 'block' : 'none';
                    });
                });
                
                // AI Chat
                document.getElementById('sendAiMessageBtn').addEventListener('click', () => {
                    const input = document.getElementById('aiChatInput');
                    const message = input.value.trim();
                    
                    if (!message) return;
                    
                    const saveMessage = (role, text) => {
                        AppState.aiMessages.push({ role, text });
                        localStorage.setItem('aiMessages', JSON.stringify(AppState.aiMessages));
                    };

                    saveMessage('user', message);
                    this.renderAiChat();
                    
                    // Get AI response
                    setTimeout(() => {
                        const response = AITrainer.chatResponse(message);
                        saveMessage('ai', response);
                        this.renderAiChat();
                    }, 400);
                    
                    input.value = '';
                });
                
                document.getElementById('aiChatInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('sendAiMessageBtn').click();
                    }
                });
                
                document.getElementById('aiChatBtn').addEventListener('click', () => {
                    this.switchPage('aiTrainerPage');
                });
                
                // Generate AI plan
                document.getElementById('generatePlanBtn').addEventListener('click', () => {
                    const plan = AITrainer.generateWeeklyPlan();
                    this.renderWeeklyPlan(plan);
                    
                    DataStorage.showToast('План на неделю создан AI', 'success');
                });
                
                // Settings
                document.getElementById('weightUnit').addEventListener('change', (e) => {
                    AppState.settings.weightUnit = e.target.value;
                    DataStorage.save();
                    DataStorage.showToast('Настройки сохранены', 'success');
                });
                
                document.getElementById('restTimerDefault').addEventListener('change', (e) => {
                    AppState.defaultRestTime = parseInt(e.target.value);
                    localStorage.setItem('restTimerDefault', e.target.value);
                });
                
                document.getElementById('exportDataBtn').addEventListener('click', () => {
                    DataStorage.exportJSON();
                });
                
                document.getElementById('exportCSVBtn').addEventListener('click', () => {
                    DataStorage.exportCSV();
                });
                
                document.getElementById('importDataInput').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        DataStorage.importData(e.target.files[0]);
                    }
                });
                
                document.getElementById('resetDataBtn').addEventListener('click', () => {
                    DataStorage.resetData();
                });
                
                // Mobile menu
                mobileMenuBtn.addEventListener('click', () => {
                    toggleSidebar(!sidebar.classList.contains('active'));
                });

                sidebarOverlay.addEventListener('click', () => toggleSidebar(false));

                document.addEventListener('click', (e) => {
                    const isClickOutside = !sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target);
                    if (window.innerWidth <= 1024 && sidebar.classList.contains('active') && isClickOutside) {
                        toggleSidebar(false);
                    }
                });
                
                // Modal close on outside click
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });
                
                // Window resize
                window.addEventListener('resize', () => {
                    if (window.innerWidth > 1024) {
                        toggleSidebar(false);
                        document.getElementById('mobileMenuBtn').classList.add('hidden');
                    } else {
                        document.getElementById('mobileMenuBtn').classList.remove('hidden');
                    }
                });
                
                // Show mobile menu button on small screens
                if (window.innerWidth <= 1024) {
                    document.getElementById('mobileMenuBtn').classList.remove('hidden');
                }
            },
            
            switchPage: function(pageId) {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.add('hidden');
                });
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                document.getElementById(pageId).classList.remove('hidden');
                const pageName = pageId.replace('Page', '');
                document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
                
                // Update page-specific content
                if (pageId === 'calendarPage') {
                    this.generateCalendar();
                }
                if (pageId === 'exercisesPage') {
                    this.loadExercises();
                }
                if (pageId === 'workoutsPage') {
                    this.loadTemplates();
                }
                if (pageId === 'statsPage') {
                    this.updateStats();
                }
            },
            
            setupServiceWorker: function() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('Service Worker зарегистрирован:', registration);
                        })
                        .catch(error => {
                            console.log('Ошибка регистрации Service Worker:', error);
                        });
                }
            }
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            UI.init();
            
            // Load settings
            const settings = AppState.settings;
            document.getElementById('weightUnit').value = settings.weightUnit;
            document.getElementById('weightUnitLabel').textContent = settings.weightUnit;
            document.getElementById('notificationsEnabled').checked = settings.notifications;
            document.getElementById('reminderEnabled').checked = settings.reminders;
            document.getElementById('autoSave').checked = settings.autoSave;
            
            // View calendar from dashboard
            document.getElementById('viewCalendarBtn').addEventListener('click', () => {
                UI.switchPage('calendarPage');
            });
            
            // View all workouts
            document.getElementById('viewAllWorkoutsBtn').addEventListener('click', () => {
                UI.switchPage('workoutsPage');
                document.querySelector('[data-tab="history"]').click();
            });
            
            // Add workout to day
            document.getElementById('addWorkoutToDayBtn').addEventListener('click', () => {
                document.getElementById('dayDetailModal').classList.remove('active');
                document.getElementById('newWorkoutModal').classList.add('active');
            });
            
            // Add to calendar button
            document.getElementById('addToCalendarBtn').addEventListener('click', () => {
                document.getElementById('newWorkoutModal').classList.add('active');
            });
            
            // Close exercise detail
            document.getElementById('closeExerciseDetailBtn').addEventListener('click', () => {
                document.getElementById('exerciseDetailModal').classList.remove('active');
            });
            
            // Template button events (delegated)
            document.addEventListener('click', (e) => {
                // Use template button
                if (e.target.closest('.use-template-btn')) {
                    const templateId = e.target.closest('.use-template-btn').dataset.id;
                    const template = AppState.templates.find(t => t.id === templateId);
                    if (template) {
                        UI.startWorkout(template.name, 'gym', templateId);
                    }
                }
                
                // Delete template button
                if (e.target.closest('.delete-template-btn')) {
                    const templateId = e.target.closest('.delete-template-btn').dataset.id;
                    if (confirm('Удалить этот шаблон?')) {
                        AppState.templates = AppState.templates.filter(t => t.id !== templateId);
                        DataStorage.save();
                        UI.loadTemplates();
                        DataStorage.showToast('Шаблон удалён', 'success');
                    }
                }
            });
            
            // Prevent form submission
            document.addEventListener('submit', (e) => {
                e.preventDefault();
            });
            
            // Initialize with zero stats
            DataStorage.calculateStats();
        });

        // ==================== GLOBAL FUNCTIONS ====================
        window.UI = UI;
        window.DataStorage = DataStorage;
        window.AppState = AppState;
    </script>
</body>
</html>
